import _objectWithoutProperties from"@babel/runtime/helpers/esm/objectWithoutProperties";import _extends from"@babel/runtime/helpers/esm/extends";import*as React from"react";import PropTypes from"prop-types";import{elementTypeAcceptingRef}from"@material-ui/utils";import{getThemeProps}from"@material-ui/styles";import Drawer,{getAnchor,isHorizontal}from"../Drawer/Drawer";import ownerDocument from"../utils/ownerDocument";import ownerWindow from"../utils/ownerWindow";import useEventCallback from"../utils/useEventCallback";import useEnhancedEffect from"../utils/useEnhancedEffect";import{duration}from"../styles/transitions";import useTheme from"../styles/useTheme";import{getTransitionProps}from"../transitions/utils";import NoSsr from"../NoSsr";import SwipeArea from"./SwipeArea";var UNCERTAINTY_THRESHOLD=3,nodeThatClaimedTheSwipe=null;export function reset(){nodeThatClaimedTheSwipe=null};function calculateCurrentX(e,r,t){return"right"===e?t.body.offsetWidth-r[0].pageX:r[0].pageX}function calculateCurrentY(e,r,t){return"bottom"===e?t.innerHeight-r[0].clientY:r[0].clientY}function getMaxTranslate(e,r){return e?r.clientWidth:r.clientHeight}function getTranslate(e,r,t,n){return Math.min(Math.max(t?r-e:n+r-e,0),n)}function getDomTreeShapes(e,r){for(var t=[];e&&e!==r.parentElement;){var n=ownerWindow(r).getComputedStyle(e);"absolute"===n.getPropertyValue("position")||"hidden"===n.getPropertyValue("overflow-x")?t=[]:(e.clientWidth>0&&e.scrollWidth>e.clientWidth||e.clientHeight>0&&e.scrollHeight>e.clientHeight)&&t.push(e),e=e.parentElement}return t}function findNativeHandler(e){var r=e.domTreeShapes,t=e.start,n=e.current,a=e.anchor,o={x:"scrollLeft",y:"scrollTop"},i={x:"scrollWidth",y:"scrollHeight"},s={x:"clientWidth",y:"clientHeight"};return r.some(function(e){var r=n>=t;"top"!==a&&"left"!==a||(r=!r);var c="left"===a||"right"===a?"x":"y",u=e[o[c]],l=u>0,p=u+e[s[c]]<e[i[c]];return r&&p||!r&&l?e:null})}var iOS="undefined"!=typeof navigator&&/iPad|iPhone|iPod/.test(navigator.userAgent),transitionDurationDefault={enter:duration.enteringScreen,exit:duration.leavingScreen},SwipeableDrawer=React.forwardRef(function(e,r){var t=useTheme(),n=getThemeProps({name:"MuiSwipeableDrawer",props:_extends({},e),theme:t}),a=n.anchor,o=void 0===a?"left":a,i=n.disableBackdropTransition,s=void 0!==i&&i,c=n.disableDiscovery,u=void 0!==c&&c,l=n.disableSwipeToOpen,p=void 0===l?iOS:l,d=n.hideBackdrop,m=n.hysteresis,T=void 0===m?.52:m,h=n.minFlingVelocity,f=void 0===h?450:h,v=n.ModalProps,g=(v=void 0===v?{}:v).BackdropProps,y=_objectWithoutProperties(v,["BackdropProps"]),w=n.onClose,P=n.onOpen,b=n.open,S=n.PaperProps,R=void 0===S?{}:S,E=n.SwipeAreaProps,C=n.swipeAreaWidth,D=void 0===C?20:C,H=n.transitionDuration,x=void 0===H?transitionDurationDefault:H,A=n.variant,W=void 0===A?"temporary":A,Y=_objectWithoutProperties(n,["anchor","disableBackdropTransition","disableDiscovery","disableSwipeToOpen","hideBackdrop","hysteresis","minFlingVelocity","ModalProps","onClose","onOpen","open","PaperProps","SwipeAreaProps","swipeAreaWidth","transitionDuration","variant"]),k=React.useState(!1),M=k[0],O=k[1],N=React.useRef({isSwiping:null}),_=React.useRef(),X=React.useRef(),L=React.useRef(),B=React.useRef(!1),j=React.useRef();useEnhancedEffect(function(){j.current=null},[b]);var V=React.useCallback(function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.mode,a=void 0===n?null:n,i=r.changeTransition,c=void 0===i||i,u=getAnchor(t,o),l=-1!==["right","bottom"].indexOf(u)?1:-1,p=isHorizontal(o),m=p?"translate(".concat(l*e,"px, 0)"):"translate(0, ".concat(l*e,"px)"),T=L.current.style;T.webkitTransform=m,T.transform=m;var h="";if(a&&(h=t.transitions.create("all",getTransitionProps({timeout:x},{mode:a}))),c&&(T.webkitTransition=h,T.transition=h),!s&&!d){var f=X.current.style;f.opacity=1-e/getMaxTranslate(p,L.current),c&&(f.webkitTransition=h,f.transition=h)}},[o,s,d,t,x]),z=useEventCallback(function(e){if(B.current)if(nodeThatClaimedTheSwipe=null,B.current=!1,O(!1),N.current.isSwiping){N.current.isSwiping=null;var r,n=getAnchor(t,o),a=isHorizontal(o);r=a?calculateCurrentX(n,e.changedTouches,ownerDocument(e.currentTarget)):calculateCurrentY(n,e.changedTouches,ownerWindow(e.currentTarget));var i=a?N.current.startX:N.current.startY,s=getMaxTranslate(a,L.current),c=getTranslate(r,i,b,s),u=c/s;Math.abs(N.current.velocity)>f&&(j.current=1e3*Math.abs((s-c)/N.current.velocity)),b?N.current.velocity>f||u>T?w():V(0,{mode:"exit"}):N.current.velocity<-f||1-u>T?P():V(getMaxTranslate(a,L.current),{mode:"enter"})}else N.current.isSwiping=null}),I=useEventCallback(function(e){if(L.current&&B.current&&(null==nodeThatClaimedTheSwipe||nodeThatClaimedTheSwipe===N.current)){var r=getAnchor(t,o),n=isHorizontal(o),a=calculateCurrentX(r,e.touches,ownerDocument(e.currentTarget)),i=calculateCurrentY(r,e.touches,ownerWindow(e.currentTarget));if(b&&L.current.contains(e.target)&&null==nodeThatClaimedTheSwipe){var s=findNativeHandler({domTreeShapes:getDomTreeShapes(e.target,L.current),start:n?N.current.startX:N.current.startY,current:n?a:i,anchor:o});if(s)return void(nodeThatClaimedTheSwipe=s);nodeThatClaimedTheSwipe=N.current}if(null==N.current.isSwiping){var c=Math.abs(a-N.current.startX),l=Math.abs(i-N.current.startY);c>l&&e.cancelable&&e.preventDefault();var p=n?c>l&&c>UNCERTAINTY_THRESHOLD:l>c&&l>UNCERTAINTY_THRESHOLD;if(!0===p||(n?l>UNCERTAINTY_THRESHOLD:c>UNCERTAINTY_THRESHOLD)){if(N.current.isSwiping=p,!p)return void z(e);N.current.startX=a,N.current.startY=i,u||b||(n?N.current.startX-=D:N.current.startY-=D)}}if(N.current.isSwiping){var d=getMaxTranslate(n,L.current),m=n?N.current.startX:N.current.startY;b&&!N.current.paperHit&&(m=Math.min(m,d));var T=getTranslate(n?a:i,m,b,d);if(b)if(N.current.paperHit)0===T&&(N.current.startX=a,N.current.startY=i);else{if(!(n?a<d:i<d))return;N.current.paperHit=!0,N.current.startX=a,N.current.startY=i}null===N.current.lastTranslate&&(N.current.lastTranslate=T,N.current.lastTime=performance.now()+1);var h=(T-N.current.lastTranslate)/(performance.now()-N.current.lastTime)*1e3;N.current.velocity=.4*N.current.velocity+.6*h,N.current.lastTranslate=T,N.current.lastTime=performance.now(),e.cancelable&&e.preventDefault(),V(T)}}}),U=useEventCallback(function(e){if(!e.defaultPrevented&&!e.muiHandled&&(!b||X.current.contains(e.target)||L.current.contains(e.target))){var r=getAnchor(t,o),n=isHorizontal(o),a=calculateCurrentX(r,e.touches,ownerDocument(e.currentTarget)),i=calculateCurrentY(r,e.touches,ownerWindow(e.currentTarget));if(!b){if(p||e.target!==_.current)return;if(n){if(a>D)return}else if(i>D)return}e.muiHandled=!0,nodeThatClaimedTheSwipe=null,N.current.startX=a,N.current.startY=i,O(!0),!b&&L.current&&V(getMaxTranslate(n,L.current)+(u?20:-D),{changeTransition:!1}),N.current.velocity=0,N.current.lastTime=null,N.current.lastTranslate=null,N.current.paperHit=!1,B.current=!0}});return React.useEffect(function(){if("temporary"===W){var e=ownerDocument(L.current);return e.addEventListener("touchstart",U),e.addEventListener("touchmove",I,{passive:!1}),e.addEventListener("touchend",z),function(){e.removeEventListener("touchstart",U),e.removeEventListener("touchmove",I,{passive:!1}),e.removeEventListener("touchend",z)}}},[W,U,I,z]),React.useEffect(function(){return function(){nodeThatClaimedTheSwipe===N.current&&(nodeThatClaimedTheSwipe=null)}},[]),React.useEffect(function(){b||O(!1)},[b]),React.createElement(React.Fragment,null,React.createElement(Drawer,_extends({open:!("temporary"!==W||!M)||b,variant:W,ModalProps:_extends({BackdropProps:_extends({},g,{ref:X})},y),PaperProps:_extends({},R,{style:_extends({pointerEvents:"temporary"!==W||b?"":"none"},R.style),ref:L}),anchor:o,transitionDuration:j.current||x,onClose:w,ref:r},Y)),!p&&"temporary"===W&&React.createElement(NoSsr,null,React.createElement(SwipeArea,_extends({anchor:o,ref:_,width:D},E))))});"production"!==process.env.NODE_ENV&&(SwipeableDrawer.propTypes={anchor:PropTypes.oneOf(["bottom","left","right","top"]),children:PropTypes.node,disableBackdropTransition:PropTypes.bool,disableDiscovery:PropTypes.bool,disableSwipeToOpen:PropTypes.bool,hideBackdrop:PropTypes.bool,hysteresis:PropTypes.number,minFlingVelocity:PropTypes.number,ModalProps:PropTypes.shape({BackdropProps:PropTypes.shape({component:elementTypeAcceptingRef})}),onClose:PropTypes.func.isRequired,onOpen:PropTypes.func.isRequired,open:PropTypes.bool.isRequired,PaperProps:PropTypes.shape({component:elementTypeAcceptingRef,style:PropTypes.object}),SwipeAreaProps:PropTypes.object,swipeAreaWidth:PropTypes.number,transitionDuration:PropTypes.oneOfType([PropTypes.number,PropTypes.shape({appear:PropTypes.number,enter:PropTypes.number,exit:PropTypes.number})]),variant:PropTypes.oneOf(["permanent","persistent","temporary"])});export default SwipeableDrawer;
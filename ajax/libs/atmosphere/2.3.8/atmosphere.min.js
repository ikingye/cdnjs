!function(e,n){"function"==typeof define&&define.amd?define(n):"undefined"!=typeof exports?module.exports=n():e.atmosphere=n()}(this,function(){"use strict";var e,n,ne={},te=!1,r=[],oe=[],re=0;Object.prototype.hasOwnProperty;return(ne={version:"2.3.8-javascript",onError:function(e){},onClose:function(e){},onOpen:function(e){},onReopen:function(e){},onMessage:function(e){},onReconnect:function(e,n){},onMessagePublished:function(e){},onTransportFailure:function(e,n){},onLocalMessage:function(e){},onFailureToReconnect:function(e,n){},onClientTimeout:function(e){},onOpenAfterResume:function(e){},WebsocketApiAdapter:function(e){var n,t;return e.onMessage=function(e){t.onmessage({data:e.responseBody})},e.onMessagePublished=function(e){t.onmessage({data:e.responseBody})},e.onOpen=function(e){t.onopen(e)},t={close:function(){n.close()},send:function(e){n.push(e)},onmessage:function(e){},onopen:function(e){},onclose:function(e){},onerror:function(e){}},n=new ne.subscribe(e),t},AtmosphereRequest:function(e){var f,p,g,m={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,disableDisconnect:!1,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,handleOnlineOffline:!0,maxWebsocketErrorRetries:1,curWebsocketErrorRetries:0,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReopen:function(e,n){},onReconnect:function(e,n){},onMessagePublished:function(e){},onTransportFailure:function(e,n){},onLocalMessage:function(e){},onFailureToReconnect:function(e,n){},onClientTimeout:function(e){},onOpenAfterResume:function(e){}},h={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},a=null,r=null,t=null,o=null,i=null,u=!0,b=0,s=0,l="X",d=!1,v=null,c=null,w=ne.util.now();function n(){d=!(u=!0),b=0,o=t=r=a=null}function y(e){return"debug"==e?"debug"===m.logLevel:"info"==e?"info"===m.logLevel||"debug"===m.logLevel:"warn"==e?"warn"===m.logLevel||"info"===m.logLevel||"debug"===m.logLevel:"error"==e&&("error"===m.logLevel||"warn"===m.logLevel||"info"===m.logLevel||"debug"===m.logLevel)}function T(e){y("debug")&&ne.util.debug(new Date+" Atmosphere: "+e)}function k(e,n){return""===h.partialMessage&&"streaming"===n.transport&&e.responseText.length>n.maxStreamingLength}function R(){var o,e,n;!m.enableProtocol||m.disableDisconnect||m.firstMessage||(o="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+m.uuid,ne.util.each(m.headers,function(e,n){var t=ne.util.isFunction(n)?n.call(this,m,m,h):n;null!=t&&(o+="&"+encodeURIComponent(e)+"="+encodeURIComponent(t))}),e=m.url.replace(/([?&])_=[^&]*/,o),e+=e===m.url?(/\?/.test(m.url)?"&":"?")+o:"",(n=new ne.AtmosphereRequest({connected:!1})).connectTimeout=m.connectTimeout,n.attachHeadersAsQueryString=!1,n.dropHeaders=!0,n.url=e,n.contentType="text/plain",n.transport="polling",n.method="GET",n.data="",n.heartbeat=null,m.enableXDR&&(n.enableXDR=m.enableXDR),n.async=m.closeAsync,function(e,n){n=n||z(e);n.transport="polling",n.method="GET",n.withCredentials=!1,n.reconnect=!1,n.force=!0,n.suspend=!1,n.timeout=1e3,H(n)}("",n))}function S(){T("Closing (AtmosphereRequest._close() called)"),d=!0,m.reconnectId&&(clearTimeout(m.reconnectId),delete m.reconnectId),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),m.reconnect=!1,h.request=m,h.state="unsubscribe",h.responseBody="",h.status=408,h.partialMessage="",m.curWebsocketErrorRetries=0,ee(),R(),C()}function C(){h.partialMessage="",m.id&&clearTimeout(m.id),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),m.reconnectId&&(clearTimeout(m.reconnectId),delete m.reconnectId),null!=o&&(o.close(),o=null),null!=i&&(i.abort(),i=null),null!=t&&(t.abort(),t=null),null!=a&&(a.canSendMessage&&(T("invoking .close() on WebSocket object"),a.close()),a=null),null!=r&&(r.close(),r=null),function(){null!=f&&(clearInterval(p),document.cookie=g+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",f.signal("close",{reason:"",heir:d?(f.get("children")||[])[0]:w}),f.close());null!=c&&c.close()}()}function x(e){C(),n(),(m=ne.util.extend(m,e)).mrequest=m.reconnect,m.reconnect||(m.reconnect=!0)}function I(){if(m.shared){if(null!=(c=function(a){var n,t,o,s="atmosphere-"+a.url,e=function(){function n(e){e.key===s&&e.newValue&&l(e.newValue)}if(ne.util.storage){var t=window.localStorage,o=function(e){var n=t.getItem(s+"-"+e);return null===n?[]:JSON.parse(n)},r=function(e,n){t.setItem(s+"-"+e,JSON.stringify(n))};return{init:function(){return r("children",o("children").concat([w])),ne.util.on(window,"storage",n),o("opened")},signal:function(e,n){t.setItem(s,JSON.stringify({target:"p",type:e,data:n}))},close:function(){var e=o("children");ne.util.off(window,"storage",n),e&&i(e,a.id)&&r("children",e)}}}},r=function(){var t=window.open("",s.replace(/\W/g,""));if(t&&!t.closed&&t.callbacks)return{init:function(){return t.callbacks.push(l),t.children.push(w),t.opened},signal:function(e,n){!t.closed&&t.fire&&t.fire(JSON.stringify({target:"p",type:e,data:n}))},close:function(){o||(i(t.callbacks,l),i(t.children,w))}}};function i(e,n){for(var t=e.length,o=0;o<t;o++)e[o]===n&&e.splice(o,1);return t!==e.length}function l(e){var n=JSON.parse(e),t=n.data;if("c"===n.target)switch(n.type){case"open":O("opening","local",m);break;case"close":o||(o=!0,"aborted"===t.reason?S():t.heir===w?I():setTimeout(function(){I()},100));break;case"message":K(t,"messageReceived",200,a.transport);break;case"localMessage":G(t)}}function c(){var e=new RegExp("(?:^|; )("+encodeURIComponent(s)+")=([^;]*)").exec(document.cookie);if(e)return JSON.parse(decodeURIComponent(e[2]))}if(!(n=c())||1e3<ne.util.now()-n.ts)return;return(t=e()||r())?{open:function(){var e;return p=setInterval(function(){var e=n;(n=c())&&e.ts!==n.ts||l(JSON.stringify({target:"c",type:"close",data:{reason:"error",heir:e.heir}}))},1e3),(e=t.init())&&setTimeout(function(){O("opening","local",a)},50),e},send:function(e){t.signal("send",e)},localSend:function(e){t.signal("localSend",JSON.stringify({id:w,event:e}))},close:function(){d||(clearInterval(p),t.signal("close"),t.close())}}:void 0}(m))&&(y("debug")&&ne.util.debug("Storage service available. All communication will be local"),c.open(m)))return;y("debug")&&ne.util.debug("No Storage service available."),c=null}var e,n,t;m.firstMessage=0==re,m.isOpen=!1,m.ctime=ne.util.now(),0===m.uuid&&(m.uuid=re),h.closedByClientTimeout=!1,"websocket"!==m.transport&&"sse"!==m.transport?H(m):"websocket"===m.transport?null!=m.webSocketImpl||window.WebSocket||window.MozWebSocket?function t(o){h.transport="websocket";var e=(m.url,D(m,ne.util.getAbsoluteURL(m.webSocketUrl||m.url)).replace(/^http/,"ws"));y("debug")&&ne.util.debug("Invoking executeWebSocket, using URL: "+e);if(o&&!m.reconnect)return void(null!=a&&C());a=A(e);null!=m.webSocketBinaryType&&(a.binaryType=m.webSocketBinaryType);0<m.connectTimeout&&(m.id=setTimeout(function(){if(!o){var e={code:1002,reason:"",wasClean:!1};a.onclose(e);try{C()}catch(e){}}},m.connectTimeout));a.onopen=function(e){T("websocket.onopen"),E(m),te=!1,y("debug")&&ne.util.debug("Websocket successfully opened");var n=o;null!=a&&(a.canSendMessage=!0),m.enableProtocol||(o=!0,O(n?"re-opening":"opening","websocket",m)),null!=a&&"POST"===m.method&&(h.state="messageReceived",a.send(m.data))};a.onmessage=function(e){T("websocket.onmessage"),E(m),m.enableProtocol&&(o=!0),h.state="messageReceived",h.status=200;var n="string"==typeof(e=e.data);if(n){var t=U(e,m,h);t||(ee(),h.responseBody="",h.messages=[])}else{if(""===(e=B(m,e)))return;h.responseBody=e,ee(),h.responseBody=null}};a.onerror=function(e){T("websocket.onerror"),clearTimeout(m.id),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),m.curWebsocketErrorRetries++<m.maxWebsocketErrorRetries&&"websocket"!==m.fallbackTransport&&q("Failed to connect via Websocket. Downgrading to "+m.fallbackTransport+" and resending")};a.onclose=function(e){if(T("websocket.onclose"),clearTimeout(m.id),"closed"!==h.state){var n=e.reason;if(""===n)switch(e.code){case 1e3:n="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:n="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:n="The endpoint is terminating the connection due to a protocol error.";break;case 1003:n="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:n="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:n="Unknown: no status code was provided even though one was expected.";break;case 1006:n="Connection was closed abnormally (that is, with no close frame being sent)."}y("warn")&&ne.util.warn("Websocket closed, reason: "+n+" - wasClean: "+e.wasClean),h.closedByClientTimeout||m.handleOnlineOffline&&te?m.reconnectId&&(clearTimeout(m.reconnectId),delete m.reconnectId):(Z(o),h.state="closed",d?ne.util.log(m.logLevel,["Websocket closed normally"]):o||"websocket"===m.fallbackTransport?m.reconnect&&"websocket"===h.transport&&(C(),b++<m.maxReconnectOnClose?(O("re-connecting",m.transport,m),0<m.reconnectInterval?m.reconnectId=setTimeout(function(){h.responseBody="",h.messages=[],t(!0)},m.reconnectInterval):(h.responseBody="",h.messages=[],t(!0))):(ne.util.log(m.logLevel,["Websocket reconnect maximum try reached "+b]),y("warn")&&ne.util.warn("Websocket error, reason: "+e.reason),M(0,"maxReconnectOnClose reached"))):q("Websocket failed on first connection attempt. Downgrading to "+m.fallbackTransport+" and resending"))}};var n=navigator.userAgent.toLowerCase();var r=-1<n.indexOf("android");r&&void 0===a.url&&a.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}(!1):q("Websocket is not supported, using request.fallbackTransport ("+m.fallbackTransport+")"):"sse"===m.transport&&(e=ne.util.getAbsoluteURL(m.url.toLowerCase()),n=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(e),t=!(!n||n[1]==window.location.protocol&&n[2]==window.location.hostname&&(n[3]||("http:"===n[1]?80:443))==(window.location.port||("http:"===window.location.protocol?80:443))),!window.EventSource||t&&ne.util.browser.safari&&!(7<=ne.util.browser.vmajor)?q("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+m.fallbackTransport+")"):function n(t){h.transport="sse";var e=(o=D(m),o);var o;y("debug")&&(ne.util.debug("Invoking executeSSE"),ne.util.debug("Using URL: "+e));if(t&&!m.reconnect)return void(null!=r&&C());try{r=new EventSource(e,{withCredentials:m.withCredentials})}catch(e){return M(0,e),void q("SSE failed. Downgrading to fallback transport and resending")}0<m.connectTimeout&&(m.id=setTimeout(function(){t||C()},m.connectTimeout));r.onopen=function(e){T("sse.onopen"),E(m),y("debug")&&ne.util.debug("SSE successfully opened"),m.enableProtocol?m.isReopen&&(m.isReopen=!1,O("re-opening",m.transport,m)):O(t?"re-opening":"opening","sse",m),t=!0,"POST"===m.method&&(h.state="messageReceived",J(m.data))};r.onmessage=function(e){T("sse.onmessage"),E(m),!m.enableXDR&&window.location.host&&e.origin&&e.origin!==window.location.protocol+"//"+window.location.host?ne.util.log(m.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]):(h.state="messageReceived",h.status=200,U(e=e.data,m,h)||(ee(),h.responseBody="",h.messages=[]))};r.onerror=function(e){T("sse.onerror"),clearTimeout(m.id),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),h.closedByClientTimeout||(Z(t),C(),d?ne.util.log(m.logLevel,["SSE closed normally"]):t?m.reconnect&&"sse"===h.transport&&(b++<m.maxReconnectOnClose?(O("re-connecting",m.transport,m),0<m.reconnectInterval?m.reconnectId=setTimeout(function(){n(!0)},m.reconnectInterval):n(!0),h.responseBody="",h.messages=[]):(ne.util.log(m.logLevel,["SSE reconnect maximum try reached "+b]),M(0,"maxReconnectOnClose reached"))):q("SSE failed. Downgrading to fallback transport and resending"))}}(!1))}function O(e,n,t){function o(e){var n=JSON.parse(e),t=n.data;if("p"===n.target)switch(n.type){case"send":J(t);break;case"localSend":G(t);break;case"close":S()}}function r(){document.cookie=g+"="+encodeURIComponent(JSON.stringify({ts:ne.util.now()+1,heir:(a.get("children")||[])[0]}))+"; path=/"}var a,s,i,l,c,u,d;m.shared&&"local"!==n&&(s="atmosphere-"+m.url,i=function(){var t,e=s.replace(/\W/g,""),n=document.getElementById(e);return n||((n=document.createElement("div")).id=e,n.style.display="none",n.innerHTML='<iframe name="'+e+'" />',document.body.appendChild(n)),t=n.firstChild.contentWindow,{init:function(){t.callbacks=[o],t.fire=function(e){for(var n=0;n<t.callbacks.length;n++)t.callbacks[n](e)}},signal:function(e,n){!t.closed&&t.fire&&t.fire(JSON.stringify({target:"c",type:e,data:n}))},get:function(e){return t.closed?null:t[e]},set:function(e,n){t.closed||(t[e]=n)},close:function(){}}},v=function(e){a.signal("message",e)},(a=function(){function e(e){e.key===s&&e.newValue&&o(e.newValue)}if(ne.util.storage){var t=window.localStorage;return{init:function(){ne.util.on(window,"storage",e)},signal:function(e,n){t.setItem(s,JSON.stringify({target:"c",type:e,data:n}))},get:function(e){return JSON.parse(t.getItem(s+"-"+e))},set:function(e,n){t.setItem(s+"-"+e,JSON.stringify(n))},close:function(){ne.util.off(window,"storage",e),t.removeItem(s),t.removeItem(s+"-opened"),t.removeItem(s+"-children")}}}}()||i()).init(),y("debug")&&ne.util.debug("Installed StorageService "+a),a.set("children",[]),null==a.get("opened")||a.get("opened")||a.set("opened",!1),g=encodeURIComponent(s),r(),p=setInterval(r,1e3),f=a),null!=f&&f.set("opened",!0),t.close=function(){S()},0<b&&"re-connecting"===e?(t.isReopen=!0,(d=h).state="re-connecting",V(d)):null==h.error&&(h.request=t,l=h.state,h.state=e,c=h.transport,h.transport=n,u=h.responseBody,ee(),h.responseBody=u,h.state=l,h.transport=c)}function L(r){r.transport="jsonp";var a,s=null!=r&&void 0!==r?r:m;(i={open:function(){var o="atmosphere"+ ++w;function e(){var e=s.url;null!=s.dispatchUrl&&(e+=s.dispatchUrl);var n=s.data;s.attachHeadersAsQueryString&&(e=D(s),""!==n&&(e+="&X-Atmosphere-Post-Body="+encodeURIComponent(n)),n="");var t=document.head||document.getElementsByTagName("head")[0]||document.documentElement;(a=document.createElement("script")).src=e+"&jsonpTransport="+o,a.clean=function(){a.clean=a.onerror=a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),2==++r.scriptCount&&(r.scriptCount=1,s.lastIndex=0,s.openId&&clearTimeout(s.openId),s.heartbeatTimer&&clearTimeout(s.heartbeatTimer),s.reconnect&&b++<s.maxReconnectOnClose?(O("re-connecting",s.transport,s),N(i,s,r.reconnectInterval),s.openId=setTimeout(function(){P(s)},s.reconnectInterval+1e3)):M(0,"maxReconnectOnClose reached"))},a.onload=a.onreadystatechange=function(){T("jsonp.onload"),a.readyState&&!/loaded|complete/.test(a.readyState)||a.clean()},a.onerror=function(){T("jsonp.onerror"),r.scriptCount=1,a.clean()},t.insertBefore(a,t.firstChild)}window[o]=function(e){if(T("jsonp.window"),r.scriptCount=0,s.reconnect&&-1===s.maxRequest||s.requestCount++<s.maxRequest){if(s.executeCallbackBeforeReconnect||N(i,s,s.pollingInterval),null!=e&&"string"!=typeof e)try{e=e.message}catch(e){}U(e,s,h)||K(h.responseBody,"messageReceived",200,s.transport),s.executeCallbackBeforeReconnect&&N(i,s,s.pollingInterval),E(s)}else ne.util.log(m.logLevel,["JSONP reconnect maximum try reached "+m.requestCount]),M(0,"maxRequest reached")},setTimeout(function(){e()},50)},abort:function(){a&&a.clean&&a.clean()}}).open()}function A(e){return null!=m.webSocketImpl?m.webSocketImpl:new(window.WebSocket?WebSocket:MozWebSocket)(e)}function B(e,n){var t=n;if("polling"===e.transport)return t;if(e.enableProtocol&&e.firstMessage&&0!==ne.util.trim(n).length){var o=e.trackMessageLength?1:0,r=n.split(e.messageDelimiter);if(r.length<=o+1)return t;if(e.firstMessage=!1,e.uuid=ne.util.trim(r[o]),r.length<=o+2&&ne.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),s=parseInt(ne.util.trim(r[o+1]),10),l=r[o+2],"long-polling"!==e.transport&&P(e),re=e.uuid,t="",o=e.trackMessageLength?4:3,r.length>o+1)for(var a=o;a<r.length;a++)t+=r[a],a+1!==r.length&&(t+=e.messageDelimiter);0!==e.ackInterval&&setTimeout(function(){J("...ACK...")},e.ackInterval)}else e.enableProtocol&&e.firstMessage&&ne.util.browser.msie&&+ne.util.browser.version.split(".")[0]<10?ne.util.log(m.logLevel,["Receiving unexpected data from IE"]):P(e);return t}function E(e){clearTimeout(e.id),0<e.timeout&&"polling"!==e.transport&&(e.id=setTimeout(function(){h.closedByClientTimeout=!0,h.state="closedByClient",h.responseBody="",h.status=408,h.messages=[],ee(),R(),C()},e.timeout))}function M(e,n){C(),clearTimeout(m.id),h.state="error",h.reasonPhrase=n,h.responseBody="",h.status=e,h.messages=[],ee()}function U(e,n,t){if(0===(e=B(n,e)).length)return!0;if(t.responseBody=e,n.trackMessageLength){var o=[],r=(e=t.partialMessage+e).indexOf(n.messageDelimiter);if(-1!=r){for(;-1!==r;){var a=e.substring(0,r),s=+a;if(isNaN(s))throw t.partialMessage="",new Error('message length "'+a+'" is not a number');r=(r+=n.messageDelimiter.length)+s>e.length?-1:(o.push(e.substring(r,r+s)),(e=e.substring(r+s,e.length)).indexOf(n.messageDelimiter))}return t.partialMessage=e,0!==o.length?(t.responseBody=o.join(n.messageDelimiter),t.messages=o,!1):(t.responseBody="",t.messages=[],!0)}}return t.responseBody=e,!(t.messages=[e])}function q(e){ne.util.log(m.logLevel,[e]),void 0!==m.onTransportFailure?m.onTransportFailure(e,m):void 0!==ne.util.onTransportFailure&&ne.util.onTransportFailure(e,m);var n=-1===m.connectTimeout?0:m.connectTimeout;m.reconnect&&"none"!==m.transport||null==m.transport?(m.transport=m.fallbackTransport,m.method=m.fallbackMethod,h.transport=m.fallbackTransport,h.state="",m.fallbackTransport="none",0<n?m.reconnectId=setTimeout(function(){I()},n):I()):M(500,"Unable to reconnect with fallback transport")}function D(o,r){var a=null!=o&&void 0!==o?o:m;return null==r&&(r=a.url),a.attachHeadersAsQueryString&&(-1!==r.indexOf("X-Atmosphere-Framework")||(r+=-1!==r.indexOf("?")?"&":"?",r+="X-Atmosphere-tracking-id="+a.uuid,r+="&X-Atmosphere-Framework="+ne.version,r+="&X-Atmosphere-Transport="+a.transport,a.trackMessageLength&&(r+="&X-Atmosphere-TrackMessageSize=true"),null!==a.heartbeat&&null!==a.heartbeat.server&&(r+="&X-Heartbeat-Server="+a.heartbeat.server),""!==a.contentType&&(r+="&Content-Type="+("websocket"===a.transport?a.contentType:encodeURIComponent(a.contentType))),a.enableProtocol&&(r+="&X-atmo-protocol=true"),ne.util.each(a.headers,function(e,n){var t=ne.util.isFunction(n)?n.call(this,a,o,h):n;null!=t&&(r+="&"+encodeURIComponent(e)+"="+encodeURIComponent(t))}))),r}function P(e){if(e.isOpen)if(e.isReopen)e.isReopen=!1,O("re-opening",e.transport,e);else{if("messageReceived"!==h.state||"jsonp"!==e.transport&&"long-polling"!==e.transport)return;(n=h).state="openAfterResume",V(n),n.state="messageReceived"}else e.isOpen=!0,O("opening",e.transport,e);var n;!function(e){null!=e.heartbeatTimer&&clearTimeout(e.heartbeatTimer);{var n;!isNaN(s)&&0<s&&(n=function(){y("debug")&&ne.util.debug("Sending heartbeat"),J(l),e.heartbeatTimer=setTimeout(n,s)},e.heartbeatTimer=setTimeout(n,s))}}(e)}function H(s){var i=null==s&&void 0===s?m:s;if(i.lastIndex=0,i.readyState=0,"jsonp"===i.transport||i.enableXDR&&ne.util.checkCORSSupport())L(i);else{if(ne.util.browser.msie&&+ne.util.browser.version.split(".")[0]<10){if("streaming"===i.transport)return void(i.enableXDR&&window.XDomainRequest?j:W)(i);if(i.enableXDR&&window.XDomainRequest)return void j(i)}var n=function(e){var n;i.lastIndex=0,b++,e||i.reconnect&&b<=i.maxReconnectOnClose?(n=e?0:s.reconnectInterval,h.ffTryingReconnect=!0,O("re-connecting",s.transport,s),N(c,i,n)):M(0,"maxReconnectOnClose reached")},l=function(e){ne._beforeUnloadState?(ne.util.debug(new Date+" Atmosphere: reconnectF: execution delayed due to _beforeUnloadState flag"),setTimeout(function(){n(e)},5e3)):n(e)};if(i.force||i.reconnect&&(-1===i.maxRequest||i.requestCount++<i.maxRequest)){i.force=!1;var c=ne.util.xhr();c.hasData=!1,function(o,r,a){var e=r.url;null!=r.dispatchUrl&&"POST"===r.method&&(e+=r.dispatchUrl);e=D(r,e),e=ne.util.prepareURL(e),a&&(o.open(r.method,e,r.async),0<r.connectTimeout&&(r.id=setTimeout(function(){0===r.requestCount&&(C(),K("Connect timeout","closed",200,r.transport))},r.connectTimeout)));m.withCredentials&&"websocket"!==m.transport&&"withCredentials"in o&&(o.withCredentials=!0);m.dropHeaders||(o.setRequestHeader("X-Atmosphere-Framework",ne.version),o.setRequestHeader("X-Atmosphere-Transport",r.transport),null!==r.heartbeat&&null!==r.heartbeat.server&&o.setRequestHeader("X-Heartbeat-Server",o.heartbeat.server),r.trackMessageLength&&o.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),o.setRequestHeader("X-Atmosphere-tracking-id",r.uuid),ne.util.each(r.headers,function(e,n){var t=ne.util.isFunction(n)?n.call(this,o,r,a,h):n;null!=t&&o.setRequestHeader(e,t)}));""!==r.contentType&&o.setRequestHeader("Content-Type",r.contentType)}(c,i,!0),i.suspend&&(t=c),"polling"!==i.transport&&(h.transport=i.transport,c.onabort=function(){T("ajaxrequest.onabort"),Z(!0)},c.onerror=function(){T("ajaxrequest.onerror"),h.error=!0,h.ffTryingReconnect=!0;try{h.status=XMLHttpRequest.status}catch(e){h.status=500}h.status||(h.status=500),h.errorHandled||(C(),l(!1))}),c.onreadystatechange=function(){if(T("ajaxRequest.onreadystatechange, new state: "+c.readyState),d)T("onreadystatechange has been ignored due to _abortingConnection flag");else{h.error=null;var n=!1,e=!1;if("streaming"===i.transport&&2<i.readyState&&4===c.readyState)return C(),void l(!1);if(i.readyState=c.readyState,("streaming"===i.transport&&3<=c.readyState||"long-polling"===i.transport&&4===c.readyState)&&(e=!0),E(m),"polling"!==i.transport){var t=200;if(4===c.readyState&&(t=1e3<c.status?0:c.status),!i.reconnectOnServerError&&300<=t&&t<600)return void M(t,c.statusText);if(300<=t||0===t)return h.errorHandled=!0,C(),void l(!1);i.enableProtocol&&s.firstMessage||2!==c.readyState||(ne.util.browser.mozilla&&h.ffTryingReconnect?(h.ffTryingReconnect=!1,setTimeout(function(){h.ffTryingReconnect||P(i)},500)):P(i))}else 4===c.readyState&&(e=!0);if(e){var o=c.responseText;if(h.errorHandled=!1,"long-polling"===i.transport&&0===ne.util.trim(o).length)return void(c.hasData?c.hasData=!1:l(!0));if(c.hasData=!0,Q(c,m),"streaming"===i.transport)if(ne.util.browser.opera)ne.util.iterate(function(){if(500!==h.status&&c.responseText.length>i.lastIndex){try{h.status=c.status,h.headers=ne.util.parseHeaders(c.getAllResponseHeaders()),Q(c,m)}catch(e){h.status=404}E(m),h.state="messageReceived";var e=c.responseText.substring(i.lastIndex);if(i.lastIndex=c.responseText.length,(n=U(e,i,h))||ee(),k(c,i))return void X(c,i)}else if(400<h.status)return i.lastIndex=c.responseText.length,!1},0);else{n=U(o.substring(i.lastIndex,o.length),i,h);if(i.lastIndex=o.length,n)return}else n=U(o,i,h);var r=k(c,i);try{h.status=c.status,h.headers=ne.util.parseHeaders(c.getAllResponseHeaders()),Q(c,i)}catch(e){h.status=404}i.suspend?h.state=0===h.status?"closed":"messageReceived":h.state="messagePublished";var a=!r&&"streaming"!==s.transport&&"polling"!==s.transport;a&&!i.executeCallbackBeforeReconnect&&N(c,i,i.pollingInterval),0===h.responseBody.length||n||ee(),a&&i.executeCallbackBeforeReconnect&&N(c,i,i.pollingInterval),r&&X(c,i)}}};try{c.send(i.data),u=!0}catch(e){ne.util.log(i.logLevel,["Unable to connect to "+i.url]),M(0,e)}}else"debug"===i.logLevel&&ne.util.log(i.logLevel,["Max re-connection reached."]),M(0,"maxRequest reached")}}function X(e,n){h.messages=[],n.isReopen=!0,S(),d=!1,N(e,n,500)}function N(e,n,t){var o;h.closedByClientTimeout||(n.reconnect||n.suspend&&u)&&(o=0,e&&1<e.readyState&&(o=1e3<e.status?0:e.status),h.status=0===o?204:o,h.reason=0===o?"Server resumed the connection or down.":"OK",clearTimeout(n.id),n.reconnectId&&(clearTimeout(n.reconnectId),delete n.reconnectId),0<t?m.reconnectId=setTimeout(function(){H(n)},t):H(n))}function j(e){"polling"!==e.transport?(o=F(e)).open():F(e).open()}function F(e){var o=m;null!=e&&void 0!==e&&(o=e);function r(){"long-polling"===o.transport&&o.reconnect&&(-1===o.maxRequest||o.requestCount++<o.maxRequest)&&(n.status=200,j(o))}var a=o.transport,s=0,n=new window.XDomainRequest,t=o.rewriteURL||function(e){var n=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(n&&n[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+n[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+n[2]+"&").replace(/&$/,"")}return e};n.onprogress=function(){i(n)},n.onerror=function(){"polling"!==o.transport&&(C(),b++<o.maxReconnectOnClose?0<o.reconnectInterval?o.reconnectId=setTimeout(function(){O("re-connecting",e.transport,e),j(o)},o.reconnectInterval):(O("re-connecting",e.transport,e),j(o)):M(0,"maxReconnectOnClose reached"))},n.onload=function(){};var i=function(e){clearTimeout(o.id);var n=(n=e.responseText).substring(s);if(s+=n.length,"polling"!==a){E(o);var t=U(n,o,h);if("long-polling"===a&&0===ne.util.trim(n).length)return;o.executeCallbackBeforeReconnect&&r(),t||K(h.responseBody,"messageReceived",200,a),o.executeCallbackBeforeReconnect||r()}};return{open:function(){var e=o.url;null!=o.dispatchUrl&&(e+=o.dispatchUrl),e=D(o,e),n.open(o.method,t(e)),"GET"===o.method?n.send():n.send(o.data),0<o.connectTimeout&&(o.id=setTimeout(function(){0===o.requestCount&&(C(),K("Connect timeout","closed",200,o.transport))},o.connectTimeout))},close:function(){n.abort()}}}function W(e){(o=function(e){var r,a=m;null!=e&&void 0!==e&&(a=e);var s=new window.ActiveXObject("htmlfile");s.open(),s.close();var n=a.url;null!=a.dispatchUrl&&(n+=a.dispatchUrl);"polling"!==a.transport&&(h.transport=a.transport);return{open:function(){var e=s.createElement("iframe");n=D(a),""!==a.data&&(n+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data)),n=ne.util.prepareURL(n),e.src=n,s.body.appendChild(e);var o=e.contentDocument||e.contentWindow.document;r=ne.util.iterate(function(){try{if(!o.firstChild)return;var t=o.body?o.body.lastChild:o;t.omgThisIsBroken;var e,n;return o.body&&o.body.firstChild&&"pre"===o.body.firstChild.nodeName.toLowerCase()||(e=o.head||o.getElementsByTagName("head")[0]||o.documentElement||o,(n=o.createElement("script")).text="document.write('<plaintext>')",e.insertBefore(n,e.firstChild),e.removeChild(n),t=o.body.lastChild),a.closed&&(a.isReopen=!0),r=ne.util.iterate(function(){var e=function(){var e=t.cloneNode(!0);e.appendChild(o.createTextNode("."));var n=e.innerText;return n=n.substring(0,n.length-1)}();if(e.length>a.lastIndex){if(E(m),h.status=200,h.error=null,t.innerText="",U(e,a,h))return"";K(h.responseBody,"messageReceived",200,a.transport)}if(a.lastIndex=0,"complete"===o.readyState)return Z(!0),O("re-connecting",a.transport,a),0<a.reconnectInterval?a.reconnectId=setTimeout(function(){W(a)},a.reconnectInterval):W(a),!1},null),!1}catch(e){return h.error=!0,O("re-connecting",a.transport,a),b++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){W(a)},a.reconnectInterval):W(a):M(0,"maxReconnectOnClose reached"),s.execCommand("Stop"),s.close(),!1}})},close:function(){r&&r(),s.execCommand("Stop"),Z(!0)}}}(e)).open()}function J(e){var n;null!=c?(n=e,c.send(n)):null!=t||null!=r?_(e):null!=o?function(e){{var n;m.enableXDR&&ne.util.checkCORSSupport()?((n=z(e)).reconnect=!1,L(n)):_(e)}}(e):null!=i?_(e):null!=a?function(n){var e,t=ne.util.isBinary(n)?n:$(n);try{if(e=null!=m.dispatchUrl?m.webSocketPathDelimiter+m.dispatchUrl+m.webSocketPathDelimiter+t:t,!a.canSendMessage)return ne.util.error("WebSocket not connected.");a.send(e)}catch(e){a.onclose=function(e){},C(),q("Websocket failed. Downgrading to "+m.fallbackTransport+" and resending "+n),_(n)}}(e):(M(0,"No suspended connection available"),ne.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before trying to push data"))}function _(e){H(z(e))}function $(e){var n=e;return"object"==typeof n&&(n=e.data),n}function z(e){var n=$(e),t={connected:!1,timeout:6e4,method:"POST",url:m.url,contentType:m.contentType,headers:m.headers,reconnect:!0,callback:null,data:n,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:m.withCredentials,async:m.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:m.enableXDR,uuid:m.uuid,dispatchUrl:m.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:m.trackMessageLength,maxReconnectOnClose:m.maxReconnectOnClose,heartbeatTimer:m.heartbeatTimer,heartbeat:m.heartbeat};return"object"==typeof e&&(t=ne.util.extend(t,e)),t}function G(e){var n=JSON.parse(e);n.id!==w&&(void 0!==m.onLocalMessage?m.onLocalMessage(n.event):void 0!==ne.util.onLocalMessage&&ne.util.onLocalMessage(n.event))}function K(e,n,t,o){h.responseBody=e,h.transport=o,h.status=t,h.state=n,ee()}function Q(e,n){if(n.readResponsesHeaders)try{var t=e.getResponseHeader("X-Atmosphere-tracking-id");t&&null!=t&&(n.uuid=t.split(" ").pop())}catch(e){}else n.enableProtocol||(n.uuid=w)}function V(e){Y(e,m),Y(e,ne.util)}function Y(e,n){switch(e.state){case"messageReceived":T("Firing onMessage"),void(b=0)!==n.onMessage&&n.onMessage(e),void 0!==n.onmessage&&n.onmessage(e);break;case"error":T("Firing onError, reasonPhrase: "+(void 0!==e.reasonPhrase?e.reasonPhrase:"n/a")),void 0!==n.onError&&n.onError(e),void 0!==n.onerror&&n.onerror(e);break;case"opening":delete m.closed,T("Firing onOpen"),void 0!==n.onOpen&&n.onOpen(e),void 0!==n.onopen&&n.onopen(e);break;case"messagePublished":T("Firing messagePublished"),void 0!==n.onMessagePublished&&n.onMessagePublished(e);break;case"re-connecting":T("Firing onReconnect"),void 0!==n.onReconnect&&n.onReconnect(m,e);break;case"closedByClient":T("Firing closedByClient"),void 0!==n.onClientTimeout&&n.onClientTimeout(m);break;case"re-opening":delete m.closed,T("Firing onReopen"),void 0!==n.onReopen&&n.onReopen(m,e);break;case"fail-to-reconnect":T("Firing onFailureToReconnect"),void 0!==n.onFailureToReconnect&&n.onFailureToReconnect(m,e);break;case"unsubscribe":case"closed":void 0!==m.closed&&m.closed?T("Request already closed, not firing onClose ("+e.state+" case)"):(T("Firing onClose ("+e.state+" case)"),void 0!==n.onClose&&n.onClose(e),void 0!==n.onclose&&n.onclose(e)),m.closed=!0;break;case"openAfterResume":void 0!==n.onOpenAfterResume&&n.onOpenAfterResume(m)}}function Z(e){"closed"!==h.state&&(h.state="closed",h.responseBody="",h.messages=[],h.status=e?200:501,ee())}function ee(){function e(e,n){n(h)}null==c&&null!=v&&v(h.responseBody),m.reconnect=m.mrequest;for(var n="string"==typeof h.responseBody,t=n&&m.trackMessageLength?0<h.messages.length?h.messages:[""]:new Array(h.responseBody),o=0;o<t.length;o++)if(!(1<t.length&&0===t[o].length||(h.responseBody=n?ne.util.trim(t[o]):t[o],null==c&&null!=v&&v(h.responseBody),(0===h.responseBody.length||n&&l===h.responseBody)&&"messageReceived"===h.state))){if(V(h),0<oe.length){y("debug")&&ne.util.debug("Invoking "+oe.length+" global callbacks: "+h.state);try{ne.util.each(oe,e)}catch(e){ne.util.log(m.logLevel,["Callback exception"+e])}}if("function"==typeof m.callback){y("debug")&&ne.util.debug("Invoking request callbacks");try{m.callback(h)}catch(e){ne.util.log(m.logLevel,["Callback exception"+e])}}}}x(e),this.subscribe=function(e){x(e),I()},this.execute=function(){I()},this.close=function(){S()},this.disconnect=function(){R()},this.getUrl=function(){return m.url},this.push=function(e,n){var t;null!=n?(t=m.dispatchUrl,m.dispatchUrl=n,J(e),m.dispatchUrl=t):J(e)},this.getUUID=function(){return m.uuid},this.pushLocal=function(e){!function(e){if(0!==e.length)try{c?c.localSend(e):f&&f.signal("localMessage",JSON.stringify({id:w,event:e}))}catch(e){ne.util.error(e)}}(e)},this.enableProtocol=function(e){return m.enableProtocol},this.init=function(){n()},this.request=m,this.response=h},subscribe:function(e,n,t){"function"==typeof n&&ne.addCallback(n),"string"!=typeof e?t=e:t.url=e,re=void 0!==t&&void 0!==t.uuid?t.uuid:0;var o=new ne.AtmosphereRequest(t);return o.execute(),r[r.length]=o},unsubscribe:function(){if(0<r.length)for(var e=[].concat(r),n=0;n<e.length;n++){var t=e[n];t.close(),clearTimeout(t.response.request.id),t.heartbeatTimer&&clearTimeout(t.heartbeatTimer)}r=[],oe=[]},unsubscribeUrl:function(e){var n=-1;if(0<r.length)for(var t=0;t<r.length;t++){var o=r[t];if(o.getUrl()===e){o.close(),clearTimeout(o.response.request.id),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),n=t;break}}0<=n&&r.splice(n,1)},addCallback:function(e){-1===ne.util.inArray(e,oe)&&oe.push(e)},removeCallback:function(e){var n=ne.util.inArray(e,oe);-1!==n&&oe.splice(n,1)}}).util={browser:{},parseHeaders:function(e){for(var n,t=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,o={};n=t.exec(e);)o[n[1]]=n[2];return o},now:function(){return(new Date).getTime()},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},inArray:function(e,n){if(Array.prototype.indexOf)return n.indexOf(e);for(var t=n.length,o=0;o<t;++o)if(n[o]===e)return o;return-1},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getAbsoluteURL:function(e){if(void 0===document.createElement)return e;var n=document.createElement("div");return n.innerHTML='<a href="'+e+'"/>',encodeURI(decodeURI(n.firstChild.href))},prepareURL:function(e){var n=ne.util.now(),t=e.replace(/([?&])_=[^&]*/,"$1_="+n);return t+(t===e?(/\?/.test(e)?"&":"?")+"_="+n:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(e){var n,t=[];function o(e,n){n=ne.util.isFunction(n)?n():null==n?"":n,t.push(encodeURIComponent(e)+"="+encodeURIComponent(n))}function r(t,e){var n;if(ne.util.isArray(e))ne.util.each(e,function(e,n){/\[\]$/.test(t)?o(t,n):r(t+"["+("object"==typeof n?e:"")+"]",n)});else if("[object Object]"===Object.prototype.toString.call(e))for(n in e)r(t+"["+n+"]",e[n]);else o(t,e)}for(n in e)r(n,e[n]);return t.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(e){return!1}},iterate:function(n,t){var o;return t=t||0,function e(){o=setTimeout(function(){!1!==n()&&e()},t)}(),function(){clearTimeout(o)}},each:function(e,n,t){if(e){var o=0,r=e.length,a=ne.util.isArray(e);if(t){if(a)for(;o<r&&!1!==n.apply(e[o],t);o++);else for(o in e)if(!1===n.apply(e[o],t))break}else if(a)for(;o<r&&!1!==n.call(e[o],o,e[o]);o++);else for(o in e)if(!1===n.call(e[o],o,e[o]))break;return e}},extend:function(e){for(var n,t,o=1;o<arguments.length;o++)if(null!=(n=arguments[o]))for(t in n)e[t]=n[t];return e},on:function(e,n,t){e.addEventListener?e.addEventListener(n,t,!1):e.attachEvent&&e.attachEvent("on"+n,t)},off:function(e,n,t){e.removeEventListener?e.removeEventListener(n,t,!1):e.detachEvent&&e.detachEvent("on"+n,t)},log:function(e,n){var t;!window.console||"function"==typeof(t=window.console[e])&&t.apply(window.console,n)},warn:function(){ne.util.log("warn",arguments)},info:function(){ne.util.log("info",arguments)},debug:function(){ne.util.log("debug",arguments)},error:function(){ne.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}},checkCORSSupport:function(){if(ne.util.browser.msie&&!window.XDomainRequest&&+ne.util.browser.version.split(".")[0]<11)return!0;if(ne.util.browser.opera&&+ne.util.browser.version.split(".")<12)return!0;if("KreaTVWebKit/531"===ne.util.trim(navigator.userAgent).slice(0,16))return!0;if("kreatel"===ne.util.trim(navigator.userAgent).slice(-7).toLowerCase())return!0;var e=navigator.userAgent.toLowerCase().match(/.+android ([0-9]{1,2})/i),n=parseInt(e&&e[0]||-1,10);return!isNaN(n)&&-1<n&&n<3}},ne.util.now(),e=navigator.userAgent.toLowerCase(),"safari"===(n=/(chrome)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(e)||e.indexOf("android")<0&&/version\/(.+) (safari)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[])[2]&&(n[2]=n[1],n[1]="safari"),ne.util.browser[n[1]||""]=!0,ne.util.browser.version=n[2]||"0",ne.util.browser.vmajor=ne.util.browser.version.split(".")[0],ne.util.browser.trident&&(ne.util.browser.msie=!0),(ne.util.browser.msie||ne.util.browser.mozilla&&1==+ne.util.browser.version.split(".")[0])&&(ne.util.storage=!1),ne.callbacks={unload:function(){ne.util.debug(new Date+" Atmosphere: unload event"),ne.unsubscribe()},beforeUnload:function(){ne.util.debug(new Date+" Atmosphere: beforeunload event"),ne._beforeUnloadState=!0,setTimeout(function(){ne.util.debug(new Date+" Atmosphere: beforeunload event timeout reached. Reset _beforeUnloadState flag"),ne._beforeUnloadState=!1},5e3)},offline:function(){if(ne.util.debug(new Date+" Atmosphere: offline event"),te=!0,0<r.length)for(var e=[].concat(r),n=0;n<e.length;n++){var t=e[n];t.request.handleOnlineOffline&&(t.close(),clearTimeout(t.response.request.id),t.heartbeatTimer&&clearTimeout(t.heartbeatTimer))}},online:function(){if(ne.util.debug(new Date+" Atmosphere: online event"),0<r.length)for(var e=0;e<r.length;e++)r[e].request.handleOnlineOffline&&(r[e].init(),r[e].execute());te=!1}},ne.bindEvents=function(){ne.util.on(window,"unload",ne.callbacks.unload),ne.util.on(window,"beforeunload",ne.callbacks.beforeUnload),ne.util.on(window,"offline",ne.callbacks.offline),ne.util.on(window,"online",ne.callbacks.online)},ne.unbindEvents=function(){ne.util.off(window,"unload",ne.callbacks.unload),ne.util.off(window,"beforeunload",ne.callbacks.beforeUnload),ne.util.off(window,"offline",ne.callbacks.offline),ne.util.off(window,"online",ne.callbacks.online)},ne.bindEvents(),ne});
!function(e,t){"function"==typeof define&&define.amd?define(t):"undefined"!=typeof exports?module.exports=t():e.atmosphere=t()}(this,function(){"use strict";var e,t,te="2.3.1-javascript",ne={},oe=!1,r=[],re=[],ae=0,d=Object.prototype.hasOwnProperty;return(ne={onError:function(e){},onClose:function(e){},onOpen:function(e){},onReopen:function(e){},onMessage:function(e){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){},onFailureToReconnect:function(e,t){},onClientTimeout:function(e){},onOpenAfterResume:function(e){},WebsocketApiAdapter:function(e){var t,n;return e.onMessage=function(e){n.onmessage({data:e.responseBody})},e.onMessagePublished=function(e){n.onmessage({data:e.responseBody})},e.onOpen=function(e){n.onopen(e)},n={close:function(){t.close()},send:function(e){t.push(e)},onmessage:function(e){},onopen:function(e){},onclose:function(e){},onerror:function(e){}},t=new ne.subscribe(e),n},AtmosphereRequest:function(e){var f,p,g,m={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,disableDisconnect:!1,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,handleOnlineOffline:!0,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReopen:function(e,t){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){},onFailureToReconnect:function(e,t){},onClientTimeout:function(e){},onOpenAfterResume:function(e){}},h={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},a=null,r=null,n=null,o=null,s=null,u=!0,b=0,i=0,c="X",d=!1,v=null,l=null,w=ne.util.now();function t(){d=!(u=!0),b=0,o=n=r=a=null}function y(e){return"debug"==e?"debug"===m.logLevel:"info"==e?"info"===m.logLevel||"debug"===m.logLevel:"warn"==e?"warn"===m.logLevel||"info"===m.logLevel||"debug"===m.logLevel:"error"==e&&("error"===m.logLevel||"warn"===m.logLevel||"info"===m.logLevel||"debug"===m.logLevel)}function T(e){y("debug")&&ne.util.debug(new Date+" Atmosphere: "+e)}function S(e,t){return""===h.partialMessage&&"streaming"===t.transport&&e.responseText.length>t.maxStreamingLength}function R(){var o,e,t;!m.enableProtocol||m.disableDisconnect||m.firstMessage||(o="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+m.uuid,ne.util.each(m.headers,function(e,t){var n=ne.util.isFunction(t)?t.call(this,m,m,h):t;null!=n&&(o+="&"+encodeURIComponent(e)+"="+encodeURIComponent(n))}),e=m.url.replace(/([?&])_=[^&]*/,o),e+=e===m.url?(/\?/.test(m.url)?"&":"?")+o:"",(t=new ne.AtmosphereRequest({connected:!1})).connectTimeout=m.connectTimeout,t.attachHeadersAsQueryString=!1,t.dropHeaders=!0,t.url=e,t.contentType="text/plain",t.transport="polling",t.method="GET",t.data="",t.heartbeat=null,m.enableXDR&&(t.enableXDR=m.enableXDR),t.async=m.closeAsync,function(e,t){t=t||z(e);t.transport="polling",t.method="GET",t.withCredentials=!1,t.reconnect=!1,t.force=!0,t.suspend=!1,t.timeout=1e3,N(t)}("",t))}function k(){T("Closing (AtmosphereRequest._close() called)"),d=!0,m.reconnectId&&(clearTimeout(m.reconnectId),delete m.reconnectId),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),m.reconnect=!1,h.request=m,h.state="unsubscribe",h.responseBody="",h.status=408,h.partialMessage="",ee(),R(),C()}function C(){h.partialMessage="",m.id&&clearTimeout(m.id),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),m.reconnectId&&(clearTimeout(m.reconnectId),delete m.reconnectId),null!=o&&(o.close(),o=null),null!=s&&(s.abort(),s=null),null!=n&&(n.abort(),n=null),null!=a&&(a.canSendMessage&&(T("invoking .close() on WebSocket object"),a.close()),a=null),null!=r&&(r.close(),r=null),function(){null!=f&&(clearInterval(p),document.cookie=g+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",f.signal("close",{reason:"",heir:d?(f.get("children")||[])[0]:w}),f.close());null!=l&&l.close()}()}function x(e){C(),t(),(m=ne.util.extend(m,e)).mrequest=m.reconnect,m.reconnect||(m.reconnect=!0)}function I(){if(m.shared){if(null!=(l=function(a){var t,n,o,i="atmosphere-"+a.url,e=function(){function t(e){e.key===i&&e.newValue&&c(e.newValue)}if(ne.util.storage){var n=window.localStorage,o=function(e){return ne.util.parseJSON(n.getItem(i+"-"+e))},r=function(e,t){n.setItem(i+"-"+e,ne.util.stringifyJSON(t))};return{init:function(){return r("children",o("children").concat([w])),ne.util.on(window,"storage",t),o("opened")},signal:function(e,t){n.setItem(i,ne.util.stringifyJSON({target:"p",type:e,data:t}))},close:function(){var e=o("children");ne.util.off(window,"storage",t),e&&s(e,a.id)&&r("children",e)}}}},r=function(){var n=window.open("",i.replace(/\W/g,""));if(n&&!n.closed&&n.callbacks)return{init:function(){return n.callbacks.push(c),n.children.push(w),n.opened},signal:function(e,t){!n.closed&&n.fire&&n.fire(ne.util.stringifyJSON({target:"p",type:e,data:t}))},close:function(){o||(s(n.callbacks,c),s(n.children,w))}}};function s(e,t){for(var n=e.length,o=0;o<n;o++)e[o]===t&&e.splice(o,1);return n!==e.length}function c(e){var t=ne.util.parseJSON(e),n=t.data;if("c"===t.target)switch(t.type){case"open":O("opening","local",m);break;case"close":o||(o=!0,"aborted"===n.reason?k():n.heir===w?I():setTimeout(function(){I()},100));break;case"message":K(n,"messageReceived",200,a.transport);break;case"localMessage":G(n)}}function l(){var e=new RegExp("(?:^|; )("+encodeURIComponent(i)+")=([^;]*)").exec(document.cookie);if(e)return ne.util.parseJSON(decodeURIComponent(e[2]))}if(!(t=l())||1e3<ne.util.now()-t.ts)return;return(n=e()||r())?{open:function(){var e;return p=setInterval(function(){var e=t;(t=l())&&e.ts!==t.ts||c(ne.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:e.heir}}))},1e3),(e=n.init())&&setTimeout(function(){O("opening","local",a)},50),e},send:function(e){n.signal("send",e)},localSend:function(e){n.signal("localSend",ne.util.stringifyJSON({id:w,event:e}))},close:function(){d||(clearInterval(p),n.signal("close"),n.close())}}:void 0}(m))&&(y("debug")&&ne.util.debug("Storage service available. All communication will be local"),l.open(m)))return;y("debug")&&ne.util.debug("No Storage service available."),l=null}var e,t,n;m.firstMessage=0==ae,m.isOpen=!1,m.ctime=ne.util.now(),0===m.uuid&&(m.uuid=ae),h.closedByClientTimeout=!1,"websocket"!==m.transport&&"sse"!==m.transport?N(m):"websocket"===m.transport?null!=m.webSocketImpl||window.WebSocket||window.MozWebSocket?function n(o){h.transport="websocket";var e=(m.url,E(m,ne.util.getAbsoluteURL(m.webSocketUrl||m.url)).replace(/^http/,"ws"));y("debug")&&ne.util.debug("Invoking executeWebSocket, using URL: "+e);if(o&&!m.reconnect)return void(null!=a&&C());a=L(e);null!=m.webSocketBinaryType&&(a.binaryType=m.webSocketBinaryType);0<m.connectTimeout&&(m.id=setTimeout(function(){if(!o){var e={code:1002,reason:"",wasClean:!1};a.onclose(e);try{C()}catch(e){}}},m.connectTimeout));a.onopen=function(e){T("websocket.onopen"),U(m),oe=!1,y("debug")&&ne.util.debug("Websocket successfully opened");var t=o;null!=a&&(a.canSendMessage=!0),m.enableProtocol||(o=!0,O(t?"re-opening":"opening","websocket",m)),null!=a&&"POST"===m.method&&(h.state="messageReceived",a.send(m.data))};a.onmessage=function(e){T("websocket.onmessage"),U(m),m.enableProtocol&&(o=!0),h.state="messageReceived",h.status=200;var t="string"==typeof(e=e.data);if(t){var n=D(e,m,h);n||(ee(),h.responseBody="",h.messages=[])}else{if(""===(e=B(m,e)))return;h.responseBody=e,ee(),h.responseBody=null}};a.onerror=function(e){T("websocket.onerror"),clearTimeout(m.id),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer)};a.onclose=function(e){if(T("websocket.onclose"),clearTimeout(m.id),"closed"!==h.state){var t=e.reason;if(""===t)switch(e.code){case 1e3:t="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:t="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:t="The endpoint is terminating the connection due to a protocol error.";break;case 1003:t="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:t="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:t="Unknown: no status code was provided even though one was expected.";break;case 1006:t="Connection was closed abnormally (that is, with no close frame being sent)."}y("warn")&&ne.util.warn("Websocket closed, reason: "+t+" - wasClean: "+e.wasClean),h.closedByClientTimeout||m.handleOnlineOffline&&oe?m.reconnectId&&(clearTimeout(m.reconnectId),delete m.reconnectId):(Z(o),h.state="closed",d?ne.util.log(m.logLevel,["Websocket closed normally"]):o?m.reconnect&&"websocket"===h.transport&&(C(),b++<m.maxReconnectOnClose?(O("re-connecting",m.transport,m),0<m.reconnectInterval?m.reconnectId=setTimeout(function(){h.responseBody="",h.messages=[],n(!0)},m.reconnectInterval):(h.responseBody="",h.messages=[],n(!0))):(ne.util.log(m.logLevel,["Websocket reconnect maximum try reached "+b]),y("warn")&&ne.util.warn("Websocket error, reason: "+e.reason),M(0,"maxReconnectOnClose reached"))):q("Websocket failed on first connection attempt. Downgrading to "+m.fallbackTransport+" and resending"))}};var t=navigator.userAgent.toLowerCase();var r=-1<t.indexOf("android");r&&void 0===a.url&&a.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}(!1):q("Websocket is not supported, using request.fallbackTransport ("+m.fallbackTransport+")"):"sse"===m.transport&&(e=ne.util.getAbsoluteURL(m.url.toLowerCase()),t=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(e),n=!(!t||t[1]==window.location.protocol&&t[2]==window.location.hostname&&(t[3]||("http:"===t[1]?80:443))==(window.location.port||("http:"===window.location.protocol?80:443))),!window.EventSource||n&&ne.util.browser.safari&&!(7<=ne.util.browser.vmajor)?q("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+m.fallbackTransport+")"):function t(n){h.transport="sse";var e=(o=E(m),o);var o;y("debug")&&(ne.util.debug("Invoking executeSSE"),ne.util.debug("Using URL: "+e));if(n&&!m.reconnect)return void(null!=r&&C());try{r=new EventSource(e,{withCredentials:m.withCredentials})}catch(e){return M(0,e),void q("SSE failed. Downgrading to fallback transport and resending")}0<m.connectTimeout&&(m.id=setTimeout(function(){n||C()},m.connectTimeout));r.onopen=function(e){T("sse.onopen"),U(m),y("debug")&&ne.util.debug("SSE successfully opened"),m.enableProtocol?m.isReopen&&(m.isReopen=!1,O("re-opening",m.transport,m)):O(n?"re-opening":"opening","sse",m),n=!0,"POST"===m.method&&(h.state="messageReceived",r.send(m.data))};r.onmessage=function(e){T("sse.onmessage"),U(m),!m.enableXDR&&window.location.host&&e.origin&&e.origin!==window.location.protocol+"//"+window.location.host?ne.util.log(m.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]):(h.state="messageReceived",h.status=200,D(e=e.data,m,h)||(ee(),h.responseBody="",h.messages=[]))};r.onerror=function(e){T("sse.onerror"),clearTimeout(m.id),m.heartbeatTimer&&clearTimeout(m.heartbeatTimer),h.closedByClientTimeout||(Z(n),C(),d?ne.util.log(m.logLevel,["SSE closed normally"]):n?m.reconnect&&"sse"===h.transport&&(b++<m.maxReconnectOnClose?(O("re-connecting",m.transport,m),0<m.reconnectInterval?m.reconnectId=setTimeout(function(){t(!0)},m.reconnectInterval):t(!0),h.responseBody="",h.messages=[]):(ne.util.log(m.logLevel,["SSE reconnect maximum try reached "+b]),M(0,"maxReconnectOnClose reached"))):q("SSE failed. Downgrading to fallback transport and resending"))}}(!1))}function O(e,t,n){function o(e){var t=ne.util.parseJSON(e),n=t.data;if("p"===t.target)switch(t.type){case"send":W(n);break;case"localSend":G(n);break;case"close":k()}}function r(){document.cookie=g+"="+encodeURIComponent(ne.util.stringifyJSON({ts:ne.util.now()+1,heir:(a.get("children")||[])[0]}))+"; path=/"}var a,i,s,c,l,u,d;m.shared&&"local"!==t&&(i="atmosphere-"+m.url,s=function(){var n,e=i.replace(/\W/g,""),t=document.getElementById(e);return t||((t=document.createElement("div")).id=e,t.style.display="none",t.innerHTML='<iframe name="'+e+'" />',document.body.appendChild(t)),n=t.firstChild.contentWindow,{init:function(){n.callbacks=[o],n.fire=function(e){for(var t=0;t<n.callbacks.length;t++)n.callbacks[t](e)}},signal:function(e,t){!n.closed&&n.fire&&n.fire(ne.util.stringifyJSON({target:"c",type:e,data:t}))},get:function(e){return n.closed?null:n[e]},set:function(e,t){n.closed||(n[e]=t)},close:function(){}}},v=function(e){a.signal("message",e)},(a=function(){function e(e){e.key===i&&e.newValue&&o(e.newValue)}if(ne.util.storage){var n=window.localStorage;return{init:function(){ne.util.on(window,"storage",e)},signal:function(e,t){n.setItem(i,ne.util.stringifyJSON({target:"c",type:e,data:t}))},get:function(e){return ne.util.parseJSON(n.getItem(i+"-"+e))},set:function(e,t){n.setItem(i+"-"+e,ne.util.stringifyJSON(t))},close:function(){ne.util.off(window,"storage",e),n.removeItem(i),n.removeItem(i+"-opened"),n.removeItem(i+"-children")}}}}()||s()).init(),y("debug")&&ne.util.debug("Installed StorageService "+a),a.set("children",[]),null==a.get("opened")||a.get("opened")||a.set("opened",!1),g=encodeURIComponent(i),r(),p=setInterval(r,1e3),f=a),null!=f&&f.set("opened",!0),n.close=function(){k()},0<b&&"re-connecting"===e?(n.isReopen=!0,(d=h).state="re-connecting",V(d)):null==h.error&&(h.request=n,c=h.state,h.state=e,l=h.transport,h.transport=t,u=h.responseBody,ee(),h.responseBody=u,h.state=c,h.transport=l)}function A(r){r.transport="jsonp";var a,i=null!=r&&void 0!==r?r:m;(s={open:function(){var o="atmosphere"+ ++w;function e(){var e=i.url;null!=i.dispatchUrl&&(e+=i.dispatchUrl);var t=i.data;i.attachHeadersAsQueryString&&(e=E(i),""!==t&&(e+="&X-Atmosphere-Post-Body="+encodeURIComponent(t)),t="");var n=document.head||document.getElementsByTagName("head")[0]||document.documentElement;(a=document.createElement("script")).src=e+"&jsonpTransport="+o,a.clean=function(){a.clean=a.onerror=a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),2==++r.scriptCount&&(r.scriptCount=1,i.lastIndex=0,i.openId&&clearTimeout(i.openId),i.heartbeatTimer&&clearTimeout(i.heartbeatTimer),i.reconnect&&b++<i.maxReconnectOnClose?(O("re-connecting",i.transport,i),H(s,i,r.reconnectInterval),i.openId=setTimeout(function(){P(i)},i.reconnectInterval+1e3)):M(0,"maxReconnectOnClose reached"))},a.onload=a.onreadystatechange=function(){T("jsonp.onload"),a.readyState&&!/loaded|complete/.test(a.readyState)||a.clean()},a.onerror=function(){T("jsonp.onerror"),r.scriptCount=1,a.clean()},n.insertBefore(a,n.firstChild)}window[o]=function(e){if(T("jsonp.window"),r.scriptCount=0,i.reconnect&&-1===i.maxRequest||i.requestCount++<i.maxRequest){if(i.executeCallbackBeforeReconnect||H(s,i,i.pollingInterval),null!=e&&"string"!=typeof e)try{e=e.message}catch(e){}D(e,i,h)||K(h.responseBody,"messageReceived",200,i.transport),i.executeCallbackBeforeReconnect&&H(s,i,i.pollingInterval),U(i)}else ne.util.log(m.logLevel,["JSONP reconnect maximum try reached "+m.requestCount]),M(0,"maxRequest reached")},setTimeout(function(){e()},50)},abort:function(){a&&a.clean&&a.clean()}}).open()}function L(e){return null!=m.webSocketImpl?m.webSocketImpl:new(window.WebSocket?WebSocket:MozWebSocket)(e)}function B(e,t){var n=t;if("polling"===e.transport)return n;if(e.enableProtocol&&e.firstMessage&&0!==ne.util.trim(t).length){var o=e.trackMessageLength?1:0,r=t.split(e.messageDelimiter);if(r.length<=o+1)return n;if(e.firstMessage=!1,e.uuid=ne.util.trim(r[o]),r.length<=o+2&&ne.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),i=parseInt(ne.util.trim(r[o+1]),10),c=r[o+2],"long-polling"!==e.transport&&P(e),ae=e.uuid,n="",o=e.trackMessageLength?4:3,r.length>o+1)for(var a=o;a<r.length;a++)n+=r[a],a+1!==r.length&&(n+=e.messageDelimiter);0!==e.ackInterval&&setTimeout(function(){W("...ACK...")},e.ackInterval)}else e.enableProtocol&&e.firstMessage&&ne.util.browser.msie&&+ne.util.browser.version.split(".")[0]<10?ne.util.log(m.logLevel,["Receiving unexpected data from IE"]):P(e);return n}function U(e){clearTimeout(e.id),0<e.timeout&&"polling"!==e.transport&&(e.id=setTimeout(function(){h.closedByClientTimeout=!0,h.state="closedByClient",h.responseBody="",h.status=408,h.messages=[],ee(),R(),C()},e.timeout))}function M(e,t){C(),clearTimeout(m.id),h.state="error",h.reasonPhrase=t,h.responseBody="",h.status=e,h.messages=[],ee()}function D(e,t,n){if(0===(e=B(t,e)).length)return!0;if(n.responseBody=e,t.trackMessageLength){var o=[],r=(e=n.partialMessage+e).indexOf(t.messageDelimiter);if(-1!=r){for(;-1!==r;){var a=e.substring(0,r),i=+a;if(isNaN(i))throw new Error('message length "'+a+'" is not a number');r=(r+=t.messageDelimiter.length)+i>e.length?-1:(o.push(e.substring(r,r+i)),(e=e.substring(r+i,e.length)).indexOf(t.messageDelimiter))}return n.partialMessage=e,0!==o.length?(n.responseBody=o.join(t.messageDelimiter),n.messages=o,!1):(n.responseBody="",n.messages=[],!0)}}return n.responseBody=e,!(n.messages=[e])}function q(e){ne.util.log(m.logLevel,[e]),void 0!==m.onTransportFailure?m.onTransportFailure(e,m):void 0!==ne.util.onTransportFailure&&ne.util.onTransportFailure(e,m),m.transport=m.fallbackTransport;var t=-1===m.connectTimeout?0:m.connectTimeout;m.reconnect&&"none"!==m.transport||null==m.transport?(m.method=m.fallbackMethod,h.transport=m.fallbackTransport,m.fallbackTransport="none",0<t?m.reconnectId=setTimeout(function(){I()},t):I()):M(500,"Unable to reconnect with fallback transport")}function E(o,r){var a=null!=o&&void 0!==o?o:m;return null==r&&(r=a.url),a.attachHeadersAsQueryString&&(-1!==r.indexOf("X-Atmosphere-Framework")||(r+=-1!==r.indexOf("?")?"&":"?",r+="X-Atmosphere-tracking-id="+a.uuid,r+="&X-Atmosphere-Framework="+te,r+="&X-Atmosphere-Transport="+a.transport,a.trackMessageLength&&(r+="&X-Atmosphere-TrackMessageSize=true"),null!==a.heartbeat&&null!==a.heartbeat.server&&(r+="&X-Heartbeat-Server="+a.heartbeat.server),""!==a.contentType&&(r+="&Content-Type="+("websocket"===a.transport?a.contentType:encodeURIComponent(a.contentType))),a.enableProtocol&&(r+="&X-atmo-protocol=true"),ne.util.each(a.headers,function(e,t){var n=ne.util.isFunction(t)?t.call(this,a,o,h):t;null!=n&&(r+="&"+encodeURIComponent(e)+"="+encodeURIComponent(n))}))),r}function P(e){if(e.isOpen)if(e.isReopen)e.isReopen=!1,O("re-opening",e.transport,e);else{if("messageReceived"!==h.state||"jsonp"!==e.transport&&"long-polling"!==e.transport)return;(t=h).state="openAfterResume",V(t),t.state="messageReceived"}else e.isOpen=!0,O("opening",e.transport,e);var t;!function(e){null!=e.heartbeatTimer&&clearTimeout(e.heartbeatTimer);{var t;!isNaN(i)&&0<i&&(t=function(){y("debug")&&ne.util.debug("Sending heartbeat"),W(c),e.heartbeatTimer=setTimeout(t,i)},e.heartbeatTimer=setTimeout(t,i))}}(e)}function N(i){var s=null==i&&void 0===i?m:i;if(s.lastIndex=0,s.readyState=0,"jsonp"===s.transport||s.enableXDR&&ne.util.checkCORSSupport())A(s);else{if(ne.util.browser.msie&&+ne.util.browser.version.split(".")[0]<10){if("streaming"===s.transport)return void(s.enableXDR&&window.XDomainRequest?X:J)(s);if(s.enableXDR&&window.XDomainRequest)return void X(s)}var t=function(e){var t;s.lastIndex=0,b++,e||s.reconnect&&b<=s.maxReconnectOnClose?(t=e?0:i.reconnectInterval,h.ffTryingReconnect=!0,O("re-connecting",i.transport,i),H(l,s,t)):M(0,"maxReconnectOnClose reached")},c=function(e){ne._beforeUnloadState?(ne.util.debug(new Date+" Atmosphere: reconnectF: execution delayed due to _beforeUnloadState flag"),setTimeout(function(){t(e)},5e3)):t(e)};if(s.force||s.reconnect&&(-1===s.maxRequest||s.requestCount++<s.maxRequest)){s.force=!1;var l=ne.util.xhr();l.hasData=!1,function(o,r,a){var e=r.url;null!=r.dispatchUrl&&"POST"===r.method&&(e+=r.dispatchUrl);e=E(r,e),e=ne.util.prepareURL(e),a&&(o.open(r.method,e,r.async),0<r.connectTimeout&&(r.id=setTimeout(function(){0===r.requestCount&&(C(),K("Connect timeout","closed",200,r.transport))},r.connectTimeout)));m.withCredentials&&"websocket"!==m.transport&&"withCredentials"in o&&(o.withCredentials=!0);m.dropHeaders||(o.setRequestHeader("X-Atmosphere-Framework",te),o.setRequestHeader("X-Atmosphere-Transport",r.transport),null!==r.heartbeat&&null!==r.heartbeat.server&&o.setRequestHeader("X-Heartbeat-Server",o.heartbeat.server),r.trackMessageLength&&o.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),o.setRequestHeader("X-Atmosphere-tracking-id",r.uuid),ne.util.each(r.headers,function(e,t){var n=ne.util.isFunction(t)?t.call(this,o,r,a,h):t;null!=n&&o.setRequestHeader(e,n)}));""!==r.contentType&&o.setRequestHeader("Content-Type",r.contentType)}(l,s,!0),s.suspend&&(n=l),"polling"!==s.transport&&(h.transport=s.transport,l.onabort=function(){T("ajaxrequest.onabort"),Z(!0)},l.onerror=function(){T("ajaxrequest.onerror"),h.error=!0,h.ffTryingReconnect=!0;try{h.status=XMLHttpRequest.status}catch(e){h.status=500}h.status||(h.status=500),h.errorHandled||(C(),c(!1))}),l.onreadystatechange=function(){if(T("ajaxRequest.onreadystatechange, new state: "+l.readyState),d)T("onreadystatechange has been ignored due to _abortingConnection flag");else{h.error=null;var t=!1,e=!1;if("streaming"===s.transport&&2<s.readyState&&4===l.readyState)return C(),void c(!1);if(s.readyState=l.readyState,("streaming"===s.transport&&3<=l.readyState||"long-polling"===s.transport&&4===l.readyState)&&(e=!0),U(m),"polling"!==s.transport){var n=200;if(4===l.readyState&&(n=1e3<l.status?0:l.status),!s.reconnectOnServerError&&300<=n&&n<600)return void M(n,l.statusText);if(300<=n||0===n)return h.errorHandled=!0,C(),void c(!1);s.enableProtocol&&i.firstMessage||2!==l.readyState||(ne.util.browser.mozilla&&h.ffTryingReconnect?(h.ffTryingReconnect=!1,setTimeout(function(){h.ffTryingReconnect||P(s)},500)):P(s))}else 4===l.readyState&&(e=!0);if(e){var o=l.responseText;if(h.errorHandled=!1,"long-polling"===s.transport&&0===ne.util.trim(o).length)return void(l.hasData?l.hasData=!1:c(!0));if(l.hasData=!0,Q(l,m),"streaming"===s.transport)if(ne.util.browser.opera)ne.util.iterate(function(){if(500!==h.status&&l.responseText.length>s.lastIndex){try{h.status=l.status,h.headers=ne.util.parseHeaders(l.getAllResponseHeaders()),Q(l,m)}catch(e){h.status=404}U(m),h.state="messageReceived";var e=l.responseText.substring(s.lastIndex);if(s.lastIndex=l.responseText.length,(t=D(e,s,h))||ee(),S(l,s))return void j(l,s)}else if(400<h.status)return s.lastIndex=l.responseText.length,!1},0);else{t=D(o.substring(s.lastIndex,o.length),s,h);if(s.lastIndex=o.length,t)return}else t=D(o,s,h);var r=S(l,s);try{h.status=l.status,h.headers=ne.util.parseHeaders(l.getAllResponseHeaders()),Q(l,s)}catch(e){h.status=404}s.suspend?h.state=0===h.status?"closed":"messageReceived":h.state="messagePublished";var a=!r&&"streaming"!==i.transport&&"polling"!==i.transport;a&&!s.executeCallbackBeforeReconnect&&H(l,s,s.pollingInterval),0===h.responseBody.length||t||ee(),a&&s.executeCallbackBeforeReconnect&&H(l,s,s.pollingInterval),r&&j(l,s)}}};try{l.send(s.data),u=!0}catch(e){ne.util.log(s.logLevel,["Unable to connect to "+s.url]),M(0,e)}}else"debug"===s.logLevel&&ne.util.log(s.logLevel,["Max re-connection reached."]),M(0,"maxRequest reached")}}function j(e,t){h.messages=[],t.isReopen=!0,k(),d=!1,H(e,t,500)}function H(e,t,n){var o;h.closedByClientTimeout||(t.reconnect||t.suspend&&u)&&(o=0,e&&1<e.readyState&&(o=1e3<e.status?0:e.status),h.status=0===o?204:o,h.reason=0===o?"Server resumed the connection or down.":"OK",clearTimeout(t.id),t.reconnectId&&(clearTimeout(t.reconnectId),delete t.reconnectId),0<n?m.reconnectId=setTimeout(function(){N(t)},n):N(t))}function X(e){"polling"!==e.transport?(o=F(e)).open():F(e).open()}function F(e){var o=m;null!=e&&void 0!==e&&(o=e);function r(){"long-polling"===o.transport&&o.reconnect&&(-1===o.maxRequest||o.requestCount++<o.maxRequest)&&(t.status=200,X(o))}var a=o.transport,i=0,t=new window.XDomainRequest,n=o.rewriteURL||function(e){var t=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(t&&t[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+t[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+t[2]+"&").replace(/&$/,"")}return e};t.onprogress=function(){s(t)},t.onerror=function(){"polling"!==o.transport&&(C(),b++<o.maxReconnectOnClose?0<o.reconnectInterval?o.reconnectId=setTimeout(function(){O("re-connecting",e.transport,e),X(o)},o.reconnectInterval):(O("re-connecting",e.transport,e),X(o)):M(0,"maxReconnectOnClose reached"))},t.onload=function(){};var s=function(e){clearTimeout(o.id);var t=(t=e.responseText).substring(i);if(i+=t.length,"polling"!==a){U(o);var n=D(t,o,h);if("long-polling"===a&&0===ne.util.trim(t).length)return;o.executeCallbackBeforeReconnect&&r(),n||K(h.responseBody,"messageReceived",200,a),o.executeCallbackBeforeReconnect||r()}};return{open:function(){var e=o.url;null!=o.dispatchUrl&&(e+=o.dispatchUrl),e=E(o,e),t.open(o.method,n(e)),"GET"===o.method?t.send():t.send(o.data),0<o.connectTimeout&&(o.id=setTimeout(function(){0===o.requestCount&&(C(),K("Connect timeout","closed",200,o.transport))},o.connectTimeout))},close:function(){t.abort()}}}function J(e){(o=function(e){var r,a=m;null!=e&&void 0!==e&&(a=e);var i=new window.ActiveXObject("htmlfile");i.open(),i.close();var t=a.url;null!=a.dispatchUrl&&(t+=a.dispatchUrl);"polling"!==a.transport&&(h.transport=a.transport);return{open:function(){var e=i.createElement("iframe");t=E(a),""!==a.data&&(t+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data)),t=ne.util.prepareURL(t),e.src=t,i.body.appendChild(e);var o=e.contentDocument||e.contentWindow.document;r=ne.util.iterate(function(){try{if(!o.firstChild)return;var e,t,n=o.body?o.body.lastChild:o;return o.body&&o.body.firstChild&&"pre"===o.body.firstChild.nodeName.toLowerCase()||(e=o.head||o.getElementsByTagName("head")[0]||o.documentElement||o,(t=o.createElement("script")).text="document.write('<plaintext>')",e.insertBefore(t,e.firstChild),e.removeChild(t),n=o.body.lastChild),a.closed&&(a.isReopen=!0),r=ne.util.iterate(function(){var e=function(){var e=n.cloneNode(!0);e.appendChild(o.createTextNode("."));var t=e.innerText;return t=t.substring(0,t.length-1)}();if(e.length>a.lastIndex){if(U(m),h.status=200,h.error=null,n.innerText="",D(e,a,h))return"";K(h.responseBody,"messageReceived",200,a.transport)}if(a.lastIndex=0,"complete"===o.readyState)return Z(!0),O("re-connecting",a.transport,a),0<a.reconnectInterval?a.reconnectId=setTimeout(function(){J(a)},a.reconnectInterval):J(a),!1},null),!1}catch(e){return h.error=!0,O("re-connecting",a.transport,a),b++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){J(a)},a.reconnectInterval):J(a):M(0,"maxReconnectOnClose reached"),i.execCommand("Stop"),i.close(),!1}})},close:function(){r&&r(),i.execCommand("Stop"),Z(!0)}}}(e)).open()}function W(e){var t;null!=l?(t=e,l.send(t)):null!=n||null!=r?_(e):null!=o?function(e){{var t;m.enableXDR&&ne.util.checkCORSSupport()?((t=z(e)).reconnect=!1,A(t)):_(e)}}(e):null!=s?_(e):null!=a?function(t){var e,n=ne.util.isBinary(t)?t:$(t);try{if(e=null!=m.dispatchUrl?m.webSocketPathDelimiter+m.dispatchUrl+m.webSocketPathDelimiter+n:n,!a.canSendMessage)return ne.util.error("WebSocket not connected.");a.send(e)}catch(e){a.onclose=function(e){},C(),q("Websocket failed. Downgrading to "+m.fallbackTransport+" and resending "+t),_(t)}}(e):(M(0,"No suspended connection available"),ne.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before trying to push data"))}function _(e){N(z(e))}function $(e){var t=e;return"object"==typeof t&&(t=e.data),t}function z(e){var t=$(e),n={connected:!1,timeout:6e4,method:"POST",url:m.url,contentType:m.contentType,headers:m.headers,reconnect:!0,callback:null,data:t,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:m.withCredentials,async:m.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:m.enableXDR,uuid:m.uuid,dispatchUrl:m.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:m.trackMessageLength,maxReconnectOnClose:m.maxReconnectOnClose,heartbeatTimer:m.heartbeatTimer,heartbeat:m.heartbeat};return"object"==typeof e&&(n=ne.util.extend(n,e)),n}function G(e){var t=ne.util.parseJSON(e);t.id!==w&&(void 0!==m.onLocalMessage?m.onLocalMessage(t.event):void 0!==ne.util.onLocalMessage&&ne.util.onLocalMessage(t.event))}function K(e,t,n,o){h.responseBody=e,h.transport=o,h.status=n,h.state=t,ee()}function Q(e,t){if(t.readResponsesHeaders)try{var n=e.getResponseHeader("X-Atmosphere-tracking-id");n&&null!=n&&(t.uuid=n.split(" ").pop())}catch(e){}else t.enableProtocol||(t.uuid=w)}function V(e){Y(e,m),Y(e,ne.util)}function Y(e,t){switch(e.state){case"messageReceived":T("Firing onMessage"),void(b=0)!==t.onMessage&&t.onMessage(e),void 0!==t.onmessage&&t.onmessage(e);break;case"error":T("Firing onError, reasonPhrase: "+(void 0!==e.reasonPhrase?e.reasonPhrase:"n/a")),void 0!==t.onError&&t.onError(e),void 0!==t.onerror&&t.onerror(e);break;case"opening":delete m.closed,T("Firing onOpen"),void 0!==t.onOpen&&t.onOpen(e),void 0!==t.onopen&&t.onopen(e);break;case"messagePublished":T("Firing messagePublished"),void 0!==t.onMessagePublished&&t.onMessagePublished(e);break;case"re-connecting":T("Firing onReconnect"),void 0!==t.onReconnect&&t.onReconnect(m,e);break;case"closedByClient":T("Firing closedByClient"),void 0!==t.onClientTimeout&&t.onClientTimeout(m);break;case"re-opening":delete m.closed,T("Firing onReopen"),void 0!==t.onReopen&&t.onReopen(m,e);break;case"fail-to-reconnect":T("Firing onFailureToReconnect"),void 0!==t.onFailureToReconnect&&t.onFailureToReconnect(m,e);break;case"unsubscribe":case"closed":void 0!==m.closed&&m.closed?T("Request already closed, not firing onClose ("+e.state+" case)"):(T("Firing onClose ("+e.state+" case)"),void 0!==t.onClose&&t.onClose(e),void 0!==t.onclose&&t.onclose(e)),m.closed=!0;break;case"openAfterResume":void 0!==t.onOpenAfterResume&&t.onOpenAfterResume(m)}}function Z(e){"closed"!==h.state&&(h.state="closed",h.responseBody="",h.messages=[],h.status=e?200:501,ee())}function ee(){function e(e,t){t(h)}null==l&&null!=v&&v(h.responseBody),m.reconnect=m.mrequest;for(var t="string"==typeof h.responseBody,n=t&&m.trackMessageLength?0<h.messages.length?h.messages:[""]:new Array(h.responseBody),o=0;o<n.length;o++)if(!(1<n.length&&0===n[o].length||(h.responseBody=t?ne.util.trim(n[o]):n[o],null==l&&null!=v&&v(h.responseBody),(0===h.responseBody.length||t&&c===h.responseBody)&&"messageReceived"===h.state))){if(V(h),0<re.length){y("debug")&&ne.util.debug("Invoking "+re.length+" global callbacks: "+h.state);try{ne.util.each(re,e)}catch(e){ne.util.log(m.logLevel,["Callback exception"+e])}}if("function"==typeof m.callback){y("debug")&&ne.util.debug("Invoking request callbacks");try{m.callback(h)}catch(e){ne.util.log(m.logLevel,["Callback exception"+e])}}}}x(e),this.subscribe=function(e){x(e),I()},this.execute=function(){I()},this.close=function(){k()},this.disconnect=function(){R()},this.getUrl=function(){return m.url},this.push=function(e,t){var n;null!=t?(n=m.dispatchUrl,m.dispatchUrl=t,W(e),m.dispatchUrl=n):W(e)},this.getUUID=function(){return m.uuid},this.pushLocal=function(e){!function(e){if(0!==e.length)try{l?l.localSend(e):f&&f.signal("localMessage",ne.util.stringifyJSON({id:w,event:e}))}catch(e){ne.util.error(e)}}(e)},this.enableProtocol=function(e){return m.enableProtocol},this.init=function(){t()},this.request=m,this.response=h},subscribe:function(e,t,n){"function"==typeof t&&ne.addCallback(t),"string"!=typeof e?n=e:n.url=e,ae=void 0!==n&&void 0!==n.uuid?n.uuid:0;var o=new ne.AtmosphereRequest(n);return o.execute(),r[r.length]=o},unsubscribe:function(){if(0<r.length)for(var e=[].concat(r),t=0;t<e.length;t++){var n=e[t];n.close(),clearTimeout(n.response.request.id),n.heartbeatTimer&&clearTimeout(n.heartbeatTimer)}r=[],re=[]},unsubscribeUrl:function(e){var t=-1;if(0<r.length)for(var n=0;n<r.length;n++){var o=r[n];if(o.getUrl()===e){o.close(),clearTimeout(o.response.request.id),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),t=n;break}}0<=t&&r.splice(t,1)},addCallback:function(e){-1===ne.util.inArray(e,re)&&re.push(e)},removeCallback:function(e){var t=ne.util.inArray(e,re);-1!==t&&re.splice(t,1)}}).util={browser:{},parseHeaders:function(e){for(var t,n=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,o={};t=n.exec(e);)o[t[1]]=t[2];return o},now:function(){return(new Date).getTime()},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},inArray:function(e,t){if(Array.prototype.indexOf)return t.indexOf(e);for(var n=t.length,o=0;o<n;++o)if(t[o]===e)return o;return-1},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getAbsoluteURL:function(e){if(void 0===document.createElement)return e;var t=document.createElement("div");return t.innerHTML='<a href="'+e+'"/>',encodeURI(decodeURI(t.firstChild.href))},prepareURL:function(e){var t=ne.util.now(),n=e.replace(/([?&])_=[^&]*/,"$1_="+t);return n+(n===e?(/\?/.test(e)?"&":"?")+"_="+t:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(e){var t,n=[];function o(e,t){t=ne.util.isFunction(t)?t():null==t?"":t,n.push(encodeURIComponent(e)+"="+encodeURIComponent(t))}function r(n,e){var t;if(ne.util.isArray(e))ne.util.each(e,function(e,t){/\[\]$/.test(n)?o(n,t):r(n+"["+("object"==typeof t?e:"")+"]",t)});else if("[object Object]"===Object.prototype.toString.call(e))for(t in e)r(n+"["+t+"]",e[t]);else o(n,e)}for(t in e)r(t,e[t]);return n.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(e){return!1}},iterate:function(t,n){var o;return n=n||0,function e(){o=setTimeout(function(){!1!==t()&&e()},n)}(),function(){clearTimeout(o)}},each:function(e,t,n){if(e){var o=0,r=e.length,a=ne.util.isArray(e);if(n){if(a)for(;o<r&&!1!==t.apply(e[o],n);o++);else for(o in e)if(!1===t.apply(e[o],n))break}else if(a)for(;o<r&&!1!==t.call(e[o],o,e[o]);o++);else for(o in e)if(!1===t.call(e[o],o,e[o]))break;return e}},extend:function(e){for(var t,n,o=1;o<arguments.length;o++)if(null!=(t=arguments[o]))for(n in t)e[n]=t[n];return e},on:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},off:function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)},log:function(e,t){var n;!window.console||"function"==typeof(n=window.console[e])&&n.apply(window.console,t)},warn:function(){ne.util.log("warn",arguments)},info:function(){ne.util.log("info",arguments)},debug:function(){ne.util.log("debug",arguments)},error:function(){ne.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}},parseJSON:function(e){return e?window.JSON&&window.JSON.parse?window.JSON.parse(e):new Function("return "+e)():null},stringifyJSON:function(e){var t=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function l(e){return'"'+e.replace(t,function(e){var t=n[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"'}function u(e){return e<10?"0"+e:e}return window.JSON&&window.JSON.stringify?window.JSON.stringify(e):function e(t,n){var o,r,a,i,s=n[t],c=typeof s;switch(s&&"object"==typeof s&&"function"==typeof s.toJSON&&(c=typeof(s=s.toJSON(t))),c){case"string":return l(s);case"number":return isFinite(s)?String(s):"null";case"boolean":return String(s);case"object":if(!s)return"null";switch(Object.prototype.toString.call(s)){case"[object Date]":return isFinite(s.valueOf())?'"'+s.getUTCFullYear()+"-"+u(s.getUTCMonth()+1)+"-"+u(s.getUTCDate())+"T"+u(s.getUTCHours())+":"+u(s.getUTCMinutes())+":"+u(s.getUTCSeconds())+'Z"':"null";case"[object Array]":for(a=s.length,i=[],o=0;o<a;o++)i.push(e(o,s)||"null");return"["+i.join(",")+"]";default:for(o in i=[],s)d.call(s,o)&&(r=e(o,s))&&i.push(l(o)+":"+r);return"{"+i.join(",")+"}"}}}("",{"":e})},checkCORSSupport:function(){if(ne.util.browser.msie&&!window.XDomainRequest&&+ne.util.browser.version.split(".")[0]<11)return!0;if(ne.util.browser.opera&&+ne.util.browser.version.split(".")<12)return!0;if("KreaTVWebKit/531"===ne.util.trim(navigator.userAgent).slice(0,16))return!0;if("kreatel"===ne.util.trim(navigator.userAgent).slice(-7).toLowerCase())return!0;var e=navigator.userAgent.toLowerCase().match(/.+android ([0-9]{1,2})/i),t=parseInt(e&&e[0]||-1,10);return!isNaN(t)&&-1<t&&t<3}},ne.util.now(),e=navigator.userAgent.toLowerCase(),"safari"===(t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(e)||e.indexOf("android")<0&&/version\/(.+) (safari)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[])[2]&&(t[2]=t[1],t[1]="safari"),ne.util.browser[t[1]||""]=!0,ne.util.browser.version=t[2]||"0",ne.util.browser.vmajor=ne.util.browser.version.split(".")[0],ne.util.browser.trident&&(ne.util.browser.msie=!0),(ne.util.browser.msie||ne.util.browser.mozilla&&1==+ne.util.browser.version.split(".")[0])&&(ne.util.storage=!1),ne.util.on(window,"unload",function(e){ne.util.debug(new Date+" Atmosphere: unload event"),ne.unsubscribe()}),ne.util.on(window,"beforeunload",function(e){ne.util.debug(new Date+" Atmosphere: beforeunload event"),ne._beforeUnloadState=!0,setTimeout(function(){ne.util.debug(new Date+" Atmosphere: beforeunload event timeout reached. Reset _beforeUnloadState flag"),ne._beforeUnloadState=!1},5e3)}),ne.util.on(window,"keypress",function(e){27!==e.charCode&&27!==e.keyCode||e.preventDefault&&e.preventDefault()}),ne.util.on(window,"offline",function(){if(ne.util.debug(new Date+" Atmosphere: offline event"),oe=!0,0<r.length)for(var e=[].concat(r),t=0;t<e.length;t++){var n=e[t];n.request.handleOnlineOffline&&(n.close(),clearTimeout(n.response.request.id),n.heartbeatTimer&&clearTimeout(n.heartbeatTimer))}}),ne.util.on(window,"online",function(){if(ne.util.debug(new Date+" Atmosphere: online event"),0<r.length)for(var e=0;e<r.length;e++)r[e].request.handleOnlineOffline&&(r[e].init(),r[e].execute());oe=!1}),ne});
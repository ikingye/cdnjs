"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EventListeners=void 0;const Enums_1=require("../Enums"),Constants_1=require("./Constants");class EventListeners{constructor(e){this.container=e,this.canPush=!0,this.mouseMoveHandler=(e=>this.mouseTouchMove(e)),this.touchStartHandler=(e=>this.mouseTouchMove(e)),this.touchMoveHandler=(e=>this.mouseTouchMove(e)),this.touchEndHandler=(()=>this.mouseTouchFinish()),this.mouseLeaveHandler=(()=>this.mouseTouchFinish()),this.touchCancelHandler=(()=>this.mouseTouchFinish()),this.touchEndClickHandler=(e=>this.mouseTouchClick(e)),this.mouseUpHandler=(e=>this.mouseTouchClick(e)),this.visibilityChangeHandler=(()=>this.handleVisibilityChange()),this.resizeHandler=(()=>this.handleWindowResize())}static manageListener(e,t,n,i,s){if(i){let i={passive:!0};"boolean"==typeof s?i.capture=s:void 0!==s&&(i=s),e.addEventListener(t,n,i)}else{const i=s;e.removeEventListener(t,n,i)}}addListeners(){this.manageListeners(!0)}removeListeners(){this.manageListeners(!1)}manageListeners(e){const t=this.container,n=t.options,i=n.interactivity.detectsOn;i===Enums_1.InteractivityDetect.window?t.interactivity.element=window:i===Enums_1.InteractivityDetect.parent&&t.canvas.element?t.interactivity.element=t.canvas.element.parentNode:t.interactivity.element=t.canvas.element;const s=t.interactivity.element;s&&(n.interactivity.events.onHover.enable||n.interactivity.events.onClick.enable)&&(EventListeners.manageListener(s,Constants_1.Constants.mouseMoveEvent,this.mouseMoveHandler,e),EventListeners.manageListener(s,Constants_1.Constants.touchStartEvent,this.touchStartHandler,e),EventListeners.manageListener(s,Constants_1.Constants.touchMoveEvent,this.touchMoveHandler,e),n.interactivity.events.onClick.enable||EventListeners.manageListener(s,Constants_1.Constants.touchEndEvent,this.touchEndHandler,e),EventListeners.manageListener(s,Constants_1.Constants.mouseLeaveEvent,this.mouseLeaveHandler,e),EventListeners.manageListener(s,Constants_1.Constants.touchCancelEvent,this.touchCancelHandler,e)),n.interactivity.events.onClick.enable&&s&&(EventListeners.manageListener(s,Constants_1.Constants.touchEndEvent,this.touchEndClickHandler,e),EventListeners.manageListener(s,Constants_1.Constants.mouseUpEvent,this.mouseUpHandler,e)),n.interactivity.events.resize&&EventListeners.manageListener(window,Constants_1.Constants.resizeEvent,this.resizeHandler,e),document&&EventListeners.manageListener(document,Constants_1.Constants.visibilityChangeEvent,this.visibilityChangeHandler,e,!1)}handleWindowResize(){const e=this.container,t=e.options,n=e.canvas.element;if(!n)return;const i=e.retina.pixelRatio;e.canvas.size.width=n.offsetWidth*i,e.canvas.size.height=n.offsetHeight*i,n.width=e.canvas.size.width,n.height=e.canvas.size.height,t.particles.move.enable||e.particles.redraw(),e.densityAutoParticles();for(const[,t]of e.plugins)void 0!==t.resize&&t.resize()}handleVisibilityChange(){const e=this.container;e.options.pauseOnBlur&&((null===document||void 0===document?void 0:document.hidden)?(e.pageHidden=!0,e.pause()):(e.pageHidden=!1,e.getAnimationStatus()?e.play(!0):e.draw()))}mouseTouchMove(e){var t,n,i;const s=this.container,o=s.options;let a;const c=s.canvas.element;if(e.type.startsWith("mouse")){this.canPush=!0;const n=e;if(void 0===(null===(t=s.interactivity)||void 0===t?void 0:t.element))return;if(s.interactivity.element===window){if(c){const e=c.getBoundingClientRect();a={x:n.clientX-e.left,y:n.clientY-e.top}}}else if(o.interactivity.detectsOn===Enums_1.InteractivityDetect.parent){const e=n.target,t=n.currentTarget;if(e&&t){const i=e.getBoundingClientRect(),s=t.getBoundingClientRect();a={x:n.offsetX+i.left-s.left,y:n.offsetY+i.top-s.top}}else a={x:n.offsetX||n.clientX,y:n.offsetY||n.clientY}}else n.target===s.canvas.element&&(a={x:n.offsetX||n.clientX,y:n.offsetY||n.clientY})}else{this.canPush="touchmove"!==e.type;const t=e,s=t.touches[t.touches.length-1],o=null==c?void 0:c.getBoundingClientRect();a={x:s.clientX-(null!==(n=null==o?void 0:o.left)&&void 0!==n?n:0),y:s.clientY-(null!==(i=null==o?void 0:o.top)&&void 0!==i?i:0)}}const r=s.retina.pixelRatio;a&&(a.x*=r,a.y*=r),s.interactivity.mouse.position=a,s.interactivity.status=Constants_1.Constants.mouseMoveEvent}mouseTouchFinish(){const e=this.container;delete e.interactivity.mouse.position,e.interactivity.status=Constants_1.Constants.mouseLeaveEvent}mouseTouchClick(e){const t=this.container,n=t.options;let i=!1;const s=t.interactivity.mouse.position;if(void 0!==s&&n.interactivity.events.onClick.enable){for(const[,e]of t.plugins)if(void 0!==e.clickPositionValid&&(i=e.clickPositionValid(s)))break;i||this.doMouseTouchClick(e)}}doMouseTouchClick(e){const t=this.container,n=t.options;if(this.canPush){const e=t.interactivity.mouse.position;if(!e)return;t.interactivity.mouse.clickPosition={x:e.x,y:e.y},t.interactivity.mouse.clickTime=(new Date).getTime();const i=n.interactivity.events.onClick;if(i.mode instanceof Array)for(const e of i.mode)this.handleClickMode(e);else this.handleClickMode(i.mode)}"touchend"===e.type&&setTimeout(()=>this.mouseTouchFinish(),500)}handleClickMode(e){const t=this.container,n=t.options,i=n.interactivity.modes.push.quantity,s=n.interactivity.modes.remove.quantity;switch(e){case Enums_1.ClickMode.push:i>0&&(n.particles.move.enable?t.particles.push(i,t.interactivity.mouse):1===i?t.particles.push(i,t.interactivity.mouse):i>1&&t.particles.push(i));break;case Enums_1.ClickMode.remove:t.particles.removeQuantity(s);break;case Enums_1.ClickMode.bubble:t.bubble.clicking=!0;break;case Enums_1.ClickMode.repulse:t.repulse.clicking=!0,t.repulse.count=0;for(const e of t.repulse.particles)e.velocity.horizontal=e.initialVelocity.horizontal,e.velocity.vertical=e.initialVelocity.vertical;t.repulse.particles=[],t.repulse.finish=!1,setTimeout(()=>{t.destroyed||(t.repulse.clicking=!1)},1e3*n.interactivity.modes.repulse.duration);break;case Enums_1.ClickMode.pause:t.getAnimationStatus()?t.pause():t.play()}for(const[,n]of t.plugins)n.handleClickMode&&n.handleClickMode(e)}}exports.EventListeners=EventListeners;
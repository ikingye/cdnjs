"use strict";var __awaiter=this&&this.__awaiter||function(t,i,s,e){return new(s||(s=Promise))(function(n,a){function r(t){try{h(e.next(t))}catch(t){a(t)}}function o(t){try{h(e.throw(t))}catch(t){a(t)}}function h(t){var i;t.done?n(t.value):(i=t.value,i instanceof s?i:new s(function(t){t(i)})).then(r,o)}h((e=e.apply(t,i||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Container=void 0;const Canvas_1=require("./Canvas"),Particles_1=require("./Particles"),Retina_1=require("./Retina"),FrameManager_1=require("./FrameManager"),Options_1=require("../Options/Classes/Options"),Utils_1=require("../Utils");class Container{constructor(t,i,...s){this.id=t,this.sourceOptions=i,this.started=!1,this.destroyed=!1,this.paused=!0,this.lastFrameTime=0,this.pageHidden=!1,this.retina=new Retina_1.Retina(this),this.canvas=new Canvas_1.Canvas(this),this.particles=new Particles_1.Particles(this),this.drawer=new FrameManager_1.FrameManager(this),this.noise={generate:()=>({angle:Math.random()*Math.PI*2,length:Math.random()}),init:()=>{},update:()=>{}},this.interactivity={mouse:{}},this.bubble={},this.repulse={particles:[]},this.plugins=new Map,this.drawers=new Map,this.density=1,this.options=new Options_1.Options;for(const t of s)this.options.load(Utils_1.Plugins.getPreset(t));const e=Utils_1.Plugins.getSupportedShapes();for(const t of e){const i=Utils_1.Plugins.getShapeDrawer(t);i&&this.drawers.set(t,i)}this.sourceOptions&&this.options.load(this.sourceOptions),this.eventListeners=new Utils_1.EventListeners(this)}play(t){const i=this.paused||t;if(this.paused&&(this.paused=!1),i){for(const[,t]of this.plugins)t.play&&t.play();this.lastFrameTime=performance.now()}this.draw()}pause(){if(void 0!==this.drawAnimationFrame&&(Utils_1.Utils.cancelAnimation(this.drawAnimationFrame),delete this.drawAnimationFrame),!this.paused){for(const[,t]of this.plugins)t.pause&&t.pause();this.pageHidden||(this.paused=!0)}}draw(){this.drawAnimationFrame=Utils_1.Utils.animate(t=>{var i;return null===(i=this.drawer)||void 0===i?void 0:i.nextFrame(t)})}getAnimationStatus(){return!this.paused}setNoise(t,i,s){t&&("function"==typeof t?(this.noise.generate=t,i&&(this.noise.init=i),s&&(this.noise.update=s)):(t.generate&&(this.noise.generate=t.generate),t.init&&(this.noise.init=t.init),t.update&&(this.noise.update=t.update)))}densityAutoParticles(){this.initDensityFactor();const t=this.options.particles.number,i=t.value,s=t.limit>0?t.limit:i,e=Math.min(i,s)*this.density,n=this.particles.count;n<e?this.particles.push(Math.abs(e-n)):n>e&&this.particles.removeQuantity(n-e)}destroy(){this.stop(),this.canvas.destroy(),delete this.interactivity,delete this.options,delete this.retina,delete this.canvas,delete this.particles,delete this.bubble,delete this.repulse,delete this.drawer,delete this.eventListeners;for(const[,t]of this.drawers)t.destroy&&t.destroy(this);this.drawers=new Map,this.destroyed=!0}exportImg(t){this.exportImage(t)}exportImage(t,i,s){var e;return null===(e=this.canvas.element)||void 0===e?void 0:e.toBlob(t,null!=i?i:"image/png",s)}exportConfiguration(){return JSON.stringify(this.options,void 0,2)}refresh(){return __awaiter(this,void 0,void 0,function*(){this.stop(),yield this.start()})}stop(){if(this.started){this.started=!1,this.eventListeners.removeListeners(),this.pause(),this.particles.clear(),this.canvas.clear();for(const[,t]of this.plugins)t.stop&&t.stop();this.plugins=new Map,this.particles.linksColors={},delete this.particles.linksColor}}start(){return __awaiter(this,void 0,void 0,function*(){if(!this.started){yield this.init(),this.started=!0,this.eventListeners.addListeners();for(const[,t]of this.plugins)void 0!==t.startAsync?yield t.startAsync():void 0!==t.start&&t.start();this.play()}})}init(){return __awaiter(this,void 0,void 0,function*(){this.retina.init(),this.canvas.init();const t=Utils_1.Plugins.getAvailablePlugins(this);for(const[i,s]of t)this.plugins.set(i,s);for(const[,t]of this.drawers)t.init&&(yield t.init(this));for(const[,t]of this.plugins)t.init?t.init(this.options):void 0!==t.initAsync&&(yield t.initAsync(this.options));this.particles.init(),this.densityAutoParticles()})}initDensityFactor(){const t=this.options.particles.number.density;if(!this.canvas.element||!t.enable)return;const i=this.canvas.element,s=this.retina.pixelRatio;this.density=i.width*i.height/(t.factor*s*t.area)}}exports.Container=Container;
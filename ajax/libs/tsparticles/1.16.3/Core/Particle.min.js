"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Particle=void 0;const Updater_1=require("./Particle/Updater"),Particles_1=require("../Options/Classes/Particles/Particles"),Shape_1=require("../Options/Classes/Particles/Shape/Shape"),Enums_1=require("../Enums"),Utils_1=require("../Utils");class Particle{constructor(i,t,e){var s,o,a,n,l,r,c,h,p,d,u,m,v,f,y,g,U;this.container=i,this.fill=!0,this.close=!0,this.links=[],this.lastNoiseTime=0,this.destroyed=!1;const _=i.options,O=new Particles_1.Particles;if(O.load(_.particles),void 0!==(null==e?void 0:e.shape)){const i=null!==(s=e.shape.type)&&void 0!==s?s:O.shape.type;this.shape=i instanceof Array?Utils_1.Utils.itemFromArray(i):i;const t=new Shape_1.Shape;if(t.load(e.shape),void 0!==this.shape){const i=t.options[this.shape];void 0!==i&&(this.shapeData=Utils_1.Utils.deepExtend({},i instanceof Array?Utils_1.Utils.itemFromArray(i):i),this.fill=null!==(a=null===(o=this.shapeData)||void 0===o?void 0:o.fill)&&void 0!==a?a:this.fill,this.close=null!==(l=null===(n=this.shapeData)||void 0===n?void 0:n.close)&&void 0!==l?l:this.close)}}else{const i=O.shape.type;this.shape=i instanceof Array?Utils_1.Utils.itemFromArray(i):i;const t=O.shape.options[this.shape];t&&(this.shapeData=Utils_1.Utils.deepExtend({},t instanceof Array?Utils_1.Utils.itemFromArray(t):t),this.fill=null!==(c=null===(r=this.shapeData)||void 0===r?void 0:r.fill)&&void 0!==c?c:this.fill,this.close=null!==(p=null===(h=this.shapeData)||void 0===h?void 0:h.close)&&void 0!==p?p:this.close)}void 0!==e&&O.load(e),void 0!==(null===(d=this.shapeData)||void 0===d?void 0:d.particles)&&O.load(null===(u=this.shapeData)||void 0===u?void 0:u.particles),this.particlesOptions=O;const z=this.particlesOptions.move.noise.delay;this.noiseDelay=1e3*(z.random.enable?Utils_1.Utils.randomInRange(z.random.minimumValue,z.value):z.value),i.retina.initParticle(this);const S=this.particlesOptions.color,w=null!==(m=this.sizeValue)&&void 0!==m?m:i.retina.sizeValue,b="boolean"==typeof this.particlesOptions.size.random?this.particlesOptions.size.random:this.particlesOptions.size.random.enable;if(this.size={value:b&&void 0!==this.randomMinimumSize?Utils_1.Utils.randomInRange(this.randomMinimumSize,w):w},this.direction=this.particlesOptions.move.direction,this.bubble={inRange:!1},this.angle=this.particlesOptions.rotate.random?360*Math.random():this.particlesOptions.rotate.value,this.particlesOptions.rotate.direction===Enums_1.RotateDirection.random){const i=Math.floor(2*Math.random());this.rotateDirection=i>0?Enums_1.RotateDirection.counterClockwise:Enums_1.RotateDirection.clockwise}else this.rotateDirection=this.particlesOptions.rotate.direction;if(this.particlesOptions.size.animation.enable){switch(this.particlesOptions.size.animation.startValue){case Enums_1.StartValueType.min:if(!b){const t=i.retina.pixelRatio;this.size.value=this.particlesOptions.size.animation.minimumValue*t}}this.size.status=Enums_1.SizeAnimationStatus.increasing,this.size.velocity=(null!==(v=this.sizeAnimationSpeed)&&void 0!==v?v:i.retina.sizeAnimationSpeed)/100,this.particlesOptions.size.animation.sync||(this.size.velocity=this.size.velocity*Math.random())}this.particlesOptions.color.animation.enable?(this.colorVelocity=this.particlesOptions.color.animation.speed/100,this.particlesOptions.color.animation.sync||(this.colorVelocity=this.colorVelocity*Math.random())):this.colorVelocity=0,this.particlesOptions.rotate.animation.enable&&(this.particlesOptions.rotate.animation.sync||(this.angle=360*Math.random())),this.position=this.calcPosition(this.container,t),this.offset={x:0,y:0},this.particlesOptions.collisions.enable&&this.checkOverlap(t),this.color=Utils_1.ColorUtils.colorToHsl(S);const D=this.particlesOptions.opacity.random,x=this.particlesOptions.opacity.value;this.opacity={value:D.enable?Utils_1.Utils.randomInRange(D.minimumValue,x):x},this.particlesOptions.opacity.animation.enable&&(this.opacity.status=Enums_1.OpacityAnimationStatus.increasing,this.opacity.velocity=this.particlesOptions.opacity.animation.speed/100,this.particlesOptions.opacity.animation.sync||(this.opacity.velocity*=Math.random())),this.initialVelocity=this.calculateVelocity(),this.velocity={horizontal:this.initialVelocity.horizontal,vertical:this.initialVelocity.vertical};let M=i.drawers.get(this.shape);if(M||(M=Utils_1.Plugins.getShapeDrawer(this.shape))&&i.drawers.set(this.shape,M),this.shape===Enums_1.ShapeType.image||this.shape===Enums_1.ShapeType.images){const t=M,e=this.particlesOptions.shape.options[this.shape],s=t.getImages(i).images,o=s[Utils_1.Utils.arrayRandomIndex(s)],a=e instanceof Array?e.filter(i=>i.src===o.source)[0]:e,n=this.getColor();if(void 0!==(null==o?void 0:o.svgData)&&a.replaceColor&&n){const i=Utils_1.Utils.replaceColorSvg(o,n,this.opacity.value),t=new Blob([i],{type:"image/svg+xml"}),e=window.URL||window.webkitURL||window,s=e.createObjectURL(t),l=new Image;this.image={data:o,loaded:!1,ratio:a.width/a.height,replaceColor:null!==(f=a.replaceColor)&&void 0!==f?f:a.replace_color,source:a.src},l.addEventListener("load",()=>{this.image&&(this.image.loaded=!0,o.element=l),e.revokeObjectURL(s)}),l.addEventListener("error",()=>{e.revokeObjectURL(s),Utils_1.Utils.loadImage(a.src).then(i=>{this.image&&(o.element=i.element,this.image.loaded=!0)})}),l.src=s}else this.image={data:o,loaded:!0,ratio:a.width/a.height,replaceColor:null!==(y=a.replaceColor)&&void 0!==y?y:a.replace_color,source:a.src};this.image.ratio||(this.image.ratio=1),this.fill=null!==(g=a.fill)&&void 0!==g?g:this.fill,this.close=null!==(U=a.close)&&void 0!==U?U:this.close}this.stroke=this.particlesOptions.stroke instanceof Array?Utils_1.Utils.itemFromArray(this.particlesOptions.stroke):this.particlesOptions.stroke,this.strokeColor=Utils_1.ColorUtils.colorToRgb(this.stroke.color),this.shadowColor=Utils_1.ColorUtils.colorToRgb(this.particlesOptions.shadow.color),this.updater=new Updater_1.Updater(this.container,this)}update(i){this.links=[],this.updater.update(i)}draw(i){var t;!1!==(null===(t=this.image)||void 0===t?void 0:t.loaded)&&this.container.canvas.drawParticle(this,i)}isOverlapping(){const i=this.container;let t=!1,e=0;const s=this.getPosition();for(const o of i.particles.array.filter(i=>i!=this)){e++;const i=o.getPosition();if(Utils_1.Utils.getDistance(s,i)<=this.size.value+o.size.value){t=!0;break}}return{collisionFound:t,iterations:e}}checkOverlap(i){const t=this.container,e=this.isOverlapping();e.iterations>=t.particles.count?t.particles.remove(this):e.collisionFound&&(this.position.x=i?i.x:Math.random()*t.canvas.size.width,this.position.y=i?i.y:Math.random()*t.canvas.size.height,this.checkOverlap())}startInfection(i){i>this.container.options.infection.stages.length||i<0||(this.infectionDelay=0,this.infectionDelayStage=i)}updateInfectionStage(i){i>this.container.options.infection.stages.length||i<0||void 0!==this.infectionStage&&this.infectionStage>i||(void 0!==this.infectionTimeout&&window.clearTimeout(this.infectionTimeout),this.infectionStage=i,this.infectionTime=0)}updateInfection(i){const t=this.container.options,e=t.infection,s=t.infection.stages,o=s.length;if(void 0!==this.infectionDelay&&void 0!==this.infectionDelayStage){const t=this.infectionDelayStage;if(t>o||t<0)return;this.infectionDelay>1e3*e.delay?(this.infectionStage=t,this.infectionTime=0,delete this.infectionDelay,delete this.infectionDelayStage):this.infectionDelay+=i}else delete this.infectionDelay,delete this.infectionDelayStage;if(void 0!==this.infectionStage&&void 0!==this.infectionTime){const t=s[this.infectionStage];void 0!==t.duration&&t.duration>=0&&this.infectionTime>1e3*t.duration?this.nextInfectionStage():this.infectionTime+=i}else delete this.infectionStage,delete this.infectionTime}getPosition(){return{x:this.position.x+this.offset.x,y:this.position.y+this.offset.y}}getColor(){var i;return null!==(i=this.bubble.color)&&void 0!==i?i:this.color}destroy(){this.destroyed=!0}nextInfectionStage(){const i=this.container.options,t=i.infection.stages.length;if(!(t<=0||void 0===this.infectionStage)&&(this.infectionTime=0,t<=++this.infectionStage)){if(i.infection.cure)return delete this.infectionStage,void delete this.infectionTime;this.infectionStage=0,this.infectionTime=0}}calcPosition(i,t){var e,s;for(const[,e]of i.plugins){const i=void 0!==e.particlePosition?e.particlePosition(t,this):void 0;if(void 0!==i)return Utils_1.Utils.deepExtend({},i)}const o={x:null!==(e=null==t?void 0:t.x)&&void 0!==e?e:Math.random()*i.canvas.size.width,y:null!==(s=null==t?void 0:t.y)&&void 0!==s?s:Math.random()*i.canvas.size.height},a=this.particlesOptions.move.outMode;return(Utils_1.Utils.isInArray(a,Enums_1.OutMode.bounce)||Utils_1.Utils.isInArray(a,Enums_1.OutMode.bounceHorizontal))&&(o.x>i.canvas.size.width-2*this.size.value?o.x-=this.size.value:o.x<2*this.size.value&&(o.x+=this.size.value)),(Utils_1.Utils.isInArray(a,Enums_1.OutMode.bounce)||Utils_1.Utils.isInArray(a,Enums_1.OutMode.bounceVertical))&&(o.y>i.canvas.size.height-2*this.size.value?o.y-=this.size.value:o.y<2*this.size.value&&(o.y+=this.size.value)),o}calculateVelocity(){const i=Utils_1.Utils.getParticleBaseVelocity(this),t={horizontal:0,vertical:0},e=this.particlesOptions.move,s=Math.PI/180*e.angle,o=Math.PI/4,a={left:Math.sin(o+s/2)-Math.sin(o-s/2),right:Math.cos(o+s/2)-Math.cos(o-s/2)};return e.straight?(t.horizontal=i.x,t.vertical=i.y,e.random&&(t.horizontal+=Utils_1.Utils.randomInRange(a.left,a.right)/2,t.vertical+=Utils_1.Utils.randomInRange(a.left,a.right)/2)):(t.horizontal=i.x+Utils_1.Utils.randomInRange(a.left,a.right)/2,t.vertical=i.y+Utils_1.Utils.randomInRange(a.left,a.right)/2),t}}exports.Particle=Particle;
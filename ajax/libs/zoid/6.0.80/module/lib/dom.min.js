var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};import{isWindowClosed,linkFrameWindow}from"cross-domain-utils/src";import{ZalgoPromise}from"zalgo-promise/src";import{WeakMap}from"cross-domain-safe-weakmap/src";import{PopupOpenError}from"../error";import{once,memoize,debounce}from"./fn";import{extend,safeInterval,urlEncode,capitalizeFirstLetter,stringify}from"./util";export function appendChild(e,t){e.appendChild(t)};function isElement(e){return e instanceof window.Element||null!==e&&"object"===(void 0===e?"undefined":_typeof(e))&&1===e.nodeType&&"object"===_typeof(e.style)&&"object"===_typeof(e.ownerDocument)}export function querySelectorAll(e,t){return Array.prototype.slice.call(e.querySelectorAll(t))};export function getElementSafe(e){if(isElement(e))return e;if("string"==typeof e){var t=document.getElementById(e);if(t)return t;if(document.querySelector&&(t=document.querySelector(e)),t)return t}};export function getElement(e){var t=getElementSafe(e);if(t)return t;throw new Error("Can not find element: "+stringify(e))};export var documentReady=new ZalgoPromise(function(e){if("complete"===window.document.readyState)return e(window.document);var t=setInterval(function(){if("complete"===window.document.readyState)return clearInterval(t),e(window.document)},10)});export function isDocumentReady(){return"complete"===window.document.readyState};export function elementReady(e){return new ZalgoPromise(function(t,n){var r=stringify(e),o=getElementSafe(e);if(o)return t(o);if(isDocumentReady())return n(new Error("Document is ready and element "+r+" does not exist"));var i=setInterval(function(){return(o=getElementSafe(e))?(clearInterval(i),t(o)):isDocumentReady()?(clearInterval(i),n(new Error("Document is ready and element "+r+" does not exist"))):void 0},10)})};export function popup(e,t){var n,r=Object.keys(t).map(function(e){if(t[e])return e+"="+stringify(t[e])}).filter(Boolean).join(","),o=void 0;try{o=window.open(e,t.name,r,!0)}catch(n){throw new PopupOpenError("Can not open popup window - "+(n.stack||n.message))}if(isWindowClosed(o))throw new PopupOpenError("Can not open popup window - blocked");return o};export function writeToWindow(e,t){try{e.document.open(),e.document.write(t),e.document.close()}catch(n){try{e.location="javascript: document.open(); document.write("+JSON.stringify(t)+"); document.close();"}catch(e){}}};export function writeElementToWindow(e,t){var n=t.tagName.toLowerCase();if("html"!==n)throw new Error("Expected element to be html, got "+n);for(var r=e.document.documentElement;r.children&&r.children.length;)r.removeChild(r.children[0]);for(;t.children.length;)r.appendChild(t.children[0])};export function setStyle(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:window.document;e.styleSheet?e.styleSheet.cssText=t:e.appendChild(n.createTextNode(t))};export function createElement(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2];e=e.toLowerCase();var r=document.createElement(e);if(t.style&&extend(r.style,t.style),t.class&&(r.className=t.class.join(" ")),t.attributes)for(var o=0,i=Object.keys(t.attributes),a=null==i?0:i.length;o<a;o++){var s=i[o];r.setAttribute(s,t.attributes[s])}if(t.styleSheet&&setStyle(r,t.styleSheet),n&&appendChild(n,r),t.html)if("iframe"===e){if(!n||!r.contentWindow)throw new Error("Iframe html can not be written unless container provided and iframe in DOM");writeToWindow(r.contentWindow,t.html)}else r.innerHTML=t.html;return r};var awaitFrameLoadPromises=new WeakMap;export function awaitFrameLoad(e){if(awaitFrameLoadPromises.has(e)){var t=awaitFrameLoadPromises.get(e);if(t)return t}var n=new ZalgoPromise(function(t,n){e.addEventListener("load",function(){linkFrameWindow(e),t(e)}),e.addEventListener("error",function(r){e.contentWindow?t(e):n(r)})});return awaitFrameLoadPromises.set(e,n),n};export function awaitFrameWindow(e){return e.contentWindow?ZalgoPromise.resolve(e.contentWindow):awaitFrameLoad(e).then(function(e){if(!e.contentWindow)throw new Error("Could not find window in iframe");return e.contentWindow})};export function iframe(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=getElement(arguments[1]),n=e.attributes||{},r=e.style||{},o=createElement("iframe",{attributes:_extends({frameBorder:"0",allowTransparency:"true"},n),style:_extends({backgroundColor:"transparent"},r),html:e.html,class:e.class});return awaitFrameLoad(o),t.appendChild(o),(e.url||window.navigator.userAgent.match(/MSIE|Edge/i))&&o.setAttribute("src",e.url||"about:blank"),o};export function addEventListener(e,t,n){return e.addEventListener(t,n),{cancel:function(){e.removeEventListener(t,n)}}};export function scanForJavascript(e){if(!e)return e;if(e.match(/<script|on\w+\s*=|javascript:|expression\s*\(|eval\(|new\s*Function/))throw new Error("HTML contains potential javascript: "+e);return e};export var parseQuery=memoize(function(e){var t={};if(!e)return t;if(-1===e.indexOf("="))throw new Error("Can not parse query string params: "+e);for(var n=0,r=e.split("&"),o=null==r?0:r.length;n<o;n++){var i=r[n];(i=i.split("="))[0]&&i[1]&&(t[decodeURIComponent(i[0])]=decodeURIComponent(i[1]))}return t});export function getQueryParam(e){return parseQuery(window.location.search.slice(1))[e]};export function formatQuery(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(e).filter(function(t){return"string"==typeof e[t]}).map(function(t){return urlEncode(t)+"="+urlEncode(e[t])}).join("&")};export function extendQuery(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t&&Object.keys(t).length?formatQuery(_extends({},parseQuery(e),t)):e};export function extendUrl(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.query||{},o=n.hash||{},i=void 0,a=e.split("#");i=a[0],t=a[1];var s=i.split("?");i=s[0];var l=extendQuery(s[1],r),c=extendQuery(t,o);return l&&(i=i+"?"+l),c&&(i=i+"#"+c),i};export function elementStoppedMoving(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return new ZalgoPromise(function(n,r){var o=getElement(e),i=o.getBoundingClientRect(),a=void 0,s=void 0;a=setInterval(function(){var e=o.getBoundingClientRect();if(i.top===e.top&&i.bottom===e.bottom&&i.left===e.left&&i.right===e.right&&i.width===e.width&&i.height===e.height)return clearTimeout(s),clearInterval(a),n();i=e},50),s=setTimeout(function(){clearInterval(a),r(new Error("Timed out waiting for element to stop animating after "+t+"ms"))},t)})};export function getCurrentDimensions(e){return{width:e.offsetWidth,height:e.offsetHeight}};export function changeStyle(e,t){return new ZalgoPromise(function(n){for(var r=0,o=Object.keys(t),i=null==o?0:o.length;r<i;r++){var a=o[r];e.style[a]=t[a]}setTimeout(n,1)})};export function setOverflow(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"auto",n=e.style,r=n.overflow,o=n.overflowX,i=n.overflowY;return e.style.overflow=e.style.overflowX=e.style.overflowY=t,{reset:function(){e.style.overflow=r,e.style.overflowX=o,e.style.overflowY=i}}};function dimensionsDiff(e,t,n){var r=n.width,o=void 0===r||r,i=n.height,a=void 0===i||i,s=n.threshold,l=void 0===s?0:s;return!!(o&&Math.abs(e.width-t.width)>l)||!!(a&&Math.abs(e.height-t.height)>l)}export function trackDimensions(e,t){var n=t.width,r=void 0===n||n,o=t.height,i=void 0===o||o,a=t.threshold,s=void 0===a?0:a,l=getCurrentDimensions(e);return{check:function(){var t=getCurrentDimensions(e);return{changed:dimensionsDiff(l,t,{width:r,height:i,threshold:s}),dimensions:t}},reset:function(){l=getCurrentDimensions(e)}}};export function onDimensionsChange(e,t){var n=t.width,r=void 0===n||n,o=t.height,i=void 0===o||o,a=t.delay,s=void 0===a?50:a,l=t.threshold,c=void 0===l?0:l;return new ZalgoPromise(function(t){var n=trackDimensions(e,{width:r,height:i,threshold:c}),o=void 0,a=debounce(function(e){return clearInterval(o),t(e)},4*s);o=setInterval(function(){var e=n.check(),t=e.changed,r=e.dimensions;if(t)return n.reset(),a(r)},s),window.addEventListener("resize",function e(){var t=n.check(),r=t.changed,o=t.dimensions;r&&(n.reset(),window.removeEventListener("resize",e),a(o))})})};export function dimensionsMatchViewport(e,t){var n=t.width,r=t.height,o=getCurrentDimensions(e);return(!n||o.width===window.innerWidth)&&(!r||o.height===window.innerHeight)};export function bindEvents(e,t,n){n=once(n);for(var r=0,o=null==t?0:t.length;r<o;r++){var i=t[r];e.addEventListener(i,n)}return{cancel:once(function(){for(var r=0,o=null==t?0:t.length;r<o;r++){var i=t[r];e.removeEventListener(i,n)}})}};var VENDOR_PREFIXES=["webkit","moz","ms","o"];export function setVendorCSS(e,t,n){e.style[t]=n;for(var r=capitalizeFirstLetter(t),o=0,i=null==VENDOR_PREFIXES?0:VENDOR_PREFIXES.length;o<i;o++){var a=VENDOR_PREFIXES[o];e.style[""+a+r]=n}};var CSSRule=window.CSSRule,KEYFRAMES_RULE=CSSRule.KEYFRAMES_RULE||CSSRule.WEBKIT_KEYFRAMES_RULE||CSSRule.MOZ_KEYFRAMES_RULE||CSSRule.O_KEYFRAMES_RULE||CSSRule.MS_KEYFRAMES_RULE;function isValidAnimation(e,t){var n=e.ownerDocument.styleSheets;try{for(var r=0;r<n.length;r++){var o=n[r].cssRules;if(o)for(var i=0;i<o.length;i++){var a=o[i];if(a&&(a.type===KEYFRAMES_RULE&&a.name===t))return!0}}}catch(e){return!1}return!1}var ANIMATION_START_EVENTS=["animationstart","webkitAnimationStart","oAnimationStart","MSAnimationStart"],ANIMATION_END_EVENTS=["animationend","webkitAnimationEnd","oAnimationEnd","MSAnimationEnd"];export function animate(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e3;return new ZalgoPromise(function(o,i){var a=getElement(e);if(!a||!isValidAnimation(a,t))return o();var s=!1,l=void 0,c=void 0,d=void 0,u=void 0;function f(){setVendorCSS(a,"animationName",""),clearTimeout(l),clearTimeout(c),d.cancel(),u.cancel()}d=bindEvents(a,ANIMATION_START_EVENTS,function(e){e.target===a&&e.animationName===t&&(clearTimeout(l),e.stopPropagation(),d.cancel(),s=!0,c=setTimeout(function(){f(),o()},r))}),u=bindEvents(a,ANIMATION_END_EVENTS,function(e){if(e.target===a&&e.animationName===t)return f(),"string"==typeof e.animationName&&e.animationName!==t?i("Expected animation name to be "+t+", found "+e.animationName):o()}),setVendorCSS(a,"animationName",t),l=setTimeout(function(){if(!s)return f(),o()},200),n&&n(f)})};var STYLE={DISPLAY:{NONE:"none",BLOCK:"block"},VISIBILITY:{VISIBLE:"visible",HIDDEN:"hidden"},IMPORTANT:"important"};export function makeElementVisible(e){e.style.setProperty("visibility","")};export function makeElementInvisible(e){e.style.setProperty("visibility",STYLE.VISIBILITY.HIDDEN,STYLE.IMPORTANT)};export function showElement(e){e.style.setProperty("display","")};export function hideElement(e){e.style.setProperty("display",STYLE.DISPLAY.NONE,STYLE.IMPORTANT)};export function destroyElement(e){e.parentNode&&e.parentNode.removeChild(e)};export function showAndAnimate(e,t,n){var r=animate(e,t,n);return showElement(e),r};export function animateAndHide(e,t,n){return animate(e,t,n).then(function(){hideElement(e)})};export function addClass(e,t){e.classList?e.classList.add(t):-1===e.className.split(/\s+/).indexOf(t)&&(e.className+=" "+t)};export function removeClass(e,t){e.classList?e.classList.remove(t):-1!==e.className.split(/\s+/).indexOf(t)&&(e.className=e.className.replace(t,""))};export function getCurrentScriptDir(){return console.warn("Do not use zoid.getCurrentScriptDir() in production -- browser support is limited"),document.currentScript?document.currentScript.src.split("/").slice(0,-1).join("/"):"."};export function getElementName(e){if("string"==typeof e)return e;if(!e||!e.tagName)return"<unknown>";var t=e.tagName.toLowerCase();return e.id?t+="#"+e.id:e.className&&(t+="."+e.className.split(" ").join(".")),t};export function isElementClosed(e){return!e||!e.parentNode};export function watchElementForClose(e,t){t=once(t);var n=void 0;return isElementClosed(e)?t():n=safeInterval(function(){isElementClosed(e)&&(n.cancel(),t())},50),{cancel:function(){n&&n.cancel()}}};export function getHttpType(e,t){return new ZalgoPromise(function(n,r){var o=new window.XMLHttpRequest;o.open("GET",t),o.setRequestHeader("Accept",e),o.send(null),o.onload=function(){n(o.responseText)},o.onerror=function(){return r(new Error("prefetch failed"))}})};export function getHTML(e){return getHttpType("text/html",e)};export function getCSS(e){return getHttpType("text/css",e)};export function getScript(e){return getHttpType("*/*",e)};export function prefetchPage(e){return getHTML(e)};var JSX_EVENTS={onClick:"click"};export function fixScripts(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:window.document,n=0,r=querySelectorAll(e,"script"),o=null==r?0:r.length;n<o;n++){var i=r[n],a=t.createElement("script");a.text=i.textContent,i.parentNode.replaceChild(a,i)}};export function jsxDom(e,t,n){e=e.toLowerCase();var r=this&&this.createElement?this:window.document,o=r.createElement(e);for(var i in t)i in JSX_EVENTS?o.addEventListener(JSX_EVENTS[i],t[i]):"innerHTML"===i?(o.innerHTML=t[i],fixScripts(o,r)):o.setAttribute(i,t[i]);if("style"===e){if("string"!=typeof n)throw new TypeError("Expected "+e+" tag content to be string, got "+(void 0===n?"undefined":_typeof(n)));if(arguments.length>3)throw new Error("Expected only text content for "+e+" tag");setStyle(o,n,r)}else if("iframe"===e){if(arguments.length>3)throw new Error("Expected only single child node for iframe");o.addEventListener("load",function(){var e=o.contentWindow;if(!e)throw new Error("Expected frame to have contentWindow");"string"==typeof n?writeToWindow(e,n):writeElementToWindow(e,n)})}else if("script"===e){if("string"!=typeof n)throw new TypeError("Expected "+e+" tag content to be string, got "+(void 0===n?"undefined":_typeof(n)));if(arguments.length>3)throw new Error("Expected only text content for "+e+" tag");o.text=n}else for(var a=2;a<arguments.length;a++)if("string"==typeof arguments[a]){var s=r.createTextNode(arguments[a]);appendChild(o,s)}else appendChild(o,arguments[a]);return o};
var _extends=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e};import{ZalgoPromise}from"zalgo-promise/src";import{cleanUpWindow}from"post-robot/src";import{findFrameByName,isSameDomain}from"cross-domain-utils/src";import{iframe,popup,toCSS,showElement,hideElement,destroyElement,normalizeDimension,watchElementForClose,awaitFrameWindow,addClass,removeClass,noop}from"../../lib";import{CONTEXT_TYPES,DELEGATE,CLOSE_REASONS,CLASS_NAMES,DEFAULT_DIMENSIONS}from"../../constants";import{getPosition,getParentComponentWindow}from"../window";export var RENDER_DRIVERS={};RENDER_DRIVERS[CONTEXT_TYPES.IFRAME]={focusable:!1,renderedIntoContainerTemplate:!0,allowResize:!0,openOnClick:!1,needsBridge:!1,open:function(e){var n=this,t=this.component.attributes.iframe||{};return this.iframe=iframe({url:e,attributes:_extends({name:this.childWindowName,title:this.component.name,scrolling:this.component.scrolling?"yes":"no"},t),class:[CLASS_NAMES.COMPONENT_FRAME,CLASS_NAMES.INVISIBLE]},this.element),awaitFrameWindow(this.iframe).then(function(e){n.window=e;var t=function(){return ZalgoPromise.try(function(){return n.props.onClose(CLOSE_REASONS.CLOSE_DETECTED)}).finally(function(){return n.destroy()})},o=watchElementForClose(n.iframe,t),r=watchElementForClose(n.element,t);n.clean.register("destroyWindow",function(){o.cancel(),r.cancel(),cleanUpWindow(n.window),delete n.window,n.iframe&&(destroyElement(n.iframe),delete n.iframe)})})},openPrerender:function(){var e=this,n=this.component.attributes.iframe||{};return this.prerenderIframe=iframe({attributes:_extends({name:"__prerender__"+this.childWindowName,scrolling:this.component.scrolling?"yes":"no"},n),class:[CLASS_NAMES.PRERENDER_FRAME,CLASS_NAMES.VISIBLE]},this.element),awaitFrameWindow(this.prerenderIframe).then(function(n){e.prerenderWindow=n,e.clean.register("destroyPrerender",function(){e.prerenderIframe&&(destroyElement(e.prerenderIframe),delete e.prerenderIframe)})})},switchPrerender:function(){var e=this;addClass(this.prerenderIframe,CLASS_NAMES.INVISIBLE),removeClass(this.prerenderIframe,CLASS_NAMES.VISIBLE),addClass(this.iframe,CLASS_NAMES.VISIBLE),removeClass(this.iframe,CLASS_NAMES.INVISIBLE),setTimeout(function(){e.prerenderIframe&&destroyElement(e.prerenderIframe)},1e3)},delegateOverrides:{openContainer:DELEGATE.CALL_DELEGATE,destroyComponent:DELEGATE.CALL_DELEGATE,destroyContainer:DELEGATE.CALL_DELEGATE,cancelContainerEvents:DELEGATE.CALL_DELEGATE,createPrerenderTemplate:DELEGATE.CALL_DELEGATE,elementReady:DELEGATE.CALL_DELEGATE,showContainer:DELEGATE.CALL_DELEGATE,showComponent:DELEGATE.CALL_DELEGATE,hideContainer:DELEGATE.CALL_DELEGATE,hideComponent:DELEGATE.CALL_DELEGATE,hide:DELEGATE.CALL_DELEGATE,show:DELEGATE.CALL_DELEGATE,resize:DELEGATE.CALL_DELEGATE,loadUrl:DELEGATE.CALL_DELEGATE,hijackSubmit:DELEGATE.CALL_DELEGATE,openPrerender:DELEGATE.CALL_DELEGATE,switchPrerender:DELEGATE.CALL_DELEGATE,renderTemplate:DELEGATE.CALL_ORIGINAL,openContainerFrame:DELEGATE.CALL_ORIGINAL,getOutlet:DELEGATE.CALL_ORIGINAL,open:function(e,n){return function(){var e=this;return n.apply(this,arguments).then(function(){if(e.clean.set("window",findFrameByName(getParentComponentWindow(),e.childWindowName)),!e.window)throw new Error("Unable to find parent component iframe window")})}}},resize:function(e,n){e&&(this.container.style.width=toCSS(e),this.element.style.width=toCSS(e)),n&&(this.container.style.height=toCSS(n),this.element.style.height=toCSS(n))},show:function(){showElement(this.element)},hide:function(){hideElement(this.element)},loadUrl:function(e){this.iframe.setAttribute("src",e)}},__ZOID__.__POPUP_SUPPORT__&&(RENDER_DRIVERS[CONTEXT_TYPES.POPUP]={focusable:!0,renderedIntoContainerTemplate:!1,allowResize:!1,openOnClick:!0,needsBridge:!0,open:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return ZalgoPromise.try(function(){var t=e.component.dimensions||{},o=t.width,r=void 0===o?DEFAULT_DIMENSIONS.WIDTH:o,E=t.height,i=void 0===E?DEFAULT_DIMENSIONS.HEIGHT:E;r=normalizeDimension(r,window.outerWidth),i=normalizeDimension(i,window.outerWidth);var L=getPosition({width:r,height:i}),a=L.x,s=L.y,A=e.component.attributes.popup||{};e.window=popup(n||"",_extends({name:e.childWindowName,width:r,height:i,top:s,left:a,status:1,toolbar:0,menubar:0,resizable:1,scrollbars:1},A)),e.prerenderWindow=e.window,e.clean.register("destroyWindow",function(){e.window&&(e.window.close(),cleanUpWindow(e.window),delete e.window,delete e.prerenderWindow)}),e.resize(r,i)})},openPrerender:function(){return ZalgoPromise.try(noop)},resize:function(){},hide:function(){throw new Error("Can not hide popup")},show:function(){throw new Error("Can not show popup")},delegateOverrides:{openContainer:DELEGATE.CALL_DELEGATE,destroyContainer:DELEGATE.CALL_DELEGATE,elementReady:DELEGATE.CALL_DELEGATE,showContainer:DELEGATE.CALL_DELEGATE,showComponent:DELEGATE.CALL_DELEGATE,hideContainer:DELEGATE.CALL_DELEGATE,hideComponent:DELEGATE.CALL_DELEGATE,hide:DELEGATE.CALL_DELEGATE,show:DELEGATE.CALL_DELEGATE,cancelContainerEvents:DELEGATE.CALL_DELEGATE,open:DELEGATE.CALL_ORIGINAL,loadUrl:DELEGATE.CALL_ORIGINAL,createPrerenderTemplate:DELEGATE.CALL_ORIGINAL,destroyComponent:DELEGATE.CALL_ORIGINAL,resize:DELEGATE.CALL_ORIGINAL,renderTemplate:DELEGATE.CALL_ORIGINAL,openContainerFrame:DELEGATE.CALL_ORIGINAL,getOutlet:DELEGATE.CALL_ORIGINAL},loadUrl:function(e){if(isSameDomain(this.window))try{if(this.window.location&&this.window.location.replace)return void this.window.location.replace(e)}catch(e){}this.window.location=e}});
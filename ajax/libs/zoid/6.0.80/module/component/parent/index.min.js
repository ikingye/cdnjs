var _desc,_value,_class,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _applyDecoratedDescriptor(e,t,o,n,r){var i={};return Object.keys(n).forEach(function(e){i[e]=n[e]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=o.slice().reverse().reduce(function(o,n){return n(e,t,o)||o},i),r&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(r):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(e,t,i),i=null),i}import{flush}from"beaver-logger/client";import{send,bridge}from"post-robot/src";import{isSameDomain,isWindowClosed as _isWindowClosed,isTop,isSameTopWindow,matchDomain,getDistanceFromTop,onCloseWindow,getDomain,assertSameDomain}from"cross-domain-utils/src";import{ZalgoPromise}from"zalgo-promise/src";import{getElementSafe,onResize,isShadowElement,insertShadowSlot}from"belter/src";import{BaseComponent}from"../base";import{buildChildWindowName as _buildChildWindowName,getParentDomain,getParentComponentWindow}from"../window";import{addEventListener,uniqueID,elementReady as _elementReady,writeElementToWindow,noop,showAndAnimate,animateAndHide,showElement,hideElement,addClass,extend,serializeFunctions,extendUrl,jsxDom,getElement,memoized,appendChild,global,writeToWindow,setLogLevel,once,prefetchPage,awaitFrameLoad,stringify,stringifyError}from"../../lib";import{POST_MESSAGE,CONTEXT_TYPES,CLASS_NAMES,ANIMATION_NAMES,CLOSE_REASONS,DELEGATE,INITIAL_PROPS,WINDOW_REFERENCES,EVENTS,DEFAULT_DIMENSIONS}from"../../constants";import{RenderError}from"../../error";import{RENDER_DRIVERS}from"./drivers";import{validateProps}from"./validate";import{propsToQuery,normalizeProps}from"./props";global.props=global.props||{},global.windows=global.windows||{};export var ParentComponent=(_class=function(e){function t(o,n,r){var i=r.props;_classCallCheck(this,t);var s=_possibleConstructorReturn(this,e.call(this));s.component=o,s.validateParentDomain(),s.context=n;try{s.setProps(i)}catch(e){throw i.onError&&i.onError(e),e}return s.props.logLevel&&setLogLevel(s.props.logLevel),s.childWindowName=s.buildChildWindowName({renderTo:window}),s.registerActiveComponent(),s.component.log("construct_parent"),s.watchForUnload(),s.onInit=new ZalgoPromise,s.onInit.catch(function(e){return s.error(e)}),s}return _inherits(t,e),t.prototype.render=function(e){var t=this,o=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.tryInit(function(){t.component.log("render_"+t.context,{context:t.context,element:e,loadUrl:stringify(o)});var n={};return n.onRender=t.props.onRender(),n.getDomain=t.getDomain(),n.elementReady=ZalgoPromise.try(function(){if(e)return t.elementReady(e)}),n.openContainer=n.elementReady.then(function(){return t.openContainer(e)}),n.showContainer=n.openContainer.then(function(){return t.showContainer()}),n.openPrerender=n.openContainer.then(function(){return t.openPrerender()}),n.switchPrerender=ZalgoPromise.all([n.openPrerender,t.onInit]).then(function(){return t.switchPrerender()}),n.open=t.driver.openOnClick?t.open():n.openContainer.then(function(){return t.open()}),n.listen=ZalgoPromise.hash({domain:n.getDomain,open:n.open}).then(function(e){var o=e.domain;t.listen(t.window,o)}),n.watchForClose=n.open.then(function(){return t.watchForClose()}),n.linkDomain=ZalgoPromise.all([n.getDomain,n.open]).then(function(e){var o=e[0];if(bridge&&"string"==typeof o)return bridge.linkUrl(t.window,o)}),t.html||(n.createPrerenderTemplate=n.openPrerender.then(function(){return t.createPrerenderTemplate()}),n.showComponent=n.createPrerenderTemplate.then(function(){return t.showComponent()})),n.openBridge=ZalgoPromise.all([n.getDomain,n.open]).then(function(e){var o=e[0];return t.openBridge("string"==typeof o?o:null)}),t.html?n.loadHTML=n.open.then(function(){return t.loadHTML()}):o&&(n.buildUrl=t.buildUrl(),n.loadUrl=ZalgoPromise.all([n.buildUrl,n.open,n.linkDomain,n.listen,n.open,n.openBridge,n.createPrerenderTemplate]).then(function(e){var o=e[0];return t.loadUrl(o)}),n.runTimeout=n.loadUrl.then(function(){return t.runTimeout()})),ZalgoPromise.hash(n)}).then(function(){return t.props.onEnter()}).then(function(){return t})},t.prototype.getOutlet=function(){var e=document.createElement("div");return addClass(e,CLASS_NAMES.OUTLET),e},t.prototype.validateParentDomain=function(){var e=getDomain();if(!matchDomain(this.component.allowedParentDomains,e))throw new RenderError("Can not be rendered by domain: "+e)},t.prototype.renderTo=function(e,t){var o=this;return this.tryInit(function(){if(e===window)return o.render(t);if(!isSameTopWindow(window,e))throw new Error("Can only renderTo an adjacent frame");if(t&&"string"!=typeof t)throw new Error("Element passed to renderTo must be a string selector, got "+(void 0===t?"undefined":_typeof(t))+" "+t);return o.checkAllowRenderTo(e),o.component.log("render_"+o.context+"_to_win",{element:stringify(t),context:o.context}),o.childWindowName=o.buildChildWindowName({renderTo:e}),o.delegate(e),o.render(t)})},t.prototype.prefetch=function(){var e=this;return ZalgoPromise.try(function(){e.html=e.buildUrl().then(function(e){return prefetchPage(e).then(function(t){return'\n                        <base href="'+(""+e.split("/").slice(0,3).join("/"))+'">\n\n                        '+t+"\n\n                        <script>\n                            if (window.history && window.history.pushState) {\n                                window.history.pushState({}, '', '"+("/"+e.split("/").slice(3).join("/"))+"');\n                            }\n                        <\/script>\n                    "})})})},t.prototype.loadHTML=function(){var e=this;return ZalgoPromise.try(function(){if(!e.html)throw new Error("Html not prefetched");return e.html.then(function(t){return writeToWindow(e.window,t)})})},t.prototype.checkAllowRenderTo=function(e){if(!e)throw this.component.createError("Must pass window to renderTo");if(!isSameDomain(e)){var t=getDomain(),o=this.component.getDomain(null,this.props.env);if(!o)throw new Error("Could not determine domain to allow remote render");if(!matchDomain(o,t))throw new Error("Can not render remotely to "+o.toString()+" - can only render to "+t)}},t.prototype.registerActiveComponent=function(){var e=this;t.activeComponents.push(this),this.clean.register(function(){t.activeComponents.splice(t.activeComponents.indexOf(e),1)})},t.prototype.getComponentParentRef=function(){if(this.component.getDomain(null,this.props.env)===getDomain(window)){var e=uniqueID();return global.windows=global.windows||{},global.windows[e]=window,this.clean.register(function(){delete global.windows[e]}),{ref:WINDOW_REFERENCES.GLOBAL,uid:e}}return this.context===CONTEXT_TYPES.POPUP?{ref:WINDOW_REFERENCES.OPENER}:isTop(window)?{ref:WINDOW_REFERENCES.TOP}:{ref:WINDOW_REFERENCES.PARENT,distance:getDistanceFromTop(window)}},t.prototype.getRenderParentRef=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window;if(e===window)return this.getComponentParentRef();var t=uniqueID();return global.windows[t]=e,this.clean.register(function(){delete global.windows[t]}),{ref:WINDOW_REFERENCES.GLOBAL,uid:t}},t.prototype.buildChildWindowName=function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).renderTo,t=void 0===e?window:e,o=this.component.getDomain(null,this.props.env),n=isSameDomain(t),r=uniqueID(),i=this.component.tag,s=serializeFunctions(this.getPropsForChild()),p=this.getComponentParentRef(),a=this.getRenderParentRef(t),c=!n&&!this.component.unsafeRenderTo?{type:INITIAL_PROPS.UID,uid:r}:{type:INITIAL_PROPS.RAW,value:s};return c.type===INITIAL_PROPS.UID&&(global.props[r]=JSON.stringify(s),this.clean.register(function(){delete global.props[r]})),_buildChildWindowName(this.component.name,this.component.version,{uid:r,tag:i,componentParent:p,renderParent:a,props:c,childDomain:o})},t.prototype.sendToParent=function(e,t){if(!getParentComponentWindow())throw new Error("Can not find parent component window to message");return this.component.log("send_to_parent_"+e),send(getParentComponentWindow(),e,t,{domain:getParentDomain()})},t.prototype.setProps=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];validateProps(this.component,e,t),this.component.validate&&this.component.validate(this.component,e),this.props=this.props||{},extend(this.props,normalizeProps(this.component,this,e))},t.prototype.buildUrl=function(){var e=this,t=this.props.url;return ZalgoPromise.all([t,propsToQuery(_extends({},this.component.props,this.component.builtinProps),this.props)]).then(function(t){var o=t[0],n=t[1];return o&&!e.component.getValidDomain(o)?o:ZalgoPromise.try(function(){return o||e.component.getUrl(e.props.env,e.props)}).then(function(e){return n.xcomponent="1",extendUrl(e,{query:n})})})},t.prototype.getDomain=function(){var e=this;return ZalgoPromise.try(function(){return e.props.url}).then(function(t){var o=e.component.getDomain(t,e.props.env);return o||(e.component.buildUrl?ZalgoPromise.try(function(){return e.component.buildUrl(e.props)}).then(function(t){return e.component.getDomain(t,e.props.env)}):void 0)}).then(function(e){if(!e)throw new Error("Could not determine domain");return e})},t.prototype.getPropsForChild=function(){for(var e={},t=0,o=Object.keys(this.props),n=null==o?0:o.length;t<n;t++){var r=o[t],i=this.component.getProp(r);i&&!1===i.sendToChild||(e[r]=this.props[r])}return e},t.prototype.updateProps=function(e){var t=this;return this.setProps(e,!1),this.onInit.then(function(){if(t.childExports)return t.childExports.updateProps(t.getPropsForChild());throw new Error("Child exports were not available")})},t.prototype.openBridge=function(e){var t=this;return ZalgoPromise.try(function(){if(bridge&&t.driver.needsBridge){var o={win:t.window};e&&(o.domain=e);var n=bridge.needsBridge(o),r=t.component.getBridgeUrl(t.props.env);if(r){r=extendUrl(r,{query:{version:t.component.version}});var i=t.component.getBridgeDomain(t.props.env);if(!i)throw new Error("Can not determine domain for bridge");return n?bridge.openBridge(r,i).then(function(e){if(e)return e}):void 0}if(n&&e&&!bridge.hasBridge(e,e))throw new Error("Bridge url needed to render "+t.context)}})},t.prototype.open=function(){var e=this;return ZalgoPromise.try(function(){e.component.log("open_"+e.context,{windowName:e.childWindowName});var t=e.props.win;return t?(e.clean.set("window",t),window.addEventListener("beforeunload",function(){return t.close()}),window.addEventListener("unload",function(){return t.close()}),void(assertSameDomain(e.window).name=e.childWindowName)):e.driver.open.call(e)})},t.prototype.openPrerender=function(){var e=this;return ZalgoPromise.try(function(){if(e.component.prerenderTemplate)return e.driver.openPrerender.call(e)})},t.prototype.switchPrerender=function(){var e=this;return ZalgoPromise.try(function(){if(e.prerenderWindow&&e.driver.switchPrerender)return e.driver.switchPrerender.call(e)})},t.prototype.elementReady=function(e){return _elementReady(e).then(noop)},t.prototype.delegate=function(e){var t=this;this.component.log("delegate_"+this.context);for(var o={uid:this.props.uid,dimensions:this.props.dimensions,onClose:this.props.onClose,onDisplay:this.props.onDisplay},n=0,r=this.component.getPropNames(),i=null==r?0:r.length;n<i;n++){var s=r[n];this.component.getProp(s).allowDelegate&&(o[s]=this.props[s])}for(var p=send(e,POST_MESSAGE.DELEGATE+"_"+this.component.name,{context:this.context,env:this.props.env,options:{context:this.context,childWindowName:this.childWindowName,isWindowClosed:function(){return _isWindowClosed(t.window)},props:o,overrides:{focus:function(){return t.focus()},userClose:function(){return t.userClose()},getDomain:function(){return t.getDomain()},error:function(e){return t.error(e)},on:function(e,o){return t.on(e,o)}}}}).then(function(e){var o=e.data;return t.clean.register(o.destroy),o}).catch(function(e){throw new Error("Unable to delegate rendering. Possibly the component is not loaded in the target window.\n\n"+stringifyError(e))}),a=this.driver.delegateOverrides,c=function(e,o,n){var r=o[e],i=a[r];if(i===DELEGATE.CALL_ORIGINAL)return"continue";var s=t[r];t[r]=function(){var e=this,t=arguments;return p.then(function(o){var n=o.overrides[r];if(i===DELEGATE.CALL_DELEGATE)return n.apply(e,t);if("function"==typeof i)return i(s,n).apply(e,t);throw new Error("Expected delgate to be CALL_ORIGINAL, CALL_DELEGATE, or factory method")})}},l=0,d=Object.keys(a),u=null==d?0:d.length;l<u;l++)c(l,d)},t.prototype.watchForClose=function(){var e=this,t=onCloseWindow(this.window,function(){return e.component.log("detect_close_child"),ZalgoPromise.try(function(){return e.props.onClose(CLOSE_REASONS.CLOSE_DETECTED)}).finally(function(){return e.destroy()})},3e3);this.clean.register("destroyCloseWindowListener",t.cancel)},t.prototype.watchForUnload=function(){var e=this,t=once(function(){e.component.log("navigate_away"),flush(),e.destroyComponent()}),o=addEventListener(window,"unload",t);this.clean.register("destroyUnloadWindowListener",o.cancel)},t.prototype.loadUrl=function(e){var t=this;return ZalgoPromise.try(function(){var o;(t.component.log("load_url"),window.location.href.split("#")[0]===e.split("#")[0])&&(e=extendUrl(e,{query:(o={},o[uniqueID()]="1",o)}));return t.driver.loadUrl.call(t,e)})},t.prototype.hijack=function(e){e.target=this.childWindowName},t.prototype.runTimeout=function(){var e=this,t=this.props.timeout;if(t){var o=this.timeout=setTimeout(function(){e.component.log("timed_out",{timeout:t.toString()});var o=e.component.createError("Loading component timed out after "+t+" milliseconds");e.onInit.reject(o),e.props.onTimeout(o)},t);this.clean.register(function(){clearTimeout(o),delete e.timeout})}},t.prototype.listeners=function(){var e;return(e={})[POST_MESSAGE.INIT]=function(e,t){return this.childExports=t.exports,this.onInit.resolve(this),this.timeout&&clearTimeout(this.timeout),{props:this.getPropsForChild(),context:this.context}},e[POST_MESSAGE.CLOSE]=function(e,t){this.close(t.reason)},e[POST_MESSAGE.CHECK_CLOSE]=function(){this.checkClose()},e[POST_MESSAGE.RESIZE]=function(e,t){var o=this;return ZalgoPromise.try(function(){if(o.driver.allowResize)return o.resize(t.width,t.height)})},e[POST_MESSAGE.HIDE]=function(){this.hide()},e[POST_MESSAGE.SHOW]=function(){this.show()},e[POST_MESSAGE.ERROR]=function(e,t){this.error(new Error(t.error))},e},t.prototype.resize=function(e,t){var o=this;return ZalgoPromise.try(function(){o.component.log("resize",{height:stringify(t),width:stringify(e)}),o.driver.resize.call(o,e,t),o.props.onResize&&o.props.onResize()})},t.prototype.hide=function(){return this.container&&hideElement(this.container),this.driver.hide.call(this)},t.prototype.show=function(){return this.container&&showElement(this.container),this.driver.show.call(this)},t.prototype.checkClose=function(){var e=this,t=onCloseWindow(this.window,function(){e.userClose()},50,500);this.clean.register(t.cancel)},t.prototype.userClose=function(){return this.close(CLOSE_REASONS.USER_CLOSED)},t.prototype.close=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:CLOSE_REASONS.PARENT_CALL;return ZalgoPromise.try(function(){return e.component.log("close",{reason:t}),e.event.triggerOnce(EVENTS.CLOSE),e.props.onClose(t)}).then(function(){return ZalgoPromise.all([e.closeComponent(),e.closeContainer()])}).then(function(){return e.destroy()})},t.prototype.closeContainer=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:CLOSE_REASONS.PARENT_CALL;return ZalgoPromise.try(function(){return e.event.triggerOnce(EVENTS.CLOSE),e.props.onClose(t)}).then(function(){return ZalgoPromise.all([e.closeComponent(t),e.hideContainer()])}).then(function(){return e.destroyContainer()})},t.prototype.destroyContainer=function(){var e=this;return ZalgoPromise.try(function(){e.clean.run("destroyContainerEvents"),e.clean.run("destroyContainerTemplate")})},t.prototype.closeComponent=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:CLOSE_REASONS.PARENT_CALL,o=this.window;return ZalgoPromise.try(function(){return e.cancelContainerEvents()}).then(function(){return e.event.triggerOnce(EVENTS.CLOSE),e.props.onClose(t)}).then(function(){return e.hideComponent()}).then(function(){return e.destroyComponent()}).then(function(){e.childExports&&e.context===CONTEXT_TYPES.POPUP&&!_isWindowClosed(o)&&e.childExports.close().catch(noop)})},t.prototype.destroyComponent=function(){this.clean.run("destroyUnloadWindowListener"),this.clean.run("destroyCloseWindowListener"),this.clean.run("destroyContainerEvents"),this.clean.run("destroyWindow")},t.prototype.showContainer=function(){var e=this;return ZalgoPromise.try(function(){if(e.props.onDisplay)return e.props.onDisplay()}).then(function(){if(e.container)return showAndAnimate(e.container,ANIMATION_NAMES.SHOW_CONTAINER,e.clean.register)})},t.prototype.showComponent=function(){var e=this;return ZalgoPromise.try(function(){if(e.props.onDisplay)return e.props.onDisplay()}).then(function(){if(e.element)return showAndAnimate(e.element,ANIMATION_NAMES.SHOW_COMPONENT,e.clean.register)})},t.prototype.hideContainer=function(){var e=this;return ZalgoPromise.try(function(){return e.container?animateAndHide(e.container,ANIMATION_NAMES.HIDE_CONTAINER,e.clean.register):ZalgoPromise.resolve()})},t.prototype.hideComponent=function(){var e=this;return ZalgoPromise.try(function(){return e.element?animateAndHide(e.element,ANIMATION_NAMES.HIDE_COMPONENT,e.clean.register):ZalgoPromise.resolve()})},t.prototype.focus=function(){if(!this.window||_isWindowClosed(this.window))throw new Error("No window to focus");this.component.log("focus"),this.window.focus()},t.prototype.createPrerenderTemplate=function(){var e=this;return ZalgoPromise.try(function(){return e.component.prerenderTemplate?ZalgoPromise.try(function(){return e.prerenderIframe?awaitFrameLoad(e.prerenderIframe).then(function(){return e.prerenderWindow}):e.prerenderWindow}).then(function(t){var o=void 0;try{o=t.document}catch(e){return}var n=void 0;try{n=e.renderTemplate(e.component.prerenderTemplate,{jsxDom:jsxDom.bind(o),document:o})}catch(t){return e.component.logError("preprender_error",{err:t.stack?t.stack:t.toString()}),void console.error(t.stack?t.stack:t)}try{writeElementToWindow(t,n)}catch(t){e.component.logError("preprender_error",{err:t.stack?t.stack:t.toString()}),console.error(t.stack?t.stack:t)}var r="object"===_typeof(e.component.autoResize)&&null!==e.component.autoResize?e.component.autoResize:{},i=r.width,s=void 0!==i&&i,p=r.height,a=void 0!==p&&p,c=r.element,l=void 0===c?"body":c;(l=getElementSafe(l,o))&&(s||a)&&onResize(l,function(t){var o=t.width,n=t.height;e.resize(s?o:void 0,a?n:void 0)},{width:s,height:a,win:t})}):ZalgoPromise.resolve()})},t.prototype.renderTemplate=function(e){var t=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.component.dimensions||{},r=n.width,i=void 0===r?DEFAULT_DIMENSIONS.WIDTH+"px":r,s=n.height,p=void 0===s?DEFAULT_DIMENSIONS.HEIGHT+"px":s;return e.call(this,_extends({id:CLASS_NAMES.ZOID+"-"+this.component.tag+"-"+this.props.uid,props:e.__xdomain__?null:this.props,tag:this.component.tag,context:this.context,outlet:this.getOutlet(),CLASS:CLASS_NAMES,ANIMATION:ANIMATION_NAMES,CONTEXT:CONTEXT_TYPES,EVENT:EVENTS,actions:{close:function(){return t.userClose()},focus:function(){return t.focus()}},on:function(e,o){return t.on(e,o)},jsxDom:jsxDom,document:document,dimensions:{width:i,height:p}},o))},t.prototype.openContainer=function(e){var t=this;return ZalgoPromise.try(function(){var o=void 0;if(!(o=e?getElement(e):document.body))throw new Error("Could not find element to open container into");if(isShadowElement(o)&&(o=insertShadowSlot(o)),t.component.containerTemplate){var n=t.renderTemplate(t.component.containerTemplate,{container:o});if(t.container=n,hideElement(t.container),appendChild(o,t.container),t.driver.renderedIntoContainerTemplate){if(t.element=t.getOutlet(),hideElement(t.element),!t.element)throw new Error("Could not find element to render component into");hideElement(t.element)}t.clean.register("destroyContainerTemplate",function(){t.container&&t.container.parentNode&&t.container.parentNode.removeChild(t.container),delete t.container})}else if(t.driver.renderedIntoContainerTemplate)throw new Error("containerTemplate needed to render "+t.context)})},t.prototype.cancelContainerEvents=function(){this.clean.run("destroyContainerEvents")},t.prototype.destroy=function(){var e=this;return ZalgoPromise.try(function(){if(e.clean.hasTasks())return e.component.log("destroy"),flush(),e.clean.all()}).then(function(){if(e.props&&e.props.onDestroy)return e.props.onDestroy()})},t.prototype.tryInit=function(e){var t=this;return ZalgoPromise.try(e).catch(function(e){t.onInit.reject(e)}).then(function(){return t.onInit})},t.prototype.error=function(e){var t=this;return ZalgoPromise.try(function(){if(t.handledErrors=t.handledErrors||[],-1===t.handledErrors.indexOf(e))return t.handledErrors.push(e),t.onInit.reject(e),t.destroy()}).then(function(){if(t.props.onError)return t.props.onError(e)}).catch(function(t){throw new Error("An error was encountered while handling error:\n\n "+stringifyError(e)+"\n\n"+stringifyError(t))}).then(function(){if(!t.props.onError)throw e})},t.destroyAll=function(){for(var e=[];t.activeComponents.length;)e.push(t.activeComponents[0].destroy());return ZalgoPromise.all(e).then(noop)},_createClass(t,[{key:"driver",get:function(){if(!this.context)throw new Error("Context not set");return RENDER_DRIVERS[this.context]}}]),t}(BaseComponent),_applyDecoratedDescriptor(_class.prototype,"getOutlet",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"getOutlet"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"prefetch",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"prefetch"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"loadHTML",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"loadHTML"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"buildUrl",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"buildUrl"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"open",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"open"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"openPrerender",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"openPrerender"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"switchPrerender",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"switchPrerender"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"close",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"close"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"closeContainer",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"closeContainer"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"destroyContainer",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"destroyContainer"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"closeComponent",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"closeComponent"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"showContainer",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"showContainer"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"showComponent",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"showComponent"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"hideContainer",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"hideContainer"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"hideComponent",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"hideComponent"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"createPrerenderTemplate",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"createPrerenderTemplate"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"openContainer",[memoized],Object.getOwnPropertyDescriptor(_class.prototype,"openContainer"),_class.prototype),_class);ParentComponent.activeComponents=[];
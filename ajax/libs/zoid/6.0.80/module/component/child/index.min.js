var _extends=Object.assign||function(t){for(var o=1;o<arguments.length;o++){var e=arguments[o];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function _classCallCheck(t,o){if(!(t instanceof o))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,o){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!o||"object"!=typeof o&&"function"!=typeof o?t:o}function _inherits(t,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function, not "+typeof o);t.prototype=Object.create(o&&o.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),o&&(Object.setPrototypeOf?Object.setPrototypeOf(t,o):t.__proto__=o)}import{flush}from"beaver-logger/client";import{isSameDomain,matchDomain,getDomain}from"cross-domain-utils/src";import{send}from"post-robot/src";import{ZalgoPromise}from"zalgo-promise/src";import{onResize}from"belter/src";import{BaseComponent}from"../base";import{getParentComponentWindow as _getParentComponentWindow,getComponentMeta,getParentDomain as _getParentDomain,getParentRenderWindow as _getParentRenderWindow}from"../window";import{extend,deserializeFunctions,get,stringify,globalFor,setLogLevel,getElement,noop,stringifyError}from"../../lib";import{POST_MESSAGE,CONTEXT_TYPES,CLOSE_REASONS,INITIAL_PROPS}from"../../constants";import{RenderError}from"../../error";import{normalizeChildProps}from"./props";export var ChildComponent=function(t){function o(e){_classCallCheck(this,o);var n=_possibleConstructorReturn(this,t.call(this));if(n.component=e,!n.hasValidParentDomain())return n.error(new RenderError("Can not be rendered by domain: "+n.getParentDomain())),_possibleConstructorReturn(n);n.component.log("construct_child"),n.onPropHandlers=[];for(var r=function(t,o,e){for(var r=o[t],i=function(t,o,e){var i=o[t],s=i[0],p=i[1];Object.defineProperty(r,s,{configurable:!0,get:function(){return n.props||n.setProps(n.getInitialProps(),_getParentDomain()),delete r[s],r[s]=p(),r[s]}})},s=0,p=[["xchild",function(){return n}],["xprops",function(){return n.props}]],a=null==p?0:p.length;s<a;s++)i(s,p)},i=0,s=[n.component,window],p=null==s?0:s.length;i<p;i++)r(i,s);return n.component.log("init_child"),n.setWindows(),n.onInit=n.sendToParent(POST_MESSAGE.INIT,{exports:n.exports()}).then(function(t){var o=t.origin,e=t.data;return n.context=e.context,n.setProps(e.props,o),n.watchForResize(),n}).catch(function(t){throw n.error(t),t}),n}return _inherits(o,t),o.prototype.hasValidParentDomain=function(){return matchDomain(this.component.allowedParentDomains,this.getParentDomain())},o.prototype.init=function(){return this.onInit},o.prototype.getParentDomain=function(){return _getParentDomain()},o.prototype.onProps=function(t){this.onPropHandlers.push(t)},o.prototype.getParentComponentWindow=function(){return _getParentComponentWindow()},o.prototype.getParentRenderWindow=function(){return _getParentRenderWindow()},o.prototype.getInitialProps=function(){var t=this,o=getComponentMeta(),e=o.props;if(e.type===INITIAL_PROPS.RAW)e=e.value;else{if(e.type!==INITIAL_PROPS.UID)throw new Error("Unrecognized props type: "+e.type);var n=_getParentComponentWindow();if(!isSameDomain(n)){if("file:"===window.location.protocol)throw new Error("Can not get props from file:// domain");throw new Error("Parent component window is on a different domain - expected "+getDomain()+" - can not retrieve props")}var r=globalFor(n);if(!r)throw new Error("Can not find global for parent component - can not retrieve props");e=JSON.parse(r.props[o.uid])}if(!e)throw new Error("Initial props not found");return deserializeFunctions(e,function(o){var e=o.fullKey,n=o.self,r=o.args;return t.onInit.then(function(){var o=get(t.props,e);if("function"!=typeof o)throw new TypeError("Expected "+e+" to be function, got "+(void 0===o?"undefined":_typeof(o)));return o.apply(n,r)})})},o.prototype.setProps=function(t,o){var e=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.props=this.props||{};var n=normalizeChildProps(this.component,t,o,e);extend(this.props,n),this.props.logLevel&&setLogLevel(this.props.logLevel);for(var r=0,i=this.onPropHandlers,s=null==i?0:i.length;r<s;r++){i[r].call(this,this.props)}},o.prototype.sendToParent=function(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=_getParentComponentWindow();if(!n)throw new Error("Can not find parent component window to message");return this.component.log("send_to_parent_"+t),send(n,t,o,_extends({domain:_getParentDomain()},e))},o.prototype.setWindows=function(){if(window.__activeZoidComponent__)throw this.component.createError("Can not attach multiple components to the same window");if(window.__activeZoidComponent__=this,!_getParentComponentWindow())throw this.component.createError("Can not find parent window");var t=getComponentMeta();if(t.tag!==this.component.tag)throw this.component.createError("Parent is "+t.tag+" - can not attach "+this.component.tag);this.watchForClose()},o.prototype.watchForClose=function(){var t=this;window.addEventListener("unload",function(){return t.checkClose()})},o.prototype.enableAutoResize=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=t.width,e=void 0===o||o,n=t.height,r=void 0===n||n;this.autoResize={width:e,height:r},this.watchForResize()},o.prototype.getAutoResize=function(){var t=!1,o=!1,e=this.autoResize||this.component.autoResize;"object"===(void 0===e?"undefined":_typeof(e))?(t=Boolean(e.width),o=Boolean(e.height)):e&&(t=!0,o=!0);return{width:t,height:o,element:e.element?getElement(e.element):document.body}},o.prototype.watchForResize=function(){var t=this,o=this.getAutoResize(),e=o.width,n=o.height,r=o.element;(e||n)&&this.context!==CONTEXT_TYPES.POPUP&&(this.watchingForResize||(this.watchingForResize=!0,onResize(r,function(o){var r=o.width,i=o.height;t.resize(e?r:void 0,n?i:void 0)},{width:e,height:n})))},o.prototype.exports=function(){var t=this;return{updateProps:function(o){var e=this;return ZalgoPromise.try(function(){return t.setProps(o,e.origin,!1)})},close:function(){return ZalgoPromise.try(function(){return t.destroy()})}}},o.prototype.resize=function(t,o){var e=this;return ZalgoPromise.resolve().then(function(){if(e.component.log("resize",{width:stringify(t),height:stringify(o)}),e.context!==CONTEXT_TYPES.POPUP)return e.sendToParent(POST_MESSAGE.RESIZE,{width:t,height:o}).then(noop)})},o.prototype.hide=function(){return this.sendToParent(POST_MESSAGE.HIDE).then(noop)},o.prototype.show=function(){return this.sendToParent(POST_MESSAGE.SHOW).then(noop)},o.prototype.userClose=function(){return this.close(CLOSE_REASONS.USER_CLOSED)},o.prototype.close=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:CLOSE_REASONS.CHILD_CALL;this.component.log("close_child"),this.sendToParent(POST_MESSAGE.CLOSE,{reason:t})},o.prototype.checkClose=function(){this.sendToParent(POST_MESSAGE.CHECK_CLOSE,{},{fireAndForget:!0})},o.prototype.destroy=function(){return flush().then(function(){window.close()})},o.prototype.focus=function(){this.component.log("focus"),window.focus()},o.prototype.error=function(t){var o=stringifyError(t);return this.component.logError("error",{error:o}),this.sendToParent(POST_MESSAGE.ERROR,{error:o}).then(noop)},o}(BaseComponent);
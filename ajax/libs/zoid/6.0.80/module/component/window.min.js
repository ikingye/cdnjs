import{getOpener,getTop,getParent,getNthParentFromTop,getAllFramesInWindow,getAncestor,getDomain}from"cross-domain-utils/src";import base32 from"hi-base32";import{memoize,uniqueID,globalFor,stringifyError}from"../lib";import{WINDOW_REFERENCES}from"../constants";function normalize(e){return e.replace(/^[^a-z0-9A-Z]+|[^a-z0-9A-Z]+$/g,"").replace(/[^a-z0-9A-Z]+/g,"_")}function encode(e){return base32.encode(e).replace(/\=/g,"").toLowerCase()}function decode(e){return base32.decode(e.toUpperCase())}export function buildChildWindowName(e,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};o.id=uniqueID(),o.domain=getDomain(window);var r=normalize(e),t=normalize(n),i=encode(JSON.stringify(o));if(!r)throw new Error("Invalid name: "+e+" - must contain alphanumeric characters");if(!t)throw new Error("Invalid version: "+n+" - must contain alphanumeric characters");return["xcomponent",r,t,i,""].join("__")};export var isZoidComponentWindow=memoize(function(){return!!window.name&&"xcomponent"===window.name.split("__")[0]});export var getComponentMeta=memoize(function(){if(!window.name)throw new Error("Can not get component meta without window name");var e=window.name.split("__"),n=e[0],o=e[1],r=e[2],t=e[3];if("xcomponent"!==n)throw new Error("Window not rendered by zoid - got "+n);var i=void 0;try{i=JSON.parse(decode(t))}catch(e){throw new Error("Can not decode component-meta: "+t+" "+stringifyError(e))}return i.name=o,i.version=r.replace(/_/g,"."),i});export function getParentDomain(){return getComponentMeta().domain};function getWindowByRef(e){var n=e.ref,o=e.uid,r=e.distance,t=void 0;if(n===WINDOW_REFERENCES.OPENER?t=getOpener(window):n===WINDOW_REFERENCES.TOP?t=getTop(window):n===WINDOW_REFERENCES.PARENT&&(t=r?getNthParentFromTop(window,r):getParent(window)),n===WINDOW_REFERENCES.GLOBAL){var i=getAncestor(window);if(i)for(var a=0,w=getAllFramesInWindow(i),d=null==w?0:w.length;a<d;a++){var m=w[a],c=globalFor(m);if(c&&c.windows&&c.windows[o]){t=c.windows[o];break}}}if(!t)throw new Error("Unable to find window by ref");return t}export var getParentComponentWindow=memoize(function(){var e=getComponentMeta();if(!e)throw new Error("Can not get parent component window - window not rendered by zoid");return getWindowByRef(e.componentParent)});export var getParentRenderWindow=memoize(function(){var e=getComponentMeta();if(!e)throw new Error("Can not get parent component window - window not rendered by zoid");return getWindowByRef(e.renderParent)});export function getPosition(e){var n=e.width,o=e.height,r=0,t=0;return n&&(window.outerWidth?r=Math.round((window.outerWidth-n)/2)+window.screenX:window.screen.width&&(r=Math.round((window.screen.width-n)/2))),o&&(window.outerHeight?t=Math.round((window.outerHeight-o)/2)+window.screenY:window.screen.height&&(t=Math.round((window.screen.height-o)/2))),{x:r,y:t}};
var _desc,_value,_class,_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _applyDecoratedDescriptor(e,t,r,o,n){var i={};return Object.keys(o).forEach(function(e){i[e]=o[e]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=r.slice().reverse().reduce(function(r,o){return o(e,t,r)||r},i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(e,t,i),i=null),i}import{on,send}from"post-robot/src";import{ZalgoPromise}from"zalgo-promise/src";import{getDomain,getDomainFromUrl,matchDomain}from"cross-domain-utils/src";import{BaseComponent}from"../base";import{ChildComponent}from"../child";import{ParentComponent}from"../parent";import{DelegateComponent}from"../delegate";import{isZoidComponentWindow,getComponentMeta}from"../window";import{CONTEXT_TYPES,POST_MESSAGE,WILDCARD}from"../../constants";import{angular,angular2,glimmer,react,vue,script}from"../../drivers/index";import{info,error,warn,setLogLevel,memoize}from"../../lib";import{validate}from"./validate";import{defaultContainerTemplate,defaultPrerenderTemplate}from"./templates";import{getInternalProps}from"./props";var drivers={angular:angular,angular2:angular2,glimmer:glimmer,react:react,vue:vue,script:script};export var Component=(_class=function(e){function t(r){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,e.call(this));if(validate(r),o.addProp(r,"tag"),o.addProp(r,"defaultLogLevel","info"),o.addProp(r,"allowedParentDomains",WILDCARD),setLogLevel(o.defaultLogLevel),t.components[o.tag])throw new Error("Can not register multiple components with the same tag");return o.addProp(r,"name",o.tag.replace(/-/g,"_")),o.builtinProps=getInternalProps(),o.props=r.props||{},r.props||(o.looseProps=!0),o.addProp(r,"dimensions"),o.addProp(r,"scrolling"),o.addProp(r,"listenForResize"),o.addProp(r,"version","latest"),o.addProp(r,"defaultEnv"),o.addProp(r,"buildUrl"),o.addProp(r,"url"),o.addProp(r,"domain"),o.addProp(r,"bridgeUrl"),o.addProp(r,"bridgeDomain"),o.addProp(r,"attributes",{}),o.addProp(r,"contexts",{iframe:!0,popup:!1}),o.addProp(r,"defaultContext"),o.addProp(r,"autoResize",!1),o.addProp(r,"containerTemplate",defaultContainerTemplate),o.addProp(r,"prerenderTemplate",defaultPrerenderTemplate),o.addProp(r,"validate"),o.addProp(r,"unsafeRenderTo",!1),t.components[o.tag]=o,o.registerDrivers(),o.registerChild(),o.listenDelegate(),o}return _inherits(t,e),t.prototype.getPropNames=function(){for(var e=Object.keys(this.props),t=0,r=Object.keys(this.builtinProps),o=null==r?0:r.length;t<o;t++){var n=r[t];-1===e.indexOf(n)&&e.push(n)}return e},t.prototype.getProp=function(e){return this.props[e]||this.builtinProps[e]},t.prototype.registerDrivers=function(){this.driverCache={};for(var e=0,t=Object.keys(drivers),r=null==t?0:t.length;e<r;e++){var o=t[e];if(0!==o.indexOf("_")){var n=drivers[o].global();n&&this.driver(o,n)}}},t.prototype.driver=function(e,t){if(!drivers[e])throw new Error("Could not find driver for framework: "+e);return this.driverCache[e]||(this.driverCache[e]=drivers[e].register(this,t)),this.driverCache[e]},t.prototype.registerChild=function(){var e=this;return ZalgoPromise.try(function(){if(e.isChild())return new ChildComponent(e)})},t.prototype.listenDelegate=function(){var e=this;on(POST_MESSAGE.ALLOW_DELEGATE+"_"+this.name,function(){return!0}),on(POST_MESSAGE.DELEGATE+"_"+this.name,function(t){var r=t.source,o=t.origin,n=t.data,i=e.getDomain(null,n.env||e.defaultEnv);if(!i)throw new Error("Could not determine domain to allow remote render");if(!matchDomain(i,o))throw new Error("Can not render from "+o+" - expected "+i.toString());var a=e.delegate(r,n.options);return{overrides:a.getOverrides(n.context),destroy:function(){return a.destroy()}}})},t.prototype.canRenderTo=function(e){return send(e,POST_MESSAGE.ALLOW_DELEGATE+"_"+this.name).then(function(e){return e.data}).catch(function(){return!1})},t.prototype.getValidDomain=function(e){if(e){var t=getDomainFromUrl(e);if("string"==typeof this.domain&&t===this.domain)return t;var r=this.domain;if(r&&"object"===(void 0===r?"undefined":_typeof(r))&&!(r instanceof RegExp))for(var o=0,n=Object.keys(r),i=null==n?0:n.length;o<i;o++){var a=n[o];if("test"!==a&&t===r[a])return t}}},t.prototype.getDomain=function(e,t){var r=this.getForEnv(this.domain,t);if(r)return r;if(r=this.getValidDomain(e))return r;var o=this.getForEnv(this.url,t);return o?getDomainFromUrl(o):e?getDomainFromUrl(e):void 0},t.prototype.getBridgeUrl=function(e){return this.getForEnv(this.bridgeUrl,e)},t.prototype.getForEnv=function(e,t){if(e){if("string"==typeof e||e instanceof RegExp)return e;if(t||(t=this.defaultEnv),t)return t&&"object"===(void 0===e?"undefined":_typeof(e))&&e[t]?e[t]:void 0}},t.prototype.getBridgeDomain=function(e){var t=this.getForEnv(this.bridgeDomain,e);if(t)return t;var r=this.getBridgeUrl(e);return r?getDomainFromUrl(r):void 0},t.prototype.getUrl=function(e,t){var r=this.getForEnv(this.url,e);if(r)return r;if(this.buildUrl)return this.buildUrl(t);throw new Error("Unable to get url")},t.prototype.isZoidComponent=function(){return isZoidComponentWindow()},t.prototype.isChild=function(){if(!isZoidComponentWindow())return!1;var e=getComponentMeta(),t=e.tag,r=e.childDomain;return(!r||r===getDomain())&&t===this.tag},t.prototype.createError=function(e,t){return new Error("["+(t||this.tag)+"] "+e)},t.prototype.init=function(e,t,r){return new ParentComponent(this,this.getRenderContext(t,r),{props:e})},t.prototype.delegate=function(e,t){return new DelegateComponent(this,e,t)},t.prototype.validateRenderContext=function(e,t){if(e&&!this.contexts[e])throw new Error("["+this.tag+"] Can not render to "+e);if(!t&&e===CONTEXT_TYPES.IFRAME)throw new Error("["+this.tag+"] Context type "+CONTEXT_TYPES.IFRAME+" requires an element selector")},t.prototype.getDefaultContext=function(){if(this.defaultContext)return this.defaultContext;if(this.contexts[CONTEXT_TYPES.IFRAME])return CONTEXT_TYPES.IFRAME;if(this.contexts[CONTEXT_TYPES.POPUP])return CONTEXT_TYPES.POPUP;throw new Error("Can not determine default context")},t.prototype.getRenderContext=function(e,t){return e=e||this.getDefaultContext(),this.validateRenderContext(e,t),e},t.prototype.render=function(e,t){var r=this;return ZalgoPromise.try(function(){return new ParentComponent(r,r.getRenderContext(null,t),{props:e}).render(t)})},t.prototype.renderIframe=function(e,t){var r=this;return ZalgoPromise.try(function(){return new ParentComponent(r,r.getRenderContext(CONTEXT_TYPES.IFRAME,t),{props:e}).render(t)})},t.prototype.renderPopup=function(e){var t=this;return ZalgoPromise.try(function(){return new ParentComponent(t,t.getRenderContext(CONTEXT_TYPES.POPUP),{props:e}).render()})},t.prototype.renderTo=function(e,t,r){var o=this;return ZalgoPromise.try(function(){return new ParentComponent(o,o.getRenderContext(null,r),{props:t}).renderTo(e,r)})},t.prototype.renderIframeTo=function(e,t,r){var o=this;return ZalgoPromise.try(function(){return new ParentComponent(o,o.getRenderContext(CONTEXT_TYPES.IFRAME,r),{props:t}).renderTo(e,r)})},t.prototype.renderPopupTo=function(e,t){var r=this;return ZalgoPromise.try(function(){return new ParentComponent(r,r.getRenderContext(CONTEXT_TYPES.POPUP),{props:t}).renderTo(e)})},t.prototype.prerender=function(e,t){var r=new ParentComponent(this,this.getRenderContext(null,t),{props:e});return r.prefetch(),{render:function(e,t){return e&&r.updateProps(e),r.render(t)},renderTo:function(e,t,o){return t&&r.updateProps(t),r.renderTo(e,o)},get html(){return r.html},set html(e){r.html=e}}},t.prototype.log=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};info(this.name,e,t)},t.prototype.logWarning=function(e,t){warn(this.name,e,t)},t.prototype.logError=function(e,t){error(this.name,e,t)},t.getByTag=function(e){return t.components[e]},t}(BaseComponent),_applyDecoratedDescriptor(_class.prototype,"getPropNames",[memoize],Object.getOwnPropertyDescriptor(_class.prototype,"getPropNames"),_class.prototype),_class);Component.components={};
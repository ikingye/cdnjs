"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var _inheritsLoose=_interopDefault(require("@babel/runtime/helpers/inheritsLoose")),Stream=_interopDefault(require("@videojs/vhs-utils/dist/stream.js")),_extends=_interopDefault(require("@babel/runtime/helpers/extends")),_assertThisInitialized=_interopDefault(require("@babel/runtime/helpers/assertThisInitialized")),decodeB64ToUint8Array=_interopDefault(require("@videojs/vhs-utils/dist/decode-b64-to-uint8-array.js")),LineStream=function(e){function t(){var t=e.call(this)||this;return t.buffer="",t}return _inheritsLoose(t,e),t.prototype.push=function(t){var e;for(this.buffer+=t,e=this.buffer.indexOf("\n");-1<e;e=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,e)),this.buffer=this.buffer.substring(e+1)},t}(Stream),attributeSeparator=function(){return new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')},parseAttributes=function(t){for(var e,i=t.split(attributeSeparator()),a={},r=i.length;r--;)""!==i[r]&&((e=/([^=]*)=(.*)/.exec(i[r]).slice(1))[0]=e[0].replace(/^\s+|\s+$/g,""),e[1]=e[1].replace(/^\s+|\s+$/g,""),e[1]=e[1].replace(/^['"](.*)['"]$/g,"$1"),a[e[0]]=e[1]);return a},ParseStream=function(e){function t(){var t=e.call(this)||this;return t.customParsers=[],t.tagMappers=[],t}_inheritsLoose(t,e);var i=t.prototype;return i.push=function(a){var o,g,d=this;0!==(a=a.trim()).length&&("#"===a[0]?this.tagMappers.reduce(function(t,e){var i=e(a);return i===a?t:t.concat([i])},[a]).forEach(function(t){for(var e,i,a,r,s,n,u=0;u<d.customParsers.length;u++)if(d.customParsers[u].call(d,t))return;if(0===t.indexOf("#EXT"))if(t=t.replace("\r",""),o=/^#EXTM3U/.exec(t))d.trigger("data",{type:"tag",tagType:"m3u"});else{if(o=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(t))return g={type:"tag",tagType:"inf"},o[1]&&(g.duration=parseFloat(o[1])),o[2]&&(g.title=o[2]),void d.trigger("data",g);if(o=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(t))return g={type:"tag",tagType:"targetduration"},o[1]&&(g.duration=parseInt(o[1],10)),void d.trigger("data",g);if(o=/^#ZEN-TOTAL-DURATION:?([0-9.]*)?/.exec(t))return g={type:"tag",tagType:"totalduration"},o[1]&&(g.duration=parseInt(o[1],10)),void d.trigger("data",g);if(o=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(t))return g={type:"tag",tagType:"version"},o[1]&&(g.version=parseInt(o[1],10)),void d.trigger("data",g);if(o=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(t))return g={type:"tag",tagType:"media-sequence"},o[1]&&(g.number=parseInt(o[1],10)),void d.trigger("data",g);if(o=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(t))return g={type:"tag",tagType:"discontinuity-sequence"},o[1]&&(g.number=parseInt(o[1],10)),void d.trigger("data",g);if(o=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(t))return g={type:"tag",tagType:"playlist-type"},o[1]&&(g.playlistType=o[1]),void d.trigger("data",g);if(o=/^#EXT-X-BYTERANGE:?([0-9.]*)?@?([0-9.]*)?/.exec(t))return g={type:"tag",tagType:"byterange"},o[1]&&(g.length=parseInt(o[1],10)),o[2]&&(g.offset=parseInt(o[2],10)),void d.trigger("data",g);if(o=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(t))return g={type:"tag",tagType:"allow-cache"},o[1]&&(g.allowed=!/NO/.test(o[1])),void d.trigger("data",g);if(o=/^#EXT-X-MAP:?(.*)$/.exec(t))return g={type:"tag",tagType:"map"},o[1]&&((e=parseAttributes(o[1])).URI&&(g.uri=e.URI),e.BYTERANGE&&(a=(i=e.BYTERANGE.split("@"))[0],r=i[1],g.byterange={},a&&(g.byterange.length=parseInt(a,10)),r&&(g.byterange.offset=parseInt(r,10)))),void d.trigger("data",g);if(o=/^#EXT-X-STREAM-INF:?(.*)$/.exec(t))return g={type:"tag",tagType:"stream-inf"},o[1]&&(g.attributes=parseAttributes(o[1]),g.attributes.RESOLUTION&&(n={},(s=g.attributes.RESOLUTION.split("x"))[0]&&(n.width=parseInt(s[0],10)),s[1]&&(n.height=parseInt(s[1],10)),g.attributes.RESOLUTION=n),g.attributes.BANDWIDTH&&(g.attributes.BANDWIDTH=parseInt(g.attributes.BANDWIDTH,10)),g.attributes["PROGRAM-ID"]&&(g.attributes["PROGRAM-ID"]=parseInt(g.attributes["PROGRAM-ID"],10))),void d.trigger("data",g);if(o=/^#EXT-X-MEDIA:?(.*)$/.exec(t))return g={type:"tag",tagType:"media"},o[1]&&(g.attributes=parseAttributes(o[1])),void d.trigger("data",g);if(o=/^#EXT-X-ENDLIST/.exec(t))d.trigger("data",{type:"tag",tagType:"endlist"});else if(o=/^#EXT-X-DISCONTINUITY/.exec(t))d.trigger("data",{type:"tag",tagType:"discontinuity"});else{if(o=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(t))return g={type:"tag",tagType:"program-date-time"},o[1]&&(g.dateTimeString=o[1],g.dateTimeObject=new Date(o[1])),void d.trigger("data",g);if(o=/^#EXT-X-KEY:?(.*)$/.exec(t))return g={type:"tag",tagType:"key"},o[1]&&(g.attributes=parseAttributes(o[1]),g.attributes.IV&&("0x"===g.attributes.IV.substring(0,2).toLowerCase()&&(g.attributes.IV=g.attributes.IV.substring(2)),g.attributes.IV=g.attributes.IV.match(/.{8}/g),g.attributes.IV[0]=parseInt(g.attributes.IV[0],16),g.attributes.IV[1]=parseInt(g.attributes.IV[1],16),g.attributes.IV[2]=parseInt(g.attributes.IV[2],16),g.attributes.IV[3]=parseInt(g.attributes.IV[3],16),g.attributes.IV=new Uint32Array(g.attributes.IV))),void d.trigger("data",g);if(o=/^#EXT-X-START:?(.*)$/.exec(t))return g={type:"tag",tagType:"start"},o[1]&&(g.attributes=parseAttributes(o[1]),g.attributes["TIME-OFFSET"]=parseFloat(g.attributes["TIME-OFFSET"]),g.attributes.PRECISE=/YES/.test(g.attributes.PRECISE)),void d.trigger("data",g);if(o=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(t))return g={type:"tag",tagType:"cue-out-cont"},o[1]?g.data=o[1]:g.data="",void d.trigger("data",g);if(o=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(t))return g={type:"tag",tagType:"cue-out"},o[1]?g.data=o[1]:g.data="",void d.trigger("data",g);if(o=/^#EXT-X-CUE-IN:?(.*)?$/.exec(t))return g={type:"tag",tagType:"cue-in"},o[1]?g.data=o[1]:g.data="",void d.trigger("data",g);d.trigger("data",{type:"tag",data:t.slice(4)})}}else d.trigger("data",{type:"comment",text:t.slice(1)})}):this.trigger("data",{type:"uri",uri:a}))},i.addParser=function(t){var e=this,i=t.expression,a=t.customType,r=t.dataParser,s=t.segment;"function"!=typeof r&&(r=function(t){return t}),this.customParsers.push(function(t){if(i.exec(t))return e.trigger("data",{type:"custom",data:r(t),customType:a,segment:s}),!0})},i.addTagMapper=function(t){var e=t.expression,i=t.map;this.tagMappers.push(function(t){return e.test(t)?i(t):t})},t}(Stream),Parser=function(e){function t(){var t=e.call(this)||this;t.lineStream=new LineStream,t.parseStream=new ParseStream,t.lineStream.pipe(t.parseStream);var r,s,n=_assertThisInitialized(t),u=[],o={},g={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},d=0;t.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};var p=0;return t.parseStream.on("data",function(e){var i,a;({tag:function(){({"allow-cache":function(){this.manifest.allowCache=e.allowed,"allowed"in e||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var t={};"length"in e&&((o.byterange=t).length=e.length,"offset"in e||(e.offset=p)),"offset"in e&&((o.byterange=t).offset=e.offset),p=t.offset+t.length},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),0<e.duration&&(o.duration=e.duration),0===e.duration&&(o.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=u},key:function(){if(e.attributes)if("NONE"!==e.attributes.METHOD)if(e.attributes.URI){if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===e.attributes.KEYFORMAT){return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(e.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===e.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==e.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):e.attributes.KEYID&&"0x"===e.attributes.KEYID.substring(0,2)?void(this.manifest.contentProtection={"com.widevine.alpha":{attributes:{schemeIdUri:e.attributes.KEYFORMAT,keyId:e.attributes.KEYID.substring(2)},pssh:decodeB64ToUint8Array(e.attributes.URI.split(",")[1])}}):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}))}e.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),s={method:e.attributes.METHOD||"AES-128",uri:e.attributes.URI},void 0!==e.attributes.IV&&(s.iv=e.attributes.IV)}else this.trigger("warn",{message:"ignoring key declaration without URI"});else s=null;else this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence":function(){isFinite(e.number)?this.manifest.mediaSequence=e.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+e.number})},"discontinuity-sequence":function(){isFinite(e.number)?(this.manifest.discontinuitySequence=e.number,d=e.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+e.number})},"playlist-type":function(){/VOD|EVENT/.test(e.playlistType)?this.manifest.playlistType=e.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+e.playlist})},map:function(){r={},e.uri&&(r.uri=e.uri),e.byterange&&(r.byterange=e.byterange)},"stream-inf":function(){this.manifest.playlists=u,this.manifest.mediaGroups=this.manifest.mediaGroups||g,e.attributes?(o.attributes||(o.attributes={}),_extends(o.attributes,e.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media:function(){var t;this.manifest.mediaGroups=this.manifest.mediaGroups||g,e.attributes&&e.attributes.TYPE&&e.attributes["GROUP-ID"]&&e.attributes.NAME?((t=this.manifest.mediaGroups[e.attributes.TYPE])[e.attributes["GROUP-ID"]]=t[e.attributes["GROUP-ID"]]||{},i=t[e.attributes["GROUP-ID"]],(a={default:/yes/i.test(e.attributes.DEFAULT)}).default?a.autoselect=!0:a.autoselect=/yes/i.test(e.attributes.AUTOSELECT),e.attributes.LANGUAGE&&(a.language=e.attributes.LANGUAGE),e.attributes.URI&&(a.uri=e.attributes.URI),e.attributes["INSTREAM-ID"]&&(a.instreamId=e.attributes["INSTREAM-ID"]),e.attributes.CHARACTERISTICS&&(a.characteristics=e.attributes.CHARACTERISTICS),e.attributes.FORCED&&(a.forced=/yes/i.test(e.attributes.FORCED)),i[e.attributes.NAME]=a):this.trigger("warn",{message:"ignoring incomplete or missing media group"})},discontinuity:function(){d+=1,o.discontinuity=!0,this.manifest.discontinuityStarts.push(u.length)},"program-date-time":function(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=e.dateTimeString,this.manifest.dateTimeObject=e.dateTimeObject),o.dateTimeString=e.dateTimeString,o.dateTimeObject=e.dateTimeObject},targetduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+e.duration}):this.manifest.targetDuration=e.duration},totalduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid total duration: "+e.duration}):this.manifest.totalDuration=e.duration},start:function(){e.attributes&&!isNaN(e.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:e.attributes["TIME-OFFSET"],precise:e.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out":function(){o.cueOut=e.data},"cue-out-cont":function(){o.cueOutCont=e.data},"cue-in":function(){o.cueIn=e.data}}[e.tagType]||function(){}).call(n)},uri:function(){o.uri=e.uri,u.push(o),!this.manifest.targetDuration||"duration"in o||(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),o.duration=this.manifest.targetDuration),s&&(o.key=s),o.timeline=d,r&&(o.map=r),o={}},comment:function(){},custom:function(){e.segment?(o.custom=o.custom||{},o.custom[e.customType]=e.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[e.customType]=e.data)}})[e.type].call(n)}),t}_inheritsLoose(t,e);var i=t.prototype;return i.push=function(t){this.lineStream.push(t)},i.end=function(){this.lineStream.push("\n")},i.addParser=function(t){this.parseStream.addParser(t)},i.addTagMapper=function(t){this.parseStream.addTagMapper(t)},t}(Stream);exports.LineStream=LineStream,exports.ParseStream=ParseStream,exports.Parser=Parser;
import{Slim,_$,isReadyOnly}from"../Slim.js";Slim.customDirective(e=>"s:repeat"===e.nodeName,(e,t,l)=>{let n=l.value,r="data";n.indexOf(" as ")>0&&([n,r]=n.split(" as "));let i=[];const o=document.createComment(`${t.localName} s:repeat="${l.value}"`),a=t.parentElement||Slim.root(e);a.insertBefore(o,t),t.removeAttribute("s:repeat"),Slim.qSelectAll(t,"*").forEach(e=>{Slim._$(e).excluded=!0}),Slim._$(t).excluded=!0;const c=t.outerHTML;t.remove();let m=[];const s=(e,t)=>{let l=t,n="";if(e<1)return n;for(;e>1;)1&e&&(n+=l),e>>=1,l+=l;return n+l};Slim.bind(e,o,n,()=>{const t=Slim.lookup(e,n)||[];let l;if(t.length<i.length&&(i.slice(t.length).forEach(t=>{Slim.unbind(e,t),t[_$].subTree&&t[_$].subTree.forEach(t=>Slim.unbind(e,t)),t.remove()}),i.length=t.length),t.length>i.length){const n=i.length,a=t.length-i.length,m=s(a,c),S=document.createRange();S.setStartBefore(o),l=S.createContextualFragment(m);for(let e=0;e<a;e++){const o=t[e+n],a=l.children[e];Slim._$(a).repeater[r]=o;const c=Slim.qSelectAll(a,"*");c.forEach(function(e){Slim._$(e).repeater[r]=o}),a[_$].subTree=c,i.push(a)}const u=Slim.qSelectAll(l,"*");e._bindChildren(u)}const S=(e,t)=>{isReadyOnly(e,r)||(e[r]=t),Slim.commit(e,r)};t.forEach(function(e,t){if(m[t]!==e){const l=i[t];[l,...l[_$].subTree||Slim.qSelectAll(l,"*")].forEach(t=>{t[_$].repeater[r]=e,t[_$].repeater.__node=l,t.__isSlim?(t.createdCallback(),Slim.asap(()=>S(t,e))):S(t,e)})}}),m=t.concat(),l&&Slim.asap(()=>{a.insertBefore(l,o)})})},!0);
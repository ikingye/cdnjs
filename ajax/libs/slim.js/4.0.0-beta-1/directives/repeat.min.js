import{Slim,_$,isReadyOnly}from"../Slim.js";Slim.customDirective(e=>"s:repeat"===e.nodeName,(e,t,l)=>{let r=l.value,n="data";r.indexOf(" as ")>0&&([r,n]=r.split(" as "));let i=[];const o=document.createComment(`${t.localName} s:repeat="${l.value}"`),a=t.parentElement||Slim.root(e);a.insertBefore(o,t),t.removeAttribute("s:repeat"),Slim.qSelectAll(t,"*").forEach(e=>{Slim._$(e).excluded=!0}),Slim._$(t).excluded=!0;const c=t.outerHTML;t.remove();let m=[];Slim.bind(e,o,r,()=>{const t=Slim.lookup(e,r)||[];let l;if(t.length<i.length&&(i.slice(t.length).forEach(t=>{Slim.unbind(e,t),t[_$].subTree&&t[_$].subTree.forEach(t=>Slim.unbind(e,t)),t.remove()}),i.length=t.length),t.length>i.length){const r=i.length,a=t.length-i.length,m=((e,t)=>{let l=t,r="";if(e<1)return r;for(;e>1;)1&e&&(r+=l),e>>=1,l+=l;return r+l})(a,c),s=document.createRange();s.setStartBefore(o),l=s.createContextualFragment(m);for(let e=0;e<a;e++){const o=t[e+r],a=l.children[e];Slim._$(a).repeater[n]=o;const c=Slim.qSelectAll(a,"*");c.forEach(function(e){Slim._$(e).repeater[n]=o}),a[_$].subTree=c,i.push(a)}const S=Slim.qSelectAll(l,"*");e._bindChildren(S)}const s=(e,t)=>{isReadyOnly(e,n)||(e[n]=t),Slim.commit(e,n)};t.forEach(function(e,t){if(m[t]!==e){const l=i[t];[l,...l[_$].subTree||Slim.qSelectAll(l,"*")].forEach(t=>{t[_$].repeater[n]=e,t[_$].repeater.__node=l,t.__isSlim?(t.createdCallback(),Slim.asap(()=>s(t,e))):s(t,e)})}}),m=t.concat(),l&&Slim.asap(()=>{a.insertBefore(l,o)})})},!0);
import{canUseDOM}from"fbjs/lib/ExecutionEnvironment";import createResponderEvent from"./createResponderEvent";import{isCancelish,isEndish,isMoveish,isScroll,isSelectionChange,isStartish}from"./ResponderEventTypes";import{getLowestCommonAncestor,getResponderPaths,hasTargetTouches,hasValidSelection,isPrimaryPointerDown,setResponderId}from"./utils";import ResponderTouchHistoryStore from"./ResponderTouchHistoryStore";var emptyObject={},startRegistration=["onStartShouldSetResponderCapture","onStartShouldSetResponder",{bubbles:!0}],moveRegistration=["onMoveShouldSetResponderCapture","onMoveShouldSetResponder",{bubbles:!0}],scrollRegistration=["onScrollShouldSetResponderCapture","onScrollShouldSetResponder",{bubbles:!1}],shouldSetResponderEvents={touchstart:startRegistration,mousedown:startRegistration,touchmove:moveRegistration,mousemove:moveRegistration,scroll:scrollRegistration},emptyResponder={id:null,idPath:null,node:null},responderListenersMap=new Map,isEmulatingMouseEvents=!1,trackedTouchCount=0,currentResponder={id:null,node:null,idPath:null};function changeCurrentResponder(e){currentResponder=e}function getResponderConfig(e){var n=responderListenersMap.get(e);return null!=n?n:emptyObject}function eventListener(e){var n=e.type,t=e.target;if("touchstart"===n&&(isEmulatingMouseEvents=!0),("touchmove"===n||trackedTouchCount>1)&&(isEmulatingMouseEvents=!1),!("mousedown"===n&&isEmulatingMouseEvents||"mousemove"===n&&isEmulatingMouseEvents||"mousemove"===n&&trackedTouchCount<1))if(isEmulatingMouseEvents&&"mouseup"===n)0===trackedTouchCount&&(isEmulatingMouseEvents=!1);else{var o=isStartish(n)&&isPrimaryPointerDown(e),r=isMoveish(n),s=isEndish(n),u=isScroll(n),i=isSelectionChange(n),a=createResponderEvent(e);(o||r||s)&&(e.touches?trackedTouchCount=e.touches.length:o?trackedTouchCount=1:s&&(trackedTouchCount=0),ResponderTouchHistoryStore.recordTouchTrack(n,a.nativeEvent));var d,l=getResponderPaths(e),c=!1;if(o||r||u&&trackedTouchCount>0){var p=currentResponder.idPath,h=l.idPath;if(null!=p&&null!=h){var R=getLowestCommonAncestor(p,h);if(null!=R){var m=h.indexOf(R)+(R===currentResponder.id?1:0);l={idPath:h.slice(m),nodePath:l.nodePath.slice(m)}}else l=null}null!=l&&null!=(d=findWantsResponder(l,e,a))&&(attemptTransfer(a,d),c=!0)}if(null!=currentResponder.id&&null!=currentResponder.node){var v=currentResponder,g=v.id,f=v.node,E=getResponderConfig(g),C=E.onResponderStart,S=E.onResponderMove,T=E.onResponderEnd,b=E.onResponderRelease,M=E.onResponderTerminate,P=E.onResponderTerminationRequest;if(a.bubbles=!1,a.cancelable=!1,a.currentTarget=f,o)null!=C&&C(a);else if(r)null!=S&&S(a);else{var w=isCancelish(n)||"contextmenu"===n||"blur"===n&&t===window||"blur"===n&&t.contains(f)&&e.relatedTarget!==f||u&&0===trackedTouchCount||u&&t.contains(f)&&t!==f||i&&hasValidSelection(e),y=s&&!w&&!hasTargetTouches(f,e.touches);if(s&&null!=T&&T(a),y&&(null!=b&&b(a),changeCurrentResponder(emptyResponder)),w){var L=!0;"contextmenu"!==n&&"scroll"!==n&&"selectionchange"!==n||(c||null!=P&&!1===P(a))&&(L=!1),L&&(null!=M&&M(a),changeCurrentResponder(emptyResponder),isEmulatingMouseEvents=!1,trackedTouchCount=0)}}}}}function findWantsResponder(e,n,t){var o=shouldSetResponderEvents[n.type];if(null!=o){for(var r=e.idPath,s=e.nodePath,u=o[0],i=o[1],a=o[2].bubbles,d=function(e,n,o){var s=getResponderConfig(e)[o];if(null!=s&&!0===s(t))return{id:e,node:n,idPath:r}},l=r.length-1;l>=0;l--){var c=d(r[l],s[l],u);if(null!=c)return c;if(!0===t.isPropagationStopped())return}if(a)for(var p=0;p<r.length;p++){var h=d(r[p],s[p],i);if(null!=h)return h;if(!0===t.isPropagationStopped())return}else{var R=r[0],m=s[0];if(n.target===m)return d(R,m,i)}}}function attemptTransfer(e,n){var t=currentResponder,o=t.id,r=t.node,s=n.id,u=n.node,i=getResponderConfig(s),a=i.onResponderGrant,d=i.onResponderReject;if(e.bubbles=!1,e.cancelable=!1,e.currentTarget=u,null==o)null!=a&&(e.currentTarget=u,e.dispatchConfig.registrationName="onResponderGrant",a(e)),changeCurrentResponder(n);else{var l=getResponderConfig(o),c=l.onResponderTerminate,p=l.onResponderTerminationRequest;null!=p&&p(e)?(null!=c&&(e.currentTarget=r,c(e)),null!=a&&a(e),changeCurrentResponder(n)):null!=d&&d(e)}}var documentEventsCapturePhase=["blur","scroll"],documentEventsBubblePhase=["mousedown","mousemove","mouseup","dragstart","touchstart","touchmove","touchend","touchcancel","contextmenu","select","selectionchange"];export function attachListeners(){canUseDOM&&null==window.__reactResponderSystemActive&&(window.addEventListener("blur",eventListener),documentEventsBubblePhase.forEach(function(e){document.addEventListener(e,eventListener)}),documentEventsCapturePhase.forEach(function(e){document.addEventListener(e,eventListener,!0)}),window.__reactResponderSystemActive=!0)};export function addNode(e,n,t){setResponderId(n,e),responderListenersMap.set(e,t)};export function removeNode(e){currentResponder.id===e&&terminateResponder(),responderListenersMap.has(e)&&responderListenersMap.delete(e)};export function terminateResponder(){var e=currentResponder,n=e.id,t=e.node;if(null!=n&&null!=t){var o=getResponderConfig(n).onResponderTerminate;if(null!=o){var r=createResponderEvent({});r.currentTarget=t,o(r)}changeCurrentResponder(emptyResponder)}isEmulatingMouseEvents=!1,trackedTouchCount=0};export function getResponderNode(){return currentResponder.node};
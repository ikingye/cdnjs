"use strict";function _inheritsLoose(i,t){i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.__proto__=t}import AnimatedValue from"../nodes/AnimatedValue";import AnimatedValueXY from"../nodes/AnimatedValueXY";import Animation from"./Animation";import SpringConfig from"../SpringConfig";import invariant from"fbjs/lib/invariant";import{shouldUseNativeDriver}from"../NativeAnimatedHelper";var SpringAnimation=function(i){function t(t){var s,e,n,o,a,r,l,h,_,d,m,f;if((_=i.call(this)||this)._overshootClamping=null!==(s=t.overshootClamping)&&void 0!==s&&s,_._restDisplacementThreshold=null!==(e=t.restDisplacementThreshold)&&void 0!==e?e:.001,_._restSpeedThreshold=null!==(n=t.restSpeedThreshold)&&void 0!==n?n:.001,_._initialVelocity=null!==(o=t.velocity)&&void 0!==o?o:0,_._lastVelocity=null!==(a=t.velocity)&&void 0!==a?a:0,_._toValue=t.toValue,_._delay=null!==(r=t.delay)&&void 0!==r?r:0,_._useNativeDriver=shouldUseNativeDriver(t),_.__isInteraction=null!==(l=t.isInteraction)&&void 0!==l?l:!_._useNativeDriver,_.__iterations=null!==(h=t.iterations)&&void 0!==h?h:1,void 0!==t.stiffness||void 0!==t.damping||void 0!==t.mass)invariant(void 0===t.bounciness&&void 0===t.speed&&void 0===t.tension&&void 0===t.friction,"You can define one of bounciness/speed, tension/friction, or stiffness/damping/mass, but not more than one"),_._stiffness=null!==(d=t.stiffness)&&void 0!==d?d:100,_._damping=null!==(m=t.damping)&&void 0!==m?m:10,_._mass=null!==(f=t.mass)&&void 0!==f?f:1;else if(void 0!==t.bounciness||void 0!==t.speed){var v,u;invariant(void 0===t.tension&&void 0===t.friction&&void 0===t.stiffness&&void 0===t.damping&&void 0===t.mass,"You can define one of bounciness/speed, tension/friction, or stiffness/damping/mass, but not more than one");var p=SpringConfig.fromBouncinessAndSpeed(null!==(v=t.bounciness)&&void 0!==v?v:8,null!==(u=t.speed)&&void 0!==u?u:12);_._stiffness=p.stiffness,_._damping=p.damping,_._mass=1}else{var c,g,V=SpringConfig.fromOrigamiTensionAndFriction(null!==(c=t.tension)&&void 0!==c?c:40,null!==(g=t.friction)&&void 0!==g?g:7);_._stiffness=V.stiffness,_._damping=V.damping,_._mass=1}return invariant(_._stiffness>0,"Stiffness value must be greater than 0"),invariant(_._damping>0,"Damping value must be greater than 0"),invariant(_._mass>0,"Mass value must be greater than 0"),_}_inheritsLoose(t,i);var s=t.prototype;return s.__getNativeAnimationConfig=function(){var i;return{type:"spring",overshootClamping:this._overshootClamping,restDisplacementThreshold:this._restDisplacementThreshold,restSpeedThreshold:this._restSpeedThreshold,stiffness:this._stiffness,damping:this._damping,mass:this._mass,initialVelocity:null!==(i=this._initialVelocity)&&void 0!==i?i:this._lastVelocity,toValue:this._toValue,iterations:this.__iterations}},s.start=function(i,s,e,n,o){var a=this;if(this.__active=!0,this._startPosition=i,this._lastPosition=this._startPosition,this._onUpdate=s,this.__onEnd=e,this._lastTime=Date.now(),this._frameTime=0,n instanceof t){var r=n.getInternalState();this._lastPosition=r.lastPosition,this._lastVelocity=r.lastVelocity,this._initialVelocity=this._lastVelocity,this._lastTime=r.lastTime}var l=function(){a._useNativeDriver?a.__startNativeAnimation(o):a.onUpdate()};this._delay?this._timeout=setTimeout(l,this._delay):l()},s.getInternalState=function(){return{lastPosition:this._lastPosition,lastVelocity:this._lastVelocity,lastTime:this._lastTime}},s.onUpdate=function(){var i=Date.now();i>this._lastTime+64&&(i=this._lastTime+64);var t=(i-this._lastTime)/1e3;this._frameTime+=t;var s=this._damping,e=this._mass,n=this._stiffness,o=-this._initialVelocity,a=s/(2*Math.sqrt(n*e)),r=Math.sqrt(n/e),l=r*Math.sqrt(1-a*a),h=this._toValue-this._startPosition,_=0,d=0,m=this._frameTime;if(a<1){var f=Math.exp(-a*r*m);_=this._toValue-f*((o+a*r*h)/l*Math.sin(l*m)+h*Math.cos(l*m)),d=a*r*f*(Math.sin(l*m)*(o+a*r*h)/l+h*Math.cos(l*m))-f*(Math.cos(l*m)*(o+a*r*h)-l*h*Math.sin(l*m))}else{var v=Math.exp(-r*m);_=this._toValue-v*(h+(o+r*h)*m),d=v*(o*(m*r-1)+m*h*(r*r))}if(this._lastTime=i,this._lastPosition=_,this._lastVelocity=d,this._onUpdate(_),this.__active){var u=!1;this._overshootClamping&&0!==this._stiffness&&(u=this._startPosition<this._toValue?_>this._toValue:_<this._toValue);var p=Math.abs(d)<=this._restSpeedThreshold,c=!0;if(0!==this._stiffness&&(c=Math.abs(this._toValue-_)<=this._restDisplacementThreshold),u||p&&c)return 0!==this._stiffness&&(this._lastPosition=this._toValue,this._lastVelocity=0,this._onUpdate(this._toValue)),void this.__debouncedOnEnd({finished:!0});this._animationFrame=requestAnimationFrame(this.onUpdate.bind(this))}},s.stop=function(){i.prototype.stop.call(this),this.__active=!1,clearTimeout(this._timeout),global.cancelAnimationFrame(this._animationFrame),this.__debouncedOnEnd({finished:!1})},t}(Animation);export default SpringAnimation;
"use strict";exports.__esModule=!0,exports.default=void 0;var _createElement=_interopRequireDefault(require("../createElement")),_css=_interopRequireDefault(require("../StyleSheet/css")),_AssetRegistry=require("../../modules/AssetRegistry"),_resolveShadowValue=_interopRequireDefault(require("../StyleSheet/resolveShadowValue")),_ImageLoader=_interopRequireDefault(require("../../modules/ImageLoader")),_PixelRatio=_interopRequireDefault(require("../PixelRatio")),_StyleSheet=_interopRequireDefault(require("../StyleSheet")),_TextAncestorContext=_interopRequireDefault(require("../Text/TextAncestorContext")),_View=_interopRequireDefault(require("../View")),_react=_interopRequireWildcard(require("react"));function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var r,a={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e){Object.prototype.hasOwnProperty.call(e,o)&&((r=n?Object.getOwnPropertyDescriptor(e,o):null)&&(r.get||r.set)?Object.defineProperty(a,o,r):a[o]=e[o])}return a.default=e,t&&t.set(e,a),a}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var r,a=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,r)),a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var ERRORED="ERRORED",LOADED="LOADED",LOADING="LOADING",IDLE="IDLE",_filterId=0,svgDataUriPattern=/^(data:image\/svg\+xml;utf8,)(.*)/;function createTintColorSVG(e,t){return e&&null!=t?_react.default.createElement("svg",{style:{position:"absolute",height:0,visibility:"hidden",width:0}},_react.default.createElement("defs",null,_react.default.createElement("filter",{id:"tint-"+t},_react.default.createElement("feFlood",{floodColor:""+e,key:e}),_react.default.createElement("feComposite",{in2:"SourceAlpha",operator:"atop"})))):null}function getFlatStyle(e,t,r){var a,n=_objectSpread({},_StyleSheet.default.flatten(e)),o=n.filter,i=n.resizeMode,l=n.shadowOffset,u=n.tintColor,c=[],s=null;return o&&c.push(o),t&&c.push("blur("+t+"px)"),!l||(a=(0,_resolveShadowValue.default)(n))&&c.push("drop-shadow("+a+")"),u&&null!=r&&c.push("url(#tint-"+r+")"),0<c.length&&(s=c.join(" ")),delete n.shadowColor,delete n.shadowOpacity,delete n.shadowOffset,delete n.shadowRadius,delete n.tintColor,delete n.overlayColor,delete n.resizeMode,[n,i,s,u]}function resolveAssetDimensions(e){if("number"==typeof e){var t=(0,_AssetRegistry.getAssetByID)(e);return{height:t.height,width:t.width}}if(null!=e&&!Array.isArray(e)&&"object"==typeof e)return{height:e.height,width:e.width}}function resolveAssetUri(e){var t,r,a,n,o=null;if("number"==typeof e?(a=(t=(0,_AssetRegistry.getAssetByID)(e)).scales[0],1<t.scales.length&&(r=_PixelRatio.default.get(),a=t.scales.reduce(function(e,t){return Math.abs(t-r)<Math.abs(e-r)?t:e})),n=1!==a?"@"+a+"x":"",o=t?t.httpServerLocation+"/"+t.name+n+"."+t.type:""):"string"==typeof e?o=e:e&&"string"==typeof e.uri&&(o=e.uri),o){var i=o.match(svgDataUriPattern);if(i){var l=i[1],u=i[2];return""+l+encodeURIComponent(u)}}return o}var Image=(0,_react.forwardRef)(function(e,t){var r=e.accessibilityLabel,a=e.accessibilityRole,n=e.accessibilityState,o=e.accessible,i=e.blurRadius,l=e.defaultSource,u=e.draggable,c=e.importantForAccessibility,s=e.nativeID,d=e.onError,f=e.onLayout,p=e.onLoad,g=e.onLoadEnd,y=e.onLoadStart,h=e.pointerEvents,_=e.source,b=e.testID;if("production"!==process.env.NODE_ENV&&e.children)throw new Error("The <Image> component cannot contain children. If you want to render content on top of the image, consider using the <ImageBackground> component or absolute positioning.");var m=(0,_react.useState)(function(){var e=resolveAssetUri(_);if(null!=e&&_ImageLoader.default.has(e))return LOADED;return IDLE}),v=m[0],S=m[1],D=(0,_react.useState)({}),O=D[0],I=D[1],R=(0,_react.useContext)(_TextAncestorContext.default),w=(0,_react.useRef)(null),E=(0,_react.useRef)(_filterId++),A=(0,_react.useRef)(null),L=v===LOADED||v===LOADING&&null==l,j=getFlatStyle(e.style,i,E.current),q=j[0],x=j[1],P=j[2],k=j[3],C=e.resizeMode||x||"cover",z=L?_:l,M=resolveAssetUri(z),V=resolveAssetDimensions(z),F=M?'url("'+M+'")':null,W=function(){if(null!=w.current&&("center"===C||"repeat"===C)){var e=w.current,t=e.naturalHeight,r=e.naturalWidth,a=O.height,n=O.width;if(t&&r&&a&&n){var o=Math.min(1,n/r,a/t),i=Math.ceil(o*r),l=Math.ceil(o*t);return i+"px "+l+"px"}}}(),N=M?(0,_createElement.default)("img",{alt:r||"",classList:[classes.accessibilityImage],draggable:u||!1,ref:w,src:M}):null;return(0,_react.useEffect)(function(){t();var e=resolveAssetUri(_);function t(){null!=A.current&&(_ImageLoader.default.abort(A.current),A.current=null)}return null!=e&&(S(LOADING),y&&y(),A.current=_ImageLoader.default.load(e,function(){S(LOADED),p&&p(),g&&g()},function(){S(ERRORED),d&&d({nativeEvent:{error:"Failed to load resource "+e+" (404)"}}),g&&g()})),t},[_,A,S,d,p,g,y]),_react.default.createElement(_View.default,{accessibilityLabel:r,accessibilityRole:a,accessibilityState:n,accessible:o,importantForAccessibility:c,nativeID:s,onLayout:function(e){var t;"center"!==C&&"repeat"!==C&&!f||(t=e.nativeEvent.layout,f&&f(e),I(t))},pointerEvents:h,ref:t,style:[styles.root,R&&styles.inline,V,q],testID:b},_react.default.createElement(_View.default,{style:[styles.image,resizeModeStyles[C],{backgroundImage:F,filter:P},null!=W&&{backgroundSize:W}]}),N,createTintColorSVG(k,E.current))});Image.displayName="Image",Image.getSize=function(e,t,r){_ImageLoader.default.getSize(e,t,r)},Image.prefetch=function(e){return _ImageLoader.default.prefetch(e)},Image.queryCache=function(e){return _ImageLoader.default.queryCache(e)};var classes=_css.default.create({accessibilityImage:_objectSpread({},_StyleSheet.default.absoluteFillObject,{height:"100%",opacity:0,width:"100%",zIndex:-1})}),styles=_StyleSheet.default.create({root:{flexBasis:"auto",overflow:"hidden",zIndex:0},inline:{display:"inline-flex"},image:_objectSpread({},_StyleSheet.default.absoluteFillObject,{backgroundColor:"transparent",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundSize:"cover",height:"100%",width:"100%",zIndex:-1})}),resizeModeStyles=_StyleSheet.default.create({center:{backgroundSize:"auto"},contain:{backgroundSize:"contain"},cover:{backgroundSize:"cover"},none:{backgroundPosition:"0 0",backgroundSize:"auto"},repeat:{backgroundPosition:"0 0",backgroundRepeat:"repeat",backgroundSize:"auto"},stretch:{backgroundSize:"100% 100%"}}),_default=Image;exports.default=Image,module.exports=exports.default;
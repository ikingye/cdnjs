function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,o)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach(function(t){_defineProperty(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}import createElement from"../createElement";import css from"../StyleSheet/css";import{getAssetByID}from"../../modules/AssetRegistry";import resolveShadowValue from"../StyleSheet/resolveShadowValue";import ImageLoader from"../../modules/ImageLoader";import PixelRatio from"../PixelRatio";import StyleSheet from"../StyleSheet";import TextAncestorContext from"../Text/TextAncestorContext";import View from"../View";import React,{forwardRef,useContext,useEffect,useRef,useState}from"react";var ERRORED="ERRORED",LOADED="LOADED",LOADING="LOADING",IDLE="IDLE",_filterId=0,svgDataUriPattern=/^(data:image\/svg\+xml;utf8,)(.*)/;function createTintColorSVG(e,t){return e&&null!=t?React.createElement("svg",{style:{position:"absolute",height:0,visibility:"hidden",width:0}},React.createElement("defs",null,React.createElement("filter",{id:"tint-"+t},React.createElement("feFlood",{floodColor:""+e,key:e}),React.createElement("feComposite",{in2:"SourceAlpha",operator:"atop"})))):null}function getFlatStyle(e,t,r){var o=_objectSpread({},StyleSheet.flatten(e)),n=o.filter,a=o.resizeMode,i=o.shadowOffset,l=o.tintColor,s=[],c=null;if(n&&s.push(n),t&&s.push("blur("+t+"px)"),i){var u=resolveShadowValue(o);u&&s.push("drop-shadow("+u+")")}return l&&null!=r&&s.push("url(#tint-"+r+")"),s.length>0&&(c=s.join(" ")),delete o.shadowColor,delete o.shadowOpacity,delete o.shadowOffset,delete o.shadowRadius,delete o.tintColor,delete o.overlayColor,delete o.resizeMode,[o,a,c,l]}function resolveAssetDimensions(e){if("number"==typeof e){var t=getAssetByID(e);return{height:t.height,width:t.width}}if(null!=e&&!Array.isArray(e)&&"object"==typeof e)return{height:e.height,width:e.width}}function resolveAssetUri(e){var t=null;if("number"==typeof e){var r=getAssetByID(e),o=r.scales[0];if(r.scales.length>1){var n=PixelRatio.get();o=r.scales.reduce(function(e,t){return Math.abs(t-n)<Math.abs(e-n)?t:e})}var a=1!==o?"@"+o+"x":"";t=r?r.httpServerLocation+"/"+r.name+a+"."+r.type:""}else"string"==typeof e?t=e:e&&"string"==typeof e.uri&&(t=e.uri);if(t){var i=t.match(svgDataUriPattern);if(i){var l=i[1],s=i[2];return""+l+encodeURIComponent(s)}}return t}var Image=forwardRef(function(e,t){var r=e.accessibilityLabel,o=e.accessibilityRole,n=e.accessibilityState,a=e.accessible,i=e.blurRadius,l=e.defaultSource,s=e.draggable,c=e.importantForAccessibility,u=e.nativeID,d=e.onError,f=e.onLayout,g=e.onLoad,p=e.onLoadEnd,h=e.onLoadStart,m=e.pointerEvents,y=e.source,b=e.testID;if("production"!==process.env.NODE_ENV&&e.children)throw new Error("The <Image> component cannot contain children. If you want to render content on top of the image, consider using the <ImageBackground> component or absolute positioning.");var v=useState(function(){var e=resolveAssetUri(y);if(null!=e&&ImageLoader.has(e))return LOADED;return IDLE}),S=v[0],I=v[1],w=useState({}),E=w[0],D=w[1],O=useContext(TextAncestorContext),R=useRef(null),L=useRef(_filterId++),A=useRef(null),x=S===LOADED||S===LOADING&&null==l,j=getFlatStyle(e.style,i,L.current),P=j[0],k=j[1],z=j[2],C=j[3],M=e.resizeMode||k||"cover",V=x?y:l,_=resolveAssetUri(V),F=resolveAssetDimensions(V),N=_?'url("'+_+'")':null,T=function(){if(null!=R.current&&("center"===M||"repeat"===M)){var e=R.current,t=e.naturalHeight,r=e.naturalWidth,o=E.height,n=E.width;if(t&&r&&o&&n){var a=Math.min(1,n/r,o/t),i=Math.ceil(a*r),l=Math.ceil(a*t);return i+"px "+l+"px"}}}(),U=_?createElement("img",{alt:r||"",classList:[classes.accessibilityImage],draggable:s||!1,ref:R,src:_}):null;return useEffect(function(){t();var e=resolveAssetUri(y);function t(){null!=A.current&&(ImageLoader.abort(A.current),A.current=null)}return null!=e&&(I(LOADING),h&&h(),A.current=ImageLoader.load(e,function(e){I(LOADED),g&&g(),p&&p()},function(){I(ERRORED),d&&d({nativeEvent:{error:"Failed to load resource "+e+" (404)"}}),p&&p()})),t},[y,A,I,d,g,p,h]),React.createElement(View,{accessibilityLabel:r,accessibilityRole:o,accessibilityState:n,accessible:a,importantForAccessibility:c,nativeID:u,onLayout:function(e){if("center"===M||"repeat"===M||f){var t=e.nativeEvent.layout;f&&f(e),D(t)}},pointerEvents:m,ref:t,style:[styles.root,O&&styles.inline,F,P],testID:b},React.createElement(View,{style:[styles.image,resizeModeStyles[M],{backgroundImage:N,filter:z},null!=T&&{backgroundSize:T}]}),U,createTintColorSVG(C,L.current))});Image.displayName="Image",Image.getSize=function(e,t,r){ImageLoader.getSize(e,t,r)},Image.prefetch=function(e){return ImageLoader.prefetch(e)},Image.queryCache=function(e){return ImageLoader.queryCache(e)};var classes=css.create({accessibilityImage:_objectSpread({},StyleSheet.absoluteFillObject,{height:"100%",opacity:0,width:"100%",zIndex:-1})}),styles=StyleSheet.create({root:{flexBasis:"auto",overflow:"hidden",zIndex:0},inline:{display:"inline-flex"},image:_objectSpread({},StyleSheet.absoluteFillObject,{backgroundColor:"transparent",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundSize:"cover",height:"100%",width:"100%",zIndex:-1})}),resizeModeStyles=StyleSheet.create({center:{backgroundSize:"auto"},contain:{backgroundSize:"contain"},cover:{backgroundSize:"cover"},none:{backgroundPosition:"0 0",backgroundSize:"auto"},repeat:{backgroundPosition:"0 0",backgroundRepeat:"repeat",backgroundSize:"auto"},stretch:{backgroundSize:"100% 100%"}});export default Image;
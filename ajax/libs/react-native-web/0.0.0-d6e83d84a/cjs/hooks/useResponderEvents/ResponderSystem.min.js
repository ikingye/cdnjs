"use strict";exports.__esModule=!0,exports.attachListeners=attachListeners,exports.addNode=addNode,exports.removeNode=removeNode,exports.terminateResponder=terminateResponder,exports.getResponderNode=getResponderNode;var _ExecutionEnvironment=require("fbjs/lib/ExecutionEnvironment"),_createResponderEvent=_interopRequireDefault(require("./createResponderEvent")),_ResponderEventTypes=require("./ResponderEventTypes"),_utils=require("./utils"),_ResponderTouchHistoryStore=_interopRequireDefault(require("./ResponderTouchHistoryStore"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var emptyObject={},startRegistration=["onStartShouldSetResponderCapture","onStartShouldSetResponder",{bubbles:!0}],moveRegistration=["onMoveShouldSetResponderCapture","onMoveShouldSetResponder",{bubbles:!0}],scrollRegistration=["onScrollShouldSetResponderCapture","onScrollShouldSetResponder",{bubbles:!1}],shouldSetResponderEvents={touchstart:startRegistration,mousedown:startRegistration,touchmove:moveRegistration,mousemove:moveRegistration,scroll:scrollRegistration},emptyResponder={id:null,idPath:null,node:null},responderListenersMap=new Map,isEmulatingMouseEvents=!1,trackedTouchCount=0,currentResponder={id:null,node:null,idPath:null};function changeCurrentResponder(e){currentResponder=e}function getResponderConfig(e){var n=responderListenersMap.get(e);return null!=n?n:emptyObject}function eventListener(e){var n,t,r,o,s,u,d,i,a,l,c,p,R,h,v,m,g,E,f,T,b,C,_,S,y,M=e.type,P=e.target;"touchstart"===M&&(isEmulatingMouseEvents=!0),("touchmove"===M||1<trackedTouchCount)&&(isEmulatingMouseEvents=!1),"mousedown"===M&&isEmulatingMouseEvents||"mousemove"===M&&isEmulatingMouseEvents||"mousemove"===M&&trackedTouchCount<1||(isEmulatingMouseEvents&&"mouseup"===M?0===trackedTouchCount&&(isEmulatingMouseEvents=!1):(n=(0,_ResponderEventTypes.isStartish)(M)&&(0,_utils.isPrimaryPointerDown)(e),t=(0,_ResponderEventTypes.isMoveish)(M),r=(0,_ResponderEventTypes.isEndish)(M),o=(0,_ResponderEventTypes.isScroll)(M),s=(0,_ResponderEventTypes.isSelectionChange)(M),u=(0,_createResponderEvent.default)(e),(n||t||r)&&(e.touches?trackedTouchCount=e.touches.length:n?trackedTouchCount=1:r&&(trackedTouchCount=0),_ResponderTouchHistoryStore.default.recordTouchTrack(M,u.nativeEvent)),R=(0,_utils.getResponderPaths)(e),d=!1,(n||t||o&&0<trackedTouchCount)&&(a=currentResponder.idPath,l=R.idPath,null!=a&&null!=l&&(R=null!=(c=(0,_utils.getLowestCommonAncestor)(a,l))?(p=l.indexOf(c)+(c===currentResponder.id?1:0),{idPath:l.slice(p),nodePath:R.nodePath.slice(p)}):null),null!=R&&null!=(i=findWantsResponder(R,e,u))&&(attemptTransfer(u,i),d=!0)),null!=currentResponder.id&&null!=currentResponder.node&&(h=currentResponder.id,v=currentResponder.node,g=(m=getResponderConfig(h)).onResponderStart,E=m.onResponderMove,f=m.onResponderEnd,T=m.onResponderRelease,b=m.onResponderTerminate,C=m.onResponderTerminationRequest,u.bubbles=!1,u.cancelable=!1,u.currentTarget=v,n?null!=g&&g(u):t?null!=E&&E(u):(_=(0,_ResponderEventTypes.isCancelish)(M)||"contextmenu"===M||"blur"===M&&P===window||"blur"===M&&P.contains(v)&&e.relatedTarget!==v||o&&0===trackedTouchCount||o&&P.contains(v)&&P!==v||s&&(0,_utils.hasValidSelection)(e),S=r&&!_&&!(0,_utils.hasTargetTouches)(v,e.touches),r&&null!=f&&f(u),S&&(null!=T&&T(u),changeCurrentResponder(emptyResponder)),_&&(y=!0,"contextmenu"!==M&&"scroll"!==M&&"selectionchange"!==M||(d||null!=C&&!1===C(u))&&(y=!1),y&&(null!=b&&b(u),changeCurrentResponder(emptyResponder),isEmulatingMouseEvents=!1,trackedTouchCount=0))))))}function findWantsResponder(e,n,o){var t=shouldSetResponderEvents[n.type];if(null!=t){for(var s=e.idPath,r=e.nodePath,u=t[0],d=t[1],i=t[2].bubbles,a=function(e,n,t){var r=getResponderConfig(e)[t];if(null!=r&&!0===r(o))return{id:e,node:n,idPath:s}},l=s.length-1;0<=l;l--){var c=a(s[l],r[l],u);if(null!=c)return c;if(!0===o.isPropagationStopped())return}if(i)for(var p=0;p<s.length;p++){var R=a(s[p],r[p],d);if(null!=R)return R;if(!0===o.isPropagationStopped())return}else{var h=s[0],v=r[0];if(n.target===v)return a(h,v,d)}}}function attemptTransfer(e,n){var t,r,o,s=currentResponder.id,u=currentResponder.node,d=n.id,i=n.node,a=getResponderConfig(d),l=a.onResponderGrant,c=a.onResponderReject;e.bubbles=!1,e.cancelable=!1,e.currentTarget=i,null==s?(null!=l&&(e.currentTarget=i,e.dispatchConfig.registrationName="onResponderGrant",l(e)),changeCurrentResponder(n)):(r=(t=getResponderConfig(s)).onResponderTerminate,null!=(o=t.onResponderTerminationRequest)&&o(e)?(null!=r&&(e.currentTarget=u,r(e)),null!=l&&l(e),changeCurrentResponder(n)):null!=c&&c(e))}var documentEventsCapturePhase=["blur","scroll"],documentEventsBubblePhase=["mousedown","mousemove","mouseup","dragstart","touchstart","touchmove","touchend","touchcancel","contextmenu","select","selectionchange"];function attachListeners(){_ExecutionEnvironment.canUseDOM&&null==window.__reactResponderSystemActive&&(window.addEventListener("blur",eventListener),documentEventsBubblePhase.forEach(function(e){document.addEventListener(e,eventListener)}),documentEventsCapturePhase.forEach(function(e){document.addEventListener(e,eventListener,!0)}),window.__reactResponderSystemActive=!0)}function addNode(e,n,t){(0,_utils.setResponderId)(n,e),responderListenersMap.set(e,t)}function removeNode(e){currentResponder.id===e&&terminateResponder(),responderListenersMap.has(e)&&responderListenersMap.delete(e)}function terminateResponder(){var e,n,t=currentResponder.id,r=currentResponder.node;null!=t&&null!=r&&(null!=(e=getResponderConfig(t).onResponderTerminate)&&((n=(0,_createResponderEvent.default)({})).currentTarget=r,e(n)),changeCurrentResponder(emptyResponder)),isEmulatingMouseEvents=!1,trackedTouchCount=0}function getResponderNode(){return currentResponder.node}
"use strict";const lru=require("tiny-lru"),secureJson=require("secure-json-parse"),{kDefaultJsonParse:kDefaultJsonParse,kContentTypeParser:kContentTypeParser,kBodyLimit:kBodyLimit,kRequestPayloadStream:kRequestPayloadStream,kState:kState,kTestInternals:kTestInternals}=require("./symbols"),{FST_ERR_CTP_INVALID_TYPE:FST_ERR_CTP_INVALID_TYPE,FST_ERR_CTP_EMPTY_TYPE:FST_ERR_CTP_EMPTY_TYPE,FST_ERR_CTP_ALREADY_PRESENT:FST_ERR_CTP_ALREADY_PRESENT,FST_ERR_CTP_INVALID_HANDLER:FST_ERR_CTP_INVALID_HANDLER,FST_ERR_CTP_INVALID_PARSE_TYPE:FST_ERR_CTP_INVALID_PARSE_TYPE,FST_ERR_CTP_BODY_TOO_LARGE:FST_ERR_CTP_BODY_TOO_LARGE,FST_ERR_CTP_INVALID_MEDIA_TYPE:FST_ERR_CTP_INVALID_MEDIA_TYPE,FST_ERR_CTP_INVALID_CONTENT_LENGTH:FST_ERR_CTP_INVALID_CONTENT_LENGTH,FST_ERR_CTP_EMPTY_JSON_BODY:FST_ERR_CTP_EMPTY_JSON_BODY}=require("./errors"),{emitWarning:emitWarning}=require("./warnings");function ContentTypeParser(e,t,r){this[kDefaultJsonParse]=getDefaultJsonParser(t,r),this.customParsers={},this.customParsers["application/json"]=new Parser(!0,!1,e,this[kDefaultJsonParse]),this.customParsers["text/plain"]=new Parser(!0,!1,e,defaultPlainTextParser),this.parserList=["application/json","text/plain"],this.cache=lru(100)}function rawBody(e,t,r,s,n){var a=s.asString,i=null===r.limit?s.bodyLimit:r.limit,o=void 0===e.headers["content-length"]?NaN:Number.parseInt(e.headers["content-length"],10);if(o>i)return void t.send(new FST_ERR_CTP_BODY_TOO_LARGE);var _=0,T=!0===a?"":[];const P=e[kRequestPayloadStream]||e.raw;function u(e){if(_+=e.length,(P.receivedEncodedLength||_)>i)return P.removeListener("data",u),P.removeListener("end",d),P.removeListener("error",d),void t.send(new FST_ERR_CTP_BODY_TOO_LARGE);!0===a?T+=e:T.push(e)}function d(r){if(P.removeListener("data",u),P.removeListener("end",d),P.removeListener("error",d),void 0!==r)return r.statusCode=400,void t.code(r.statusCode).send(r);if(!0===a&&(_=Buffer.byteLength(T)),Number.isNaN(o)||(P.receivedEncodedLength||_)===o){!1===a&&(T=Buffer.concat(T));var i=s.fn(e,T,n);i&&"function"==typeof i.then&&i.then(e=>n(null,e),n)}else t.send(new FST_ERR_CTP_INVALID_CONTENT_LENGTH)}!0===a&&P.setEncoding("utf8"),P.on("data",u),P.on("end",d),P.on("error",d),P.resume()}function getDefaultJsonParser(e,t){return function(r,s,n){if(""===s||null==s)return n(new FST_ERR_CTP_EMPTY_JSON_BODY,void 0);try{var a=secureJson.parse(s,{protoAction:e,constructorAction:t})}catch(e){return e.statusCode=400,n(e,void 0)}n(null,a)}}function defaultPlainTextParser(e,t,r){r(null,t)}function Parser(e,t,r,s){this.asString=e,this.asBuffer=t,this.bodyLimit=r,this.fn=s,s.length===("AsyncFunction"===s.constructor.name?1:2)&&(emitWarning("FSTDEP003"),this.isDeprecatedSignature=!0)}function buildContentTypeParser(e){const t=new ContentTypeParser;return t[kDefaultJsonParse]=e[kDefaultJsonParse],Object.assign(t.customParsers,e.customParsers),t.parserList=e.parserList.slice(),t}function addContentTypeParser(e,t,r){if(this[kState].started)throw new Error('Cannot call "addContentTypeParser" when fastify instance is already started!');return"function"==typeof t&&(r=t,t={}),t||(t={}),t.bodyLimit||(t.bodyLimit=this[kBodyLimit]),Array.isArray(e)?e.forEach(e=>this[kContentTypeParser].add(e,t,r)):this[kContentTypeParser].add(e,t,r),this}function hasContentTypeParser(e){return this[kContentTypeParser].hasParser(e)}ContentTypeParser.prototype.add=function(e,t,r){if("string"!=typeof e)throw new FST_ERR_CTP_INVALID_TYPE;if(0===e.length)throw new FST_ERR_CTP_EMPTY_TYPE;if("function"!=typeof r)throw new FST_ERR_CTP_INVALID_HANDLER;if(this.hasParser(e))throw new FST_ERR_CTP_ALREADY_PRESENT(e);if(void 0!==t.parseAs&&"string"!==t.parseAs&&"buffer"!==t.parseAs)throw new FST_ERR_CTP_INVALID_PARSE_TYPE(t.parseAs);const s=new Parser("string"===t.parseAs,"buffer"===t.parseAs,t.bodyLimit,r);"*"===e?(this.parserList.push(""),this.customParsers[""]=s):("application/json"!==e&&this.parserList.unshift(e),this.customParsers[e]=s)},ContentTypeParser.prototype.hasParser=function(e){return"application/json"===e?this.customParsers["application/json"].fn!==this[kDefaultJsonParse]:"text/plain"===e?this.customParsers["text/plain"].fn!==defaultPlainTextParser:e in this.customParsers},ContentTypeParser.prototype.getParser=function(e){for(var t=0;t<this.parserList.length;t++)if(e.indexOf(this.parserList[t])>-1){var r=this.customParsers[this.parserList[t]];return this.cache.set(e,r),r}return this.customParsers[""]},ContentTypeParser.prototype.run=function(e,t,r,s){var n=this.cache.get(e)||this.getParser(e);if(void 0===n)s.send(new FST_ERR_CTP_INVALID_MEDIA_TYPE(e));else if(!0===n.asString||!0===n.asBuffer)rawBody(r,s,s.context._parserOptions,n,i);else{var a;(a=n.isDeprecatedSignature?n.fn(r[kRequestPayloadStream],i):n.fn(r,r[kRequestPayloadStream],i))&&"function"==typeof a.then&&a.then(e=>i(null,e),i)}function i(e,n){e?s.send(e):(r.body=n,t(r,s))}},module.exports=ContentTypeParser,module.exports.helpers={buildContentTypeParser:buildContentTypeParser,addContentTypeParser:addContentTypeParser,hasContentTypeParser:hasContentTypeParser},module.exports[kTestInternals]={rawBody:rawBody};
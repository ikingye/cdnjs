"use strict";const FindMyWay=require("find-my-way"),proxyAddr=require("proxy-addr"),Context=require("./context"),handleRequest=require("./handleRequest"),{hookRunner:hookRunner,hookIterator:hookIterator,lifecycleHooks:lifecycleHooks}=require("./hooks"),supportedMethods=["DELETE","GET","HEAD","PATCH","POST","PUT","OPTIONS"],validation=require("./validation"),{normalizeSchema:normalizeSchema}=require("./schemas"),{ValidatorSelector:ValidatorSelector,SerializerCompiler:buildDefaultSerializer}=require("./schema-compilers"),{emitWarning:emitWarning}=require("./warnings"),{compileSchemasForValidation:compileSchemasForValidation,compileSchemasForSerialization:compileSchemasForSerialization}=validation,{FST_ERR_SCH_VALIDATION_BUILD:FST_ERR_SCH_VALIDATION_BUILD,FST_ERR_SCH_SERIALIZATION_BUILD:FST_ERR_SCH_SERIALIZATION_BUILD}=require("./errors"),{kRoutePrefix:kRoutePrefix,kLogLevel:kLogLevel,kLogSerializers:kLogSerializers,kHooks:kHooks,kHooksDeprecatedPreParsing:kHooksDeprecatedPreParsing,kSchemas:kSchemas,kOptions:kOptions,kValidatorCompiler:kValidatorCompiler,kSerializerCompiler:kSerializerCompiler,kContentTypeParser:kContentTypeParser,kReply:kReply,kReplySerializerDefault:kReplySerializerDefault,kReplyIsError:kReplyIsError,kRequest:kRequest,kRequestPayloadStream:kRequestPayloadStream,kDisableRequestLogging:kDisableRequestLogging}=require("./symbols.js");function buildRouting(e){const r=FindMyWay(e.config);let t,o,i,n,a,s,l,u,d,c,h,p,m,f,g,k,y=!1;return{setup(e,r){t=r.avvio,o=r.fourOhFour,l=r.logger,u=r.hasLogger,d=r.setupResponseListeners,c=r.throwIfAlreadyStarted,h=getTrustProxyFn(e),i=e.trustProxy,n=e.requestIdHeader,a=e.querystringParser,s=e.requestIdLogLabel,p=e.genReqId,m=e.disableRequestLogging,f=e.ignoreTrailingSlash,g=!Object.prototype.hasOwnProperty.call(e,"return503OnClosing")||e.return503OnClosing,k=ValidatorSelector()},routing:r.lookup.bind(r),route:S,prepareRoute:function(e,r,t,o){if(o||"function"!=typeof t){if(o&&"function"==typeof o){if("[object Object]"!==Object.prototype.toString.call(t))throw new Error(`Options for ${e}:${r} route must be an object`);if(t.handler)throw"function"==typeof t.handler?new Error(`Duplicate handler for ${e}:${r} route is not allowed!`):new Error(`Handler for ${e}:${r} route must be a function`)}}else o=t,t={};return t=Object.assign({},t,{method:e,url:r,handler:o||t&&t.handler}),S.call(this,t)},routeHandler:R,closeRoutes:()=>{y=!0},printRoutes:r.prettyPrint.bind(r)};function S(e){if(c("Cannot add route when fastify instance is already started!"),Array.isArray(e.method)){for(var i=0;i<e.method.length;i++)if(-1===supportedMethods.indexOf(e.method[i]))throw new Error(`${e.method[i]} method is not supported!`)}else if(-1===supportedMethods.indexOf(e.method))throw new Error(`${e.method} method is not supported!`);if(!e.handler)throw new Error(`Missing handler function for ${e.method}:${e.url} route.`);validateBodyLimitOption(e.bodyLimit);const n=this[kRoutePrefix];return this.after((r,t)=>{var o=e.url||e.path;if("/"===o&&n.length>0)switch(e.prefixTrailingSlash){case"slash":a.call(this,o,r,t);break;case"no-slash":a.call(this,"",r,t);break;case"both":default:a.call(this,"",r,t),!0!==f&&a.call(this,o,r,t)}else"/"===o[0]&&n.endsWith("/")?a.call(this,o.slice(1),r,t):a.call(this,o,r,t)}),this;function a(i,a,s){const l=n+i;e.url=l,e.path=l,e.prefix=n,e.logLevel=e.logLevel||this[kLogLevel],(this[kLogSerializers]||e.logSerializers)&&(e.logSerializers=Object.assign(Object.create(this[kLogSerializers]),e.logSerializers)),null==e.attachValidation&&(e.attachValidation=!1);for(const r of this[kHooks].onRoute)try{r.call(this,e)}catch(e){return void s(e)}const u=e.config||{};u.url=l,u.method=e.method;const d=new Context(e.schema,e.handler.bind(this),this[kReply],this[kRequest],this[kContentTypeParser],u,this._errorHandler,e.bodyLimit,e.logLevel,e.logSerializers,e.attachValidation,this[kReplySerializerDefault]);try{r.on(e.method,e.url,{version:e.version},R,d)}catch(e){return void s(e)}t.once("preReady",()=>{for(const r of lifecycleHooks){const t=this[kHooks][r].concat(e[r]||[]).map(e=>{const t=e.bind(this);return"preParsing"===r&&e.length===("AsyncFunction"===e.constructor.name?2:3)&&(emitWarning("FSTDEP004"),t[kHooksDeprecatedPreParsing]=!0),t});d[r]=t.length?t:null}if(o.setContext(this,d),e.schema){d.schema=normalizeSchema(d.schema);const r=this[kSchemas];e.validatorCompiler||this[kValidatorCompiler]||this.setValidatorCompiler(k(r.getSchemas(),this[kOptions].ajv));try{compileSchemasForValidation(d,e.validatorCompiler||this[kValidatorCompiler],r)}catch(r){throw new FST_ERR_SCH_VALIDATION_BUILD(e.method,l,r.message)}!e.schema.response||e.serializerCompiler||this[kSerializerCompiler]||this.setSerializerCompiler(buildDefaultSerializer(r.getSchemas()));try{compileSchemasForSerialization(d,e.serializerCompiler||this[kSerializerCompiler],r)}catch(r){throw new FST_ERR_SCH_SERIALIZATION_BUILD(e.method,l,r.message)}}}),s(a)}}function R(e,r,t,o){if(!0===y&&(2!==e.httpVersionMajor&&(r.once("finish",()=>e.destroy()),r.setHeader("Connection","close")),g)){const e={"Content-Type":"application/json","Content-Length":"80"};return r.writeHead(503,e),void r.end('{"error":"Service Unavailable","message":"Service Unavailable","statusCode":503}')}var c,f=e.headers[n]||p(e),k=e.headers.host||e.headers[":authority"],S=e.connection.remoteAddress;i&&(S=proxyAddr(e,h),c=proxyAddr.all(e,h),void 0!==S&&e.headers["x-forwarded-host"]&&(k=e.headers["x-forwarded-host"]));var R={[s]:f,level:o.logLevel};o.logSerializers&&(R.serializers=o.logSerializers);var L=l.child(R);L[kDisableRequestLogging]=m;var P=e.url.indexOf("?"),v=a(P>-1?e.url.slice(P+1):""),q=new o.Request(f,t,e,v,e.headers,L,S,c,k),b=new o.Reply(r,o,q,L);!1===m&&L.info({req:q},"incoming request"),!0!==u&&null===o.onResponse||d(b),null!==o.onRequest?hookRunner(o.onRequest,hookIterator,q,b,runPreParsing):runPreParsing(null,q,b)}}function validateBodyLimitOption(e){if(void 0!==e&&(!Number.isInteger(e)||e<=0))throw new TypeError(`'bodyLimit' option must be an integer > 0. Got '${e}'`)}function runPreParsing(e,r,t){!0!==t.sent&&(null==e?(r[kRequestPayloadStream]=r.raw,null!==t.context.preParsing?preParsingHookRunner(t.context.preParsing,r,t,handleRequest):handleRequest(null,r,t)):t.send(e))}function preParsingHookRunner(e,r,t,o){let i=0;function n(l,u){if(t.sent)return;if(void 0!==u&&(r[kRequestPayloadStream]=u),l||i===e.length)return!l||l instanceof Error||(t[kReplyIsError]=!0),void o(l,r,t);const d=e[i++];let c;(c=d[kHooksDeprecatedPreParsing]?d(r,t,n):d(r,t,r[kRequestPayloadStream],n))&&"function"==typeof c.then&&c.then(a,s)}function a(e){n(null,e)}function s(e){n(e)}n(null,r[kRequestPayloadStream])}function getTrustProxyFn(e){const r=e.trustProxy;if("function"==typeof r)return r;if(!0===r)return function(){return!0};if("number"==typeof r)return function(e,t){return t<r};if("string"==typeof r){const e=r.split(",").map(e=>e.trim());return proxyAddr.compile(e)}return proxyAddr.compile(r||[])}module.exports={buildRouting:buildRouting,validateBodyLimitOption:validateBodyLimitOption};
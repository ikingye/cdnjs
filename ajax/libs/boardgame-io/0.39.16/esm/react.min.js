import"./Debug-91f604ee.js";import"redux";import{_ as _createClass,w as _classCallCheck,x as _inherits,y as _defineProperty,z as _possibleConstructorReturn,B as _getPrototypeOf,C as _assertThisInitialized,D as _toConsumableArray}from"./turn-order-dce10a02.js";import"immer";import"./reducer-b11048c2.js";import"flatted";import{M as MCTSBot}from"./ai-9b435d0e.js";import"./initialize-63a95034.js";import{C as Client$1}from"./client-ef3f3b30.js";import React from"react";import PropTypes from"prop-types";import Cookies from"react-cookies";import"./base-c99f5be2.js";import{S as SocketIO,L as Local}from"./socketio-043d62b9.js";import"./master-6720c47b.js";import"socket.io-client";function Client(e){var t;let{game:a,numPlayers:r,loading:n,board:s,multiplayer:i,enhancer:o,debug:l}=e;if(void 0===n){n=(()=>React.createElement("div",{className:"bgio-loading"},"connecting..."))}return(t=class extends React.Component{constructor(e){super(e),void 0===l&&(l=e.debug),this.client=Client$1({game:a,debug:l,numPlayers:r,multiplayer:i,gameID:e.gameID,playerID:e.playerID,credentials:e.credentials,enhancer:o})}componentDidMount(){this.unsubscribe=this.client.subscribe(()=>this.forceUpdate()),this.client.start()}componentWillUnmount(){this.client.stop(),this.unsubscribe()}componentDidUpdate(e){this.props.gameID!=e.gameID&&this.client.updateGameID(this.props.gameID),this.props.playerID!=e.playerID&&this.client.updatePlayerID(this.props.playerID),this.props.credentials!=e.credentials&&this.client.updateCredentials(this.props.credentials)}render(){const e=this.client.getState();if(null===e)return React.createElement(n);let t=null;return s&&(t=React.createElement(s,{...e,...this.props,isMultiplayer:!!i,moves:this.client.moves,events:this.client.events,gameID:this.client.gameID,playerID:this.client.playerID,reset:this.client.reset,undo:this.client.undo,redo:this.client.redo,log:this.client.log,gameMetadata:this.client.gameMetadata})),React.createElement("div",{className:"bgio-client"},t)}}).propTypes={gameID:PropTypes.string,playerID:PropTypes.string,credentials:PropTypes.string,debug:PropTypes.any},t.defaultProps={gameID:"default",playerID:null,credentials:null,debug:!0},t}var _LobbyConnectionImpl=function(){function e(t){var a=t.server,r=t.gameComponents,n=t.playerName,s=t.playerCredentials;_classCallCheck(this,e),this.gameComponents=r,this.playerName=n||"Visitor",this.playerCredentials=s,this.server=a,this.rooms=[]}return _createClass(e,[{key:"_baseUrl",value:function(){return"".concat(this.server||"","/games")}},{key:"refresh",value:async function(){try{this.rooms.length=0;var e=await fetch(this._baseUrl());if(200!==e.status)throw new Error("HTTP status "+e.status);var t=await e.json(),a=!0,r=!1,n=void 0;try{for(var s,i=t[Symbol.iterator]();!(a=(s=i.next()).done);a=!0){var o=s.value;if(this._getGameComponents(o)){var l=await fetch(this._baseUrl()+"/"+o),c=await l.json(),m=!0,p=!1,y=void 0;try{for(var u,h=c.rooms[Symbol.iterator]();!(m=(u=h.next()).done);m=!0){u.value.gameName=o}}catch(e){p=!0,y=e}finally{try{m||null==h.return||h.return()}finally{if(p)throw y}}this.rooms=this.rooms.concat(c.rooms)}}}catch(e){r=!0,n=e}finally{try{a||null==i.return||i.return()}finally{if(r)throw n}}}catch(e){throw new Error("failed to retrieve list of games ("+e+")")}}},{key:"_getGameInstance",value:function(e){var t=!0,a=!1,r=void 0;try{for(var n,s=this.rooms[Symbol.iterator]();!(t=(n=s.next()).done);t=!0){var i=n.value;if(i.gameID===e)return i}}catch(e){a=!0,r=e}finally{try{t||null==s.return||s.return()}finally{if(a)throw r}}}},{key:"_getGameComponents",value:function(e){var t=!0,a=!1,r=void 0;try{for(var n,s=this.gameComponents[Symbol.iterator]();!(t=(n=s.next()).done);t=!0){var i=n.value;if(i.game.name===e)return i}}catch(e){a=!0,r=e}finally{try{t||null==s.return||s.return()}finally{if(a)throw r}}}},{key:"_findPlayer",value:function(e){var t=!0,a=!1,r=void 0;try{for(var n,s=this.rooms[Symbol.iterator]();!(t=(n=s.next()).done);t=!0){var i=n.value;if(i.players.some(function(t){return t.name===e}))return i}}catch(e){a=!0,r=e}finally{try{t||null==s.return||s.return()}finally{if(a)throw r}}}},{key:"join",value:async function(e,t,a){try{var r=this._findPlayer(this.playerName);if(r)throw new Error("player has already joined "+r.gameID);if(!(r=this._getGameInstance(t)))throw new Error("game instance "+t+" not found");var n=await fetch(this._baseUrl()+"/"+e+"/"+t+"/join",{method:"POST",body:JSON.stringify({playerID:a,playerName:this.playerName}),headers:{"Content-Type":"application/json"}});if(200!==n.status)throw new Error("HTTP status "+n.status);var s=await n.json();r.players[Number.parseInt(a)].name=this.playerName,this.playerCredentials=s.playerCredentials}catch(e){throw new Error("failed to join room "+t+" ("+e+")")}}},{key:"leave",value:async function(e,t){try{var a=this._getGameInstance(t);if(!a)throw new Error("game instance not found");var r=!0,n=!1,s=void 0;try{for(var i,o=a.players[Symbol.iterator]();!(r=(i=o.next()).done);r=!0){var l=i.value;if(l.name===this.playerName){var c=await fetch(this._baseUrl()+"/"+e+"/"+t+"/leave",{method:"POST",body:JSON.stringify({playerID:l.id,credentials:this.playerCredentials}),headers:{"Content-Type":"application/json"}});if(200!==c.status)throw new Error("HTTP status "+c.status);return delete l.name,void delete this.playerCredentials}}}catch(e){n=!0,s=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw s}}throw new Error("player not found in room")}catch(e){throw new Error("failed to leave room "+t+" ("+e+")")}}},{key:"disconnect",value:async function(){var e=this._findPlayer(this.playerName);e&&await this.leave(e.gameName,e.gameID),this.rooms=[],this.playerName="Visitor"}},{key:"create",value:async function(e,t){try{var a=this._getGameComponents(e);if(!a)throw new Error("game not found");if(t<a.game.minPlayers||t>a.game.maxPlayers)throw new Error("invalid number of players "+t);var r=await fetch(this._baseUrl()+"/"+e+"/create",{method:"POST",body:JSON.stringify({numPlayers:t}),headers:{"Content-Type":"application/json"}});if(200!==r.status)throw new Error("HTTP status "+r.status)}catch(t){throw new Error("failed to create room for "+e+" ("+t+")")}}}]),e}();function LobbyConnection(e){return new _LobbyConnectionImpl(e)}var LobbyLoginForm=function(e){function t(){var e,a;_classCallCheck(this,t);for(var r=arguments.length,n=new Array(r),s=0;s<r;s++)n[s]=arguments[s];return a=_possibleConstructorReturn(this,(e=_getPrototypeOf(t)).call.apply(e,[this].concat(n))),_defineProperty(_assertThisInitialized(a),"state",{playerName:a.props.playerName,nameErrorMsg:""}),_defineProperty(_assertThisInitialized(a),"onClickEnter",function(){""!==a.state.playerName&&a.props.onEnter(a.state.playerName)}),_defineProperty(_assertThisInitialized(a),"onKeyPress",function(e){"Enter"===e.key&&a.onClickEnter()}),_defineProperty(_assertThisInitialized(a),"onChangePlayerName",function(e){var t=e.target.value.trim();a.setState({playerName:t,nameErrorMsg:t.length>0?"":"empty player name"})}),a}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){return React.createElement("div",null,React.createElement("p",{className:"phase-title"},"Choose a player name:"),React.createElement("input",{type:"text",value:this.state.playerName,onChange:this.onChangePlayerName,onKeyPress:this.onKeyPress}),React.createElement("span",{className:"buttons"},React.createElement("button",{className:"buttons",onClick:this.onClickEnter},"Enter")),React.createElement("br",null),React.createElement("span",{className:"error-msg"},this.state.nameErrorMsg,React.createElement("br",null)))}}]),t}(React.Component);_defineProperty(LobbyLoginForm,"propTypes",{playerName:PropTypes.string,onEnter:PropTypes.func.isRequired}),_defineProperty(LobbyLoginForm,"defaultProps",{playerName:""});var LobbyRoomInstance=function(e){function t(){var e,a;_classCallCheck(this,t);for(var r=arguments.length,n=new Array(r),s=0;s<r;s++)n[s]=arguments[s];return a=_possibleConstructorReturn(this,(e=_getPrototypeOf(t)).call.apply(e,[this].concat(n))),_defineProperty(_assertThisInitialized(a),"_createSeat",function(e){return e.name||"[free]"}),_defineProperty(_assertThisInitialized(a),"_createButtonJoin",function(e,t){return React.createElement("button",{key:"button-join-"+e.gameID,onClick:function(){return a.props.onClickJoin(e.gameName,e.gameID,""+t)}},"Join")}),_defineProperty(_assertThisInitialized(a),"_createButtonLeave",function(e){return React.createElement("button",{key:"button-leave-"+e.gameID,onClick:function(){return a.props.onClickLeave(e.gameName,e.gameID)}},"Leave")}),_defineProperty(_assertThisInitialized(a),"_createButtonPlay",function(e,t){return React.createElement("button",{key:"button-play-"+e.gameID,onClick:function(){return a.props.onClickPlay(e.gameName,{gameID:e.gameID,playerID:""+t,numPlayers:e.players.length})}},"Play")}),_defineProperty(_assertThisInitialized(a),"_createButtonSpectate",function(e){return React.createElement("button",{key:"button-spectate-"+e.gameID,onClick:function(){return a.props.onClickPlay(e.gameName,{gameID:e.gameID,numPlayers:e.players.length})}},"Spectate")}),_defineProperty(_assertThisInitialized(a),"_createInstanceButtons",function(e){var t=e.players.find(function(e){return e.name===a.props.playerName}),r=e.players.find(function(e){return!e.name});return t&&r?a._createButtonLeave(e):r?a._createButtonJoin(e,r.id):t?React.createElement("div",null,[a._createButtonPlay(e,t.id),a._createButtonLeave(e)]):a._createButtonSpectate(e)}),a}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this.props.room,t="OPEN";return e.players.find(function(e){return!e.name})||(t="RUNNING"),React.createElement("tr",{key:"line-"+e.gameID},React.createElement("td",{key:"cell-name-"+e.gameID},e.gameName),React.createElement("td",{key:"cell-status-"+e.gameID},t),React.createElement("td",{key:"cell-seats-"+e.gameID},e.players.map(this._createSeat).join(", ")),React.createElement("td",{key:"cell-buttons-"+e.gameID},this._createInstanceButtons(e)))}}]),t}(React.Component);_defineProperty(LobbyRoomInstance,"propTypes",{room:PropTypes.shape({gameName:PropTypes.string.isRequired,gameID:PropTypes.string.isRequired,players:PropTypes.array.isRequired}),playerName:PropTypes.string.isRequired,onClickJoin:PropTypes.func.isRequired,onClickLeave:PropTypes.func.isRequired,onClickPlay:PropTypes.func.isRequired});var LobbyCreateRoomForm=function(e){function t(e){var a;_classCallCheck(this,t),a=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e)),_defineProperty(_assertThisInitialized(a),"state",{selectedGame:0,numPlayers:2}),_defineProperty(_assertThisInitialized(a),"_createGameNameOption",function(e,t){return React.createElement("option",{key:"name-option-"+t,value:t},e.game.name)}),_defineProperty(_assertThisInitialized(a),"_createNumPlayersOption",function(e){return React.createElement("option",{key:"num-option-"+e,value:e},e)}),_defineProperty(_assertThisInitialized(a),"_createNumPlayersRange",function(e){return _toConsumableArray(new Array(e.maxPlayers+1).keys()).slice(e.minPlayers)}),_defineProperty(_assertThisInitialized(a),"onChangeNumPlayers",function(e){a.setState({numPlayers:Number.parseInt(e.target.value)})}),_defineProperty(_assertThisInitialized(a),"onChangeSelectedGame",function(e){var t=Number.parseInt(e.target.value);a.setState({selectedGame:t,numPlayers:a.props.games[t].game.minPlayers})}),_defineProperty(_assertThisInitialized(a),"onClickCreate",function(){a.props.createGame(a.props.games[a.state.selectedGame].game.name,a.state.numPlayers)});var r=!0,n=!1,s=void 0;try{for(var i,o=e.games[Symbol.iterator]();!(r=(i=o.next()).done);r=!0){var l=i.value.game;l.minPlayers||(l.minPlayers=1),l.maxPlayers||(l.maxPlayers=4),console.assert(l.maxPlayers>=l.minPlayers)}}catch(e){n=!0,s=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw s}}return a.state={selectedGame:0,numPlayers:e.games[0].game.minPlayers},a}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this;return React.createElement("div",null,React.createElement("select",{value:this.state.selectedGame,onChange:function(t){return e.onChangeSelectedGame(t)}},this.props.games.map(this._createGameNameOption)),React.createElement("span",null,"Players:"),React.createElement("select",{value:this.state.numPlayers,onChange:this.onChangeNumPlayers},this._createNumPlayersRange(this.props.games[this.state.selectedGame].game).map(this._createNumPlayersOption)),React.createElement("span",{className:"buttons"},React.createElement("button",{onClick:this.onClickCreate},"Create")))}}]),t}(React.Component);_defineProperty(LobbyCreateRoomForm,"propTypes",{games:PropTypes.array.isRequired,createGame:PropTypes.func.isRequired});var LobbyPhases={ENTER:"enter",PLAY:"play",LIST:"list"},Lobby=function(e){function t(e){var a;return _classCallCheck(this,t),a=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e)),_defineProperty(_assertThisInitialized(a),"state",{phase:LobbyPhases.ENTER,playerName:"Visitor",runningGame:null,errorMsg:"",credentialStore:{}}),_defineProperty(_assertThisInitialized(a),"_createConnection",function(e){var t=a.state.playerName;a.connection=LobbyConnection({server:e.lobbyServer,gameComponents:e.gameComponents,playerName:t,playerCredentials:a.state.credentialStore[t]})}),_defineProperty(_assertThisInitialized(a),"_updateCredentials",function(e,t){a.setState(function(a){var r=Object.assign({},a.credentialStore);return r[[e]]=t,{credentialStore:r}})}),_defineProperty(_assertThisInitialized(a),"_updateConnection",async function(){await a.connection.refresh(),a.forceUpdate()}),_defineProperty(_assertThisInitialized(a),"_enterLobby",function(e){a.setState({playerName:e,phase:LobbyPhases.LIST})}),_defineProperty(_assertThisInitialized(a),"_exitLobby",async function(){await a.connection.disconnect(),a.setState({phase:LobbyPhases.ENTER,errorMsg:""})}),_defineProperty(_assertThisInitialized(a),"_createRoom",async function(e,t){try{await a.connection.create(e,t),await a.connection.refresh(),a.setState({})}catch(e){a.setState({errorMsg:e.message})}}),_defineProperty(_assertThisInitialized(a),"_joinRoom",async function(e,t,r){try{await a.connection.join(e,t,r),await a.connection.refresh(),a._updateCredentials(a.connection.playerName,a.connection.playerCredentials)}catch(e){a.setState({errorMsg:e.message})}}),_defineProperty(_assertThisInitialized(a),"_leaveRoom",async function(e,t){try{await a.connection.leave(e,t),await a.connection.refresh(),a._updateCredentials(a.connection.playerName,a.connection.playerCredentials)}catch(e){a.setState({errorMsg:e.message})}}),_defineProperty(_assertThisInitialized(a),"_startGame",function(e,t){var r=a.connection._getGameComponents(e);if(r){var n=void 0;if(t.numPlayers>1&&(n=a.props.gameServer?SocketIO({server:a.props.gameServer}):SocketIO()),1==t.numPlayers){for(var s=r.game.maxPlayers,i={},o=1;o<s;o++)i[o+""]=MCTSBot;n=Local({bots:i})}var l={app:a.props.clientFactory({game:r.game,board:r.board,debug:a.props.debug,multiplayer:n}),gameID:t.gameID,playerID:t.numPlayers>1?t.playerID:"0",credentials:a.connection.playerCredentials};a.setState({phase:LobbyPhases.PLAY,runningGame:l})}else a.setState({errorMsg:"game "+e+" not supported"})}),_defineProperty(_assertThisInitialized(a),"_exitRoom",function(){a.setState({phase:LobbyPhases.LIST,runningGame:null})}),_defineProperty(_assertThisInitialized(a),"_getPhaseVisibility",function(e){return a.state.phase!==e?"hidden":"phase"}),_defineProperty(_assertThisInitialized(a),"renderRooms",function(e,t){return e.map(function(e){var r=e.gameID,n=e.gameName,s=e.players;return React.createElement(LobbyRoomInstance,{key:"instance-"+r,room:{gameID:r,gameName:n,players:Object.values(s)},playerName:t,onClickJoin:a._joinRoom,onClickLeave:a._leaveRoom,onClickPlay:a._startGame})})}),a._createConnection(a.props),setInterval(a._updateConnection,a.props.refreshInterval),a}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){var e=Cookies.load("lobbyState")||{};e.phase&&e.phase===LobbyPhases.PLAY&&(e.phase=LobbyPhases.LIST),this.setState({phase:e.phase||LobbyPhases.ENTER,playerName:e.playerName||"Visitor",credentialStore:e.credentialStore||{}})}},{key:"componentDidUpdate",value:function(e,t){var a=this.state.playerName,r=this.state.credentialStore[a];if(t.phase!==this.state.phase||t.credentialStore[a]!==r||t.playerName!==a){this._createConnection(this.props),this._updateConnection();var n={phase:this.state.phase,playerName:a,credentialStore:this.state.credentialStore};Cookies.save("lobbyState",n,{path:"/"})}}},{key:"render",value:function(){var e=this.props,t=e.gameComponents,a=e.renderer,r=this.state,n=r.errorMsg,s=r.playerName,i=r.phase,o=r.runningGame;return a?a({errorMsg:n,gameComponents:t,rooms:this.connection.rooms,phase:i,playerName:s,runningGame:o,handleEnterLobby:this._enterLobby,handleExitLobby:this._exitLobby,handleCreateRoom:this._createRoom,handleJoinRoom:this._joinRoom,handleLeaveRoom:this._leaveRoom,handleExitRoom:this._exitRoom,handleRefreshRooms:this._updateConnection,handleStartGame:this._startGame}):React.createElement("div",{id:"lobby-view",style:{padding:50}},React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.ENTER)},React.createElement(LobbyLoginForm,{key:s,playerName:s,onEnter:this._enterLobby})),React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.LIST)},React.createElement("p",null,"Welcome, ",s),React.createElement("div",{className:"phase-title",id:"game-creation"},React.createElement("span",null,"Create a room:"),React.createElement(LobbyCreateRoomForm,{games:t,createGame:this._createRoom})),React.createElement("p",{className:"phase-title"},"Join a room:"),React.createElement("div",{id:"instances"},React.createElement("table",null,React.createElement("tbody",null,this.renderRooms(this.connection.rooms,s))),React.createElement("span",{className:"error-msg"},n,React.createElement("br",null))),React.createElement("p",{className:"phase-title"},"Rooms that become empty are automatically deleted.")),React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.PLAY)},o&&React.createElement(o.app,{gameID:o.gameID,playerID:o.playerID,credentials:o.credentials}),React.createElement("div",{className:"buttons",id:"game-exit"},React.createElement("button",{onClick:this._exitRoom},"Exit game"))),React.createElement("div",{className:"buttons",id:"lobby-exit"},React.createElement("button",{onClick:this._exitLobby},"Exit lobby")))}}]),t}(React.Component);_defineProperty(Lobby,"propTypes",{gameComponents:PropTypes.array.isRequired,lobbyServer:PropTypes.string,gameServer:PropTypes.string,debug:PropTypes.bool,clientFactory:PropTypes.func,refreshInterval:PropTypes.number}),_defineProperty(Lobby,"defaultProps",{debug:!1,clientFactory:Client,refreshInterval:2e3});export{Client,Lobby};
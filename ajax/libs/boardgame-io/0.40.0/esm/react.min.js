import"./Debug-a3a215ad.js";import"redux";import{_ as _inherits,w as _createSuper,x as _createClass,y as _defineProperty,z as _classCallCheck,B as _assertThisInitialized,C as _createForOfIteratorHelper,D as _toConsumableArray}from"./turn-order-9d77ce4b.js";import"immer";import"./reducer-87e23572.js";import"flatted";import{M as MCTSBot}from"./ai-dd52f27f.js";import"./initialize-5f4d5382.js";import{C as Client$1}from"./client-5f602e0f.js";import{L as LobbyClient}from"./client-61b8ced8.js";import React from"react";import PropTypes from"prop-types";import Cookies from"react-cookies";import"./base-c99f5be2.js";import{S as SocketIO,L as Local}from"./socketio-d329d5e1.js";import"./master-710ceccc.js";import"socket.io-client";function Client(e){var t;let{game:a,numPlayers:r,loading:n,board:s,multiplayer:i,enhancer:o,debug:c}=e;if(void 0===n){n=(()=>React.createElement("div",{className:"bgio-loading"},"connecting..."))}return(t=class extends React.Component{constructor(e){super(e),void 0===c&&(c=e.debug),this.client=Client$1({game:a,debug:c,numPlayers:r,multiplayer:i,matchID:e.matchID,playerID:e.playerID,credentials:e.credentials,enhancer:o})}componentDidMount(){this.unsubscribe=this.client.subscribe(()=>this.forceUpdate()),this.client.start()}componentWillUnmount(){this.client.stop(),this.unsubscribe()}componentDidUpdate(e){this.props.matchID!=e.matchID&&this.client.updateMatchID(this.props.matchID),this.props.playerID!=e.playerID&&this.client.updatePlayerID(this.props.playerID),this.props.credentials!=e.credentials&&this.client.updateCredentials(this.props.credentials)}render(){const e=this.client.getState();if(null===e)return React.createElement(n);let t=null;return s&&(t=React.createElement(s,{...e,...this.props,isMultiplayer:!!i,moves:this.client.moves,events:this.client.events,matchID:this.client.matchID,playerID:this.client.playerID,reset:this.client.reset,undo:this.client.undo,redo:this.client.redo,log:this.client.log,matchData:this.client.matchData})),React.createElement("div",{className:"bgio-client"},t)}}).propTypes={matchID:PropTypes.string,playerID:PropTypes.string,credentials:PropTypes.string,debug:PropTypes.any},t.defaultProps={matchID:"default",playerID:null,credentials:null,debug:!0},t}class _LobbyConnectionImpl{constructor({server:e,gameComponents:t,playerName:a,playerCredentials:r}){this.client=new LobbyClient({server:e}),this.gameComponents=t,this.playerName=a||"Visitor",this.playerCredentials=r,this.matches=[]}async refresh(){try{this.matches=[];const e=await this.client.listGames();for(const t of e){if(!this._getGameComponents(t))continue;const{matches:e}=await this.client.listMatches(t);this.matches=this.matches.concat(e)}}catch(e){throw new Error("failed to retrieve list of matches ("+e+")")}}_getMatchInstance(e){for(let t of this.matches)if(t.matchID===e)return t}_getGameComponents(e){for(let t of this.gameComponents)if(t.game.name===e)return t}_findPlayer(e){for(let t of this.matches)if(t.players.some(t=>t.name===e))return t}async join(e,t,a){try{let r=this._findPlayer(this.playerName);if(r)throw new Error("player has already joined "+r.matchID);if(!(r=this._getMatchInstance(t)))throw new Error("game instance "+t+" not found");const n=await this.client.joinMatch(e,t,{playerID:a,playerName:this.playerName});r.players[Number.parseInt(a)].name=this.playerName,this.playerCredentials=n.playerCredentials}catch(e){throw new Error("failed to join match "+t+" ("+e+")")}}async leave(e,t){try{let a=this._getMatchInstance(t);if(!a)throw new Error("match instance not found");for(const r of a.players)if(r.name===this.playerName)return await this.client.leaveMatch(e,t,{playerID:r.id.toString(),credentials:this.playerCredentials}),delete r.name,void delete this.playerCredentials;throw new Error("player not found in match")}catch(e){throw new Error("failed to leave match "+t+" ("+e+")")}}async disconnect(){let e=this._findPlayer(this.playerName);e&&await this.leave(e.gameName,e.matchID),this.matches=[],this.playerName="Visitor"}async create(e,t){try{const a=this._getGameComponents(e);if(!a)throw new Error("game not found");if(t<a.game.minPlayers||t>a.game.maxPlayers)throw new Error("invalid number of players "+t);await this.client.createMatch(e,{numPlayers:t})}catch(t){throw new Error("failed to create match for "+e+" ("+t+")")}}}function LobbyConnection(e){return new _LobbyConnectionImpl(e)}var LobbyLoginForm=function(e){_inherits(a,e);var t=_createSuper(a);function a(){var e;_classCallCheck(this,a);for(var r=arguments.length,n=new Array(r),s=0;s<r;s++)n[s]=arguments[s];return e=t.call.apply(t,[this].concat(n)),_defineProperty(_assertThisInitialized(e),"state",{playerName:e.props.playerName,nameErrorMsg:""}),_defineProperty(_assertThisInitialized(e),"onClickEnter",function(){""!==e.state.playerName&&e.props.onEnter(e.state.playerName)}),_defineProperty(_assertThisInitialized(e),"onKeyPress",function(t){"Enter"===t.key&&e.onClickEnter()}),_defineProperty(_assertThisInitialized(e),"onChangePlayerName",function(t){var a=t.target.value.trim();e.setState({playerName:a,nameErrorMsg:a.length>0?"":"empty player name"})}),e}return _createClass(a,[{key:"render",value:function(){return React.createElement("div",null,React.createElement("p",{className:"phase-title"},"Choose a player name:"),React.createElement("input",{type:"text",value:this.state.playerName,onChange:this.onChangePlayerName,onKeyPress:this.onKeyPress}),React.createElement("span",{className:"buttons"},React.createElement("button",{className:"buttons",onClick:this.onClickEnter},"Enter")),React.createElement("br",null),React.createElement("span",{className:"error-msg"},this.state.nameErrorMsg,React.createElement("br",null)))}}]),a}(React.Component);_defineProperty(LobbyLoginForm,"propTypes",{playerName:PropTypes.string,onEnter:PropTypes.func.isRequired}),_defineProperty(LobbyLoginForm,"defaultProps",{playerName:""});var LobbyMatchInstance=function(e){_inherits(a,e);var t=_createSuper(a);function a(){var e;_classCallCheck(this,a);for(var r=arguments.length,n=new Array(r),s=0;s<r;s++)n[s]=arguments[s];return e=t.call.apply(t,[this].concat(n)),_defineProperty(_assertThisInitialized(e),"_createSeat",function(e){return e.name||"[free]"}),_defineProperty(_assertThisInitialized(e),"_createButtonJoin",function(t,a){return React.createElement("button",{key:"button-join-"+t.matchID,onClick:function(){return e.props.onClickJoin(t.gameName,t.matchID,""+a)}},"Join")}),_defineProperty(_assertThisInitialized(e),"_createButtonLeave",function(t){return React.createElement("button",{key:"button-leave-"+t.matchID,onClick:function(){return e.props.onClickLeave(t.gameName,t.matchID)}},"Leave")}),_defineProperty(_assertThisInitialized(e),"_createButtonPlay",function(t,a){return React.createElement("button",{key:"button-play-"+t.matchID,onClick:function(){return e.props.onClickPlay(t.gameName,{matchID:t.matchID,playerID:""+a,numPlayers:t.players.length})}},"Play")}),_defineProperty(_assertThisInitialized(e),"_createButtonSpectate",function(t){return React.createElement("button",{key:"button-spectate-"+t.matchID,onClick:function(){return e.props.onClickPlay(t.gameName,{matchID:t.matchID,numPlayers:t.players.length})}},"Spectate")}),_defineProperty(_assertThisInitialized(e),"_createInstanceButtons",function(t){var a=t.players.find(function(t){return t.name===e.props.playerName}),r=t.players.find(function(e){return!e.name});return a&&r?e._createButtonLeave(t):r?e._createButtonJoin(t,r.id):a?React.createElement("div",null,[e._createButtonPlay(t,a.id),e._createButtonLeave(t)]):e._createButtonSpectate(t)}),e}return _createClass(a,[{key:"render",value:function(){var e=this.props.match,t="OPEN";return e.players.find(function(e){return!e.name})||(t="RUNNING"),React.createElement("tr",{key:"line-"+e.matchID},React.createElement("td",{key:"cell-name-"+e.matchID},e.gameName),React.createElement("td",{key:"cell-status-"+e.matchID},t),React.createElement("td",{key:"cell-seats-"+e.matchID},e.players.map(this._createSeat).join(", ")),React.createElement("td",{key:"cell-buttons-"+e.matchID},this._createInstanceButtons(e)))}}]),a}(React.Component);_defineProperty(LobbyMatchInstance,"propTypes",{match:PropTypes.shape({gameName:PropTypes.string.isRequired,matchID:PropTypes.string.isRequired,players:PropTypes.array.isRequired}),playerName:PropTypes.string.isRequired,onClickJoin:PropTypes.func.isRequired,onClickLeave:PropTypes.func.isRequired,onClickPlay:PropTypes.func.isRequired});var LobbyCreateMatchForm=function(e){_inherits(a,e);var t=_createSuper(a);function a(e){var r;_classCallCheck(this,a),r=t.call(this,e),_defineProperty(_assertThisInitialized(r),"state",{selectedGame:0,numPlayers:2}),_defineProperty(_assertThisInitialized(r),"_createGameNameOption",function(e,t){return React.createElement("option",{key:"name-option-"+t,value:t},e.game.name)}),_defineProperty(_assertThisInitialized(r),"_createNumPlayersOption",function(e){return React.createElement("option",{key:"num-option-"+e,value:e},e)}),_defineProperty(_assertThisInitialized(r),"_createNumPlayersRange",function(e){return _toConsumableArray(new Array(e.maxPlayers+1).keys()).slice(e.minPlayers)}),_defineProperty(_assertThisInitialized(r),"onChangeNumPlayers",function(e){r.setState({numPlayers:Number.parseInt(e.target.value)})}),_defineProperty(_assertThisInitialized(r),"onChangeSelectedGame",function(e){var t=Number.parseInt(e.target.value);r.setState({selectedGame:t,numPlayers:r.props.games[t].game.minPlayers})}),_defineProperty(_assertThisInitialized(r),"onClickCreate",function(){r.props.createMatch(r.props.games[r.state.selectedGame].game.name,r.state.numPlayers)});var n,s=_createForOfIteratorHelper(e.games);try{for(s.s();!(n=s.n()).done;){var i=n.value.game;i.minPlayers||(i.minPlayers=1),i.maxPlayers||(i.maxPlayers=4),console.assert(i.maxPlayers>=i.minPlayers)}}catch(e){s.e(e)}finally{s.f()}return r.state={selectedGame:0,numPlayers:e.games[0].game.minPlayers},r}return _createClass(a,[{key:"render",value:function(){var e=this;return React.createElement("div",null,React.createElement("select",{value:this.state.selectedGame,onChange:function(t){return e.onChangeSelectedGame(t)}},this.props.games.map(this._createGameNameOption)),React.createElement("span",null,"Players:"),React.createElement("select",{value:this.state.numPlayers,onChange:this.onChangeNumPlayers},this._createNumPlayersRange(this.props.games[this.state.selectedGame].game).map(this._createNumPlayersOption)),React.createElement("span",{className:"buttons"},React.createElement("button",{onClick:this.onClickCreate},"Create")))}}]),a}(React.Component);_defineProperty(LobbyCreateMatchForm,"propTypes",{games:PropTypes.array.isRequired,createMatch:PropTypes.func.isRequired});var LobbyPhases={ENTER:"enter",PLAY:"play",LIST:"list"},Lobby=function(e){_inherits(a,e);var t=_createSuper(a);function a(e){var r;return _classCallCheck(this,a),r=t.call(this,e),_defineProperty(_assertThisInitialized(r),"state",{phase:LobbyPhases.ENTER,playerName:"Visitor",runningMatch:null,errorMsg:"",credentialStore:{}}),_defineProperty(_assertThisInitialized(r),"_createConnection",function(e){var t=r.state.playerName;r.connection=LobbyConnection({server:e.lobbyServer,gameComponents:e.gameComponents,playerName:t,playerCredentials:r.state.credentialStore[t]})}),_defineProperty(_assertThisInitialized(r),"_updateCredentials",function(e,t){r.setState(function(a){var r=Object.assign({},a.credentialStore);return r[[e]]=t,{credentialStore:r}})}),_defineProperty(_assertThisInitialized(r),"_updateConnection",async function(){await r.connection.refresh(),r.forceUpdate()}),_defineProperty(_assertThisInitialized(r),"_enterLobby",function(e){r.setState({playerName:e,phase:LobbyPhases.LIST})}),_defineProperty(_assertThisInitialized(r),"_exitLobby",async function(){await r.connection.disconnect(),r.setState({phase:LobbyPhases.ENTER,errorMsg:""})}),_defineProperty(_assertThisInitialized(r),"_createMatch",async function(e,t){try{await r.connection.create(e,t),await r.connection.refresh(),r.setState({})}catch(e){r.setState({errorMsg:e.message})}}),_defineProperty(_assertThisInitialized(r),"_joinMatch",async function(e,t,a){try{await r.connection.join(e,t,a),await r.connection.refresh(),r._updateCredentials(r.connection.playerName,r.connection.playerCredentials)}catch(e){r.setState({errorMsg:e.message})}}),_defineProperty(_assertThisInitialized(r),"_leaveMatch",async function(e,t){try{await r.connection.leave(e,t),await r.connection.refresh(),r._updateCredentials(r.connection.playerName,r.connection.playerCredentials)}catch(e){r.setState({errorMsg:e.message})}}),_defineProperty(_assertThisInitialized(r),"_startMatch",function(e,t){var a=r.connection._getGameComponents(e);if(a){var n=void 0;if(t.numPlayers>1&&(n=r.props.gameServer?SocketIO({server:r.props.gameServer}):SocketIO()),1==t.numPlayers){for(var s=a.game.maxPlayers,i={},o=1;o<s;o++)i[o+""]=MCTSBot;n=Local({bots:i})}var c={app:r.props.clientFactory({game:a.game,board:a.board,debug:r.props.debug,multiplayer:n}),matchID:t.matchID,playerID:t.numPlayers>1?t.playerID:"0",credentials:r.connection.playerCredentials};r.setState({phase:LobbyPhases.PLAY,runningMatch:c})}else r.setState({errorMsg:"game "+e+" not supported"})}),_defineProperty(_assertThisInitialized(r),"_exitMatch",function(){r.setState({phase:LobbyPhases.LIST,runningMatch:null})}),_defineProperty(_assertThisInitialized(r),"_getPhaseVisibility",function(e){return r.state.phase!==e?"hidden":"phase"}),_defineProperty(_assertThisInitialized(r),"renderMatches",function(e,t){return e.map(function(e){var a=e.matchID,n=e.gameName,s=e.players;return React.createElement(LobbyMatchInstance,{key:"instance-"+a,match:{matchID:a,gameName:n,players:Object.values(s)},playerName:t,onClickJoin:r._joinMatch,onClickLeave:r._leaveMatch,onClickPlay:r._startMatch})})}),r._createConnection(r.props),setInterval(r._updateConnection,r.props.refreshInterval),r}return _createClass(a,[{key:"componentDidMount",value:function(){var e=Cookies.load("lobbyState")||{};e.phase&&e.phase===LobbyPhases.PLAY&&(e.phase=LobbyPhases.LIST),this.setState({phase:e.phase||LobbyPhases.ENTER,playerName:e.playerName||"Visitor",credentialStore:e.credentialStore||{}})}},{key:"componentDidUpdate",value:function(e,t){var a=this.state.playerName,r=this.state.credentialStore[a];if(t.phase!==this.state.phase||t.credentialStore[a]!==r||t.playerName!==a){this._createConnection(this.props),this._updateConnection();var n={phase:this.state.phase,playerName:a,credentialStore:this.state.credentialStore};Cookies.save("lobbyState",n,{path:"/"})}}},{key:"render",value:function(){var e=this.props,t=e.gameComponents,a=e.renderer,r=this.state,n=r.errorMsg,s=r.playerName,i=r.phase,o=r.runningMatch;return a?a({errorMsg:n,gameComponents:t,matches:this.connection.matches,phase:i,playerName:s,runningMatch:o,handleEnterLobby:this._enterLobby,handleExitLobby:this._exitLobby,handleCreateMatch:this._createMatch,handleJoinMatch:this._joinMatch,handleLeaveMatch:this._leaveMatch,handleExitMatch:this._exitMatch,handleRefreshMatches:this._updateConnection,handleStartMatch:this._startMatch}):React.createElement("div",{id:"lobby-view",style:{padding:50}},React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.ENTER)},React.createElement(LobbyLoginForm,{key:s,playerName:s,onEnter:this._enterLobby})),React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.LIST)},React.createElement("p",null,"Welcome, ",s),React.createElement("div",{className:"phase-title",id:"match-creation"},React.createElement("span",null,"Create a match:"),React.createElement(LobbyCreateMatchForm,{games:t,createMatch:this._createMatch})),React.createElement("p",{className:"phase-title"},"Join a match:"),React.createElement("div",{id:"instances"},React.createElement("table",null,React.createElement("tbody",null,this.renderMatches(this.connection.matches,s))),React.createElement("span",{className:"error-msg"},n,React.createElement("br",null))),React.createElement("p",{className:"phase-title"},"Matches that become empty are automatically deleted.")),React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.PLAY)},o&&React.createElement(o.app,{matchID:o.matchID,playerID:o.playerID,credentials:o.credentials}),React.createElement("div",{className:"buttons",id:"match-exit"},React.createElement("button",{onClick:this._exitMatch},"Exit match"))),React.createElement("div",{className:"buttons",id:"lobby-exit"},React.createElement("button",{onClick:this._exitLobby},"Exit lobby")))}}]),a}(React.Component);_defineProperty(Lobby,"propTypes",{gameComponents:PropTypes.array.isRequired,lobbyServer:PropTypes.string,gameServer:PropTypes.string,debug:PropTypes.bool,clientFactory:PropTypes.func,refreshInterval:PropTypes.number}),_defineProperty(Lobby,"defaultProps",{debug:!1,clientFactory:Client,refreshInterval:2e3});export{Client,Lobby};
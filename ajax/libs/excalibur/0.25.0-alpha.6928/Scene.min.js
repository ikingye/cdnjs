var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();import{ScreenElement}from"./ScreenElement";import{Physics}from"./Physics";import{InitializeEvent,PreUpdateEvent,PostUpdateEvent,PreDrawEvent,PostDrawEvent,PreDebugDrawEvent,PostDebugDrawEvent}from"./Events";import{Logger}from"./Util/Log";import{Timer}from"./Timer";import{DynamicTreeCollisionBroadphase}from"./Collision/DynamicTreeCollisionBroadphase";import{SortedList}from"./Util/SortedList";import{TileMap}from"./TileMap";import{Camera}from"./Camera";import{Actor}from"./Actor";import{Class}from"./Class";import*as Util from"./Util/Util";import*as ActorUtils from"./Util/Actors";import{Trigger}from"./Trigger";var Scene=function(t){function e(e){var i=t.call(this)||this;return i.actors=[],i._bodies=[],i.triggers=[],i.tileMaps=[],i.screenElements=[],i._isInitialized=!1,i._sortedDrawingTree=new SortedList(Actor.prototype.getZIndex),i._broadphase=new DynamicTreeCollisionBroadphase,i._killQueue=[],i._triggerKillQueue=[],i._timers=[],i._cancelQueue=[],i._logger=Logger.getInstance(),i.camera=new Camera,i._engine=e,e&&(i.camera.x=e.halfDrawWidth,i.camera.y=e.halfDrawHeight),i}return __extends(e,t),e.prototype.on=function(e,i){t.prototype.on.call(this,e,i)},e.prototype.once=function(e,i){t.prototype.once.call(this,e,i)},e.prototype.off=function(e,i){t.prototype.off.call(this,e,i)},e.prototype.onInitialize=function(t){},e.prototype.onActivate=function(t,e){},e.prototype.onDeactivate=function(t,e){},e.prototype.onPreUpdate=function(t,e){},e.prototype.onPostUpdate=function(t,e){},e.prototype.onPreDraw=function(t,e){},e.prototype.onPostDraw=function(t,e){},e.prototype._initializeChildren=function(){for(var t=0,e=this.actors;t<e.length;t++){e[t]._initialize(this._engine)}},Object.defineProperty(e.prototype,"isInitialized",{get:function(){return this._isInitialized},enumerable:!1,configurable:!0}),e.prototype._initialize=function(t){this.isInitialized||(this._engine=t,this.camera&&(this.camera.x=t.halfDrawWidth,this.camera.y=t.halfDrawHeight),this.onInitialize.call(this,t),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,t),this.eventDispatcher.emit("initialize",new InitializeEvent(t,this)),this._isInitialized=!0)},e.prototype._activate=function(t,e){this._logger.debug("Scene.onActivate",this),this.onActivate(t,e)},e.prototype._deactivate=function(t,e){this._logger.debug("Scene.onDeactivate",this),this.onDeactivate(t,e)},e.prototype._preupdate=function(t,e){this.emit("preupdate",new PreUpdateEvent(t,e,this)),this.onPreUpdate(t,e)},e.prototype._postupdate=function(t,e){this.emit("postupdate",new PostUpdateEvent(t,e,this)),this.onPostUpdate(t,e)},e.prototype._predraw=function(t,e){this.emit("predraw",new PreDrawEvent(t,e,this)),this.onPreDraw(t,e)},e.prototype._postdraw=function(t,e){this.emit("postdraw",new PostDrawEvent(t,e,this)),this.onPostDraw(t,e)},e.prototype.update=function(t,e){var i,r;for(this._preupdate(t,e),this.camera&&this.camera.update(t,e),i=0,r=this._cancelQueue.length;i<r;i++)this.removeTimer(this._cancelQueue[i]);this._cancelQueue.length=0;for(var s=0,o=this._timers;s<o.length;s++){o[s].update(e)}for(i=0,r=this.screenElements.length;i<r;i++)this.screenElements[i].update(t,e);for(i=0,r=this.tileMaps.length;i<r;i++)this.tileMaps[i].update(t,e);for(i=0,r=this.actors.length;i<r;i++)this.actors[i].update(t,e),this._bodies[i]=this.actors[i].body;for(i=0,r=this.triggers.length;i<r;i++)this.triggers[i].update(t,e);if(this._collectActorStats(t),t.input.pointers.dispatchPointerEvents(),this._broadphase&&Physics.enabled){var n=Date.now();this._broadphase.update(this._bodies,e);for(var a=this._broadphase.broadphase(this._bodies,e,t.stats.currFrame),h=Date.now(),c=Date.now(),p=Physics.collisionPasses,l=e/p;p>0;)a=this._broadphase.narrowphase(a,t.stats.currFrame),a=this._broadphase.resolve(a,l,Physics.collisionResolutionStrategy),this._broadphase.runCollisionStartEnd(a),p--;var u=Date.now();t.stats.currFrame.physics.broadphase=h-n,t.stats.currFrame.physics.narrowphase=u-c}t.stats.currFrame.actors.killed=this._killQueue.length+this._triggerKillQueue.length,this._processKillQueue(this._killQueue,this.actors),this._processKillQueue(this._triggerKillQueue,this.triggers),this._postupdate(t,e)},e.prototype._processKillQueue=function(t,e){for(var i,r=0,s=t;r<s.length;r++){var o=s[r];o.isKilled()&&(i=e.indexOf(o))>-1&&(this._sortedDrawingTree.removeByComparable(o),e.splice(i,1))}t.length=0},e.prototype.draw=function(t,e){var i,r;for(this._predraw(t,e),t.save(),this.camera&&this.camera.draw(t),i=0,r=this.tileMaps.length;i<r;i++)this.tileMaps[i].draw(t,e);var s=this._sortedDrawingTree.list();for(i=0,r=s.length;i<r;i++)s[i].visible&&!s[i].isOffScreen&&s[i].draw(t,e);for(this._engine&&this._engine.isDebug&&(t.strokeStyle="yellow",this.debugDraw(t)),t.restore(),i=0,r=this.screenElements.length;i<r;i++)this.screenElements[i].visible&&this.screenElements[i].draw(t,e);if(this._engine&&this._engine.isDebug)for(i=0,r=this.screenElements.length;i<r;i++)this.screenElements[i].debugDraw(t);this._postdraw(t,e)},e.prototype.debugDraw=function(t){var e,i;for(this.emit("predebugdraw",new PreDebugDrawEvent(t,this)),e=0,i=this.tileMaps.length;e<i;e++)this.tileMaps[e].debugDraw(t);for(e=0,i=this.actors.length;e<i;e++)this.actors[e].debugDraw(t);for(e=0,i=this.triggers.length;e<i;e++)this.triggers[e].debugDraw(t);this._broadphase.debugDraw(t,20),this.camera.debugDraw(t),this.emit("postdebugdraw",new PostDebugDrawEvent(t,this))},e.prototype.contains=function(t){return this.actors.indexOf(t)>-1},e.prototype.add=function(t){t instanceof Actor&&t.unkill(),t instanceof ScreenElement?Util.contains(this.screenElements,t)||this.addScreenElement(t):t instanceof Actor?Util.contains(this.actors,t)||this._addChild(t):t instanceof Timer?Util.contains(this._timers,t)||this.addTimer(t):t instanceof TileMap&&(Util.contains(this.tileMaps,t)||this.addTileMap(t))},e.prototype.remove=function(t){t instanceof ScreenElement?this.removeScreenElement(t):(t instanceof Actor&&this._removeChild(t),t instanceof Timer&&this.removeTimer(t),t instanceof TileMap&&this.removeTileMap(t))},e.prototype.addScreenElement=function(t){this.screenElements.push(t),t.scene=this},e.prototype.removeScreenElement=function(t){var e=this.screenElements.indexOf(t);e>-1&&this.screenElements.splice(e,1)},e.prototype._addChild=function(t){this._broadphase.track(t.body),t.scene=this,t instanceof Trigger?this.triggers.push(t):this.actors.push(t),this._sortedDrawingTree.add(t)},e.prototype.addTileMap=function(t){this.tileMaps.push(t)},e.prototype.removeTileMap=function(t){var e=this.tileMaps.indexOf(t);e>-1&&this.tileMaps.splice(e,1)},e.prototype._removeChild=function(t){Util.contains(this.actors,t)&&(this._broadphase.untrack(t.body),t instanceof Trigger?this._triggerKillQueue.push(t):(t.isKilled()||t.kill(),this._killQueue.push(t)),t.parent=null)},e.prototype.addTimer=function(t){return this._timers.push(t),t.scene=this,t},e.prototype.removeTimer=function(t){var e=this._timers.indexOf(t);return-1!==e&&this._timers.splice(e,1),t},e.prototype.cancelTimer=function(t){return this._cancelQueue.push(t),t},e.prototype.isTimerActive=function(t){return this._timers.indexOf(t)>-1&&!t.complete},e.prototype.cleanupDrawTree=function(t){this._sortedDrawingTree.removeByComparable(t)},e.prototype.updateDrawTree=function(t){this._sortedDrawingTree.add(t)},e.prototype.isActorInDrawTree=function(t){return this._sortedDrawingTree.find(t)},e.prototype.isCurrentScene=function(){return!!this._engine&&this._engine.currentScene===this},e.prototype._collectActorStats=function(t){for(var e=0,i=this.screenElements;e<i.length;e++){i[e];t.stats.currFrame.actors.ui++}for(var r=0,s=this.actors;r<s.length;r++){var o=s[r];t.stats.currFrame.actors.alive++;for(var n=0,a=o.children;n<a.length;n++){var h=a[n];ActorUtils.isScreenElement(h)?t.stats.currFrame.actors.ui++:t.stats.currFrame.actors.alive++}}},e}(Class);export{Scene};
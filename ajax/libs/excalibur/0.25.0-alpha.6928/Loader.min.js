var __extends=this&&this.__extends||function(){var t=function(o,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var e in o)o.hasOwnProperty(e)&&(t[e]=o[e])})(o,e)};return function(o,e){function n(){this.constructor=o}t(o,e),o.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();import{Color}from"./Drawing/Color";import{WebAudio}from"./Util/WebAudio";import{Logger}from"./Util/Log";import{Promise,PromiseState}from"./Promises";import{Class}from"./Class";import*as DrawUtil from"./Util/DrawUtil";import logoImg from"./Loader.logo.png";import loaderCss from"./Loader.css";var Loader=function(t){function o(o){var e=t.call(this)||this;return e._resourceList=[],e._index=0,e._playButtonShown=!1,e._resourceCount=0,e._numLoaded=0,e._progressCounts={},e._totalCounts={},e.logo=logoImg,e.logoWidth=468,e.logoHeight=118,e.loadingBarColor=Color.White,e.backgroundColor="#176BAA",e.suppressPlayButton=!1,e._playButtonStyles=loaderCss.toString(),e.playButtonText="Play game",e.startButtonFactory=function(){var t=document.createElement("button");return t.id="excalibur-play",t.textContent=e.playButtonText,t.style.display="none",t},e.getData=function(){},e.setData=function(){},e.processData=function(){},e.onprogress=function(t){Logger.getInstance().debug("[ex.Loader] Loading "+(100*t.loaded/t.total).toFixed(0))},e.oncomplete=function(){},e.onerror=function(){},o&&e.addResources(o),e}return __extends(o,t),Object.defineProperty(o.prototype,"_image",{get:function(){return this._imageElement||(this._imageElement=new Image,this._imageElement.src=this.logo),this._imageElement},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"playButtonRootElement",{get:function(){return this._playButtonRootElement},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"playButtonElement",{get:function(){return this._playButtonElement},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"_playButton",{get:function(){return this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement},enumerable:!1,configurable:!0}),o.prototype.wireEngine=function(t){this._engine=t},o.prototype.addResource=function(t){var o=this._index++;this._resourceList.push(t),this._progressCounts[o]=0,this._totalCounts[o]=1,this._resourceCount++},o.prototype.addResources=function(t){for(var o=0,e=t.length;o<e;o++)this.addResource(t[o])},o.prototype.isLoaded=function(){return this._numLoaded===this._resourceCount},o.prototype.showPlayButton=function(){if(this.suppressPlayButton)return Promise.resolve();this._playButtonShown=!0,this._playButton.style.display="block";var t=new Promise;return this._playButton.addEventListener("click",function(){return t.state()===PromiseState.Pending?t.resolve():t}),this._playButton.addEventListener("touchend",function(){return t.state()===PromiseState.Pending?t.resolve():t}),this._playButton.addEventListener("pointerup",function(){return t.state()===PromiseState.Pending?t.resolve():t}),t},o.prototype.hidePlayButton=function(){this._playButtonShown=!1,this._playButton.style.display="none"},o.prototype.dispose=function(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)},o.prototype.load=function(){var t=this,o=new Promise;if(0===this._resourceList.length)return this.showPlayButton().then(function(){WebAudio.unlock().then(function(){t.hidePlayButton(),t.oncomplete.call(t),o.resolve(),t.dispose()})}),o;return this._resourceList.forEach(function(e){t._engine&&e.wireEngine(t._engine),e.onprogress=function(o){t.updateResourceProgress(o.loaded,o.total)},e.oncomplete=e.onerror=function(){t.markResourceComplete(),t.isLoaded()&&setTimeout(function(){t.showPlayButton().then(function(){WebAudio.unlock().then(function(){t.hidePlayButton(),t.oncomplete.call(t),o.resolve(),t.dispose()})})},200)}}),function t(o,e){o[e]&&o[e].load().then(function(){t(o,e+1)})}(this._resourceList,0),o},o.prototype.updateResourceProgress=function(t,o){var e=t/o*(100/this._resourceCount)+100*this.progress;this.onprogress({loaded:e,total:100})},o.prototype.markResourceComplete=function(){this._numLoaded++},Object.defineProperty(o.prototype,"progress",{get:function(){return this._resourceCount>0?this._numLoaded/this._resourceCount:1},enumerable:!1,configurable:!0}),o.prototype.draw=function(t){var o=this._engine.canvasHeight/this._engine.pixelRatio,e=this._engine.canvasWidth/this._engine.pixelRatio;if(this._playButtonRootElement){var n=t.canvas.offsetLeft,i=t.canvas.offsetTop,s=this._playButton.clientWidth,r=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=this.playButtonPosition.x+"px",this._playButtonRootElement.style.top=this.playButtonPosition.y+"px"):(this._playButtonRootElement.style.left=n+e/2-s/2+"px",this._playButtonRootElement.style.top=i+o/2-r/2+100+"px")}t.fillStyle=this.backgroundColor,t.fillRect(0,0,e,o);var l=o/2,a=Math.min(this.logoWidth,.75*e),u=e/2-a/2;this.logoPosition&&(u=this.logoPosition.x,l=this.logoPosition.y);var p=Math.floor(a*(this.logoHeight/this.logoWidth)),h=this._engine.getAntialiasing();if(this._engine.setAntialiasing(!0),this.logoPosition?t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,u,l,a,p):t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,u,l-p-20,a,p),this.suppressPlayButton||!this._playButtonShown){var c=u,d=l;this.loadingBarPosition&&(c=this.loadingBarPosition.x,d=this.loadingBarPosition.y),t.lineWidth=2,DrawUtil.roundRect(t,c,d,a,20,10,this.loadingBarColor);var y=a*this.progress-10;DrawUtil.roundRect(t,c+5,d+5,y>10?y:10,10,5,null,this.loadingBarColor),this._engine.setAntialiasing(h)}else this._engine.setAntialiasing(h)},o.prototype.update=function(t,o){},o}(Class);export{Loader};
var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();import{Promise}from"../../Promises";import*as Util from"../../Util/Util";import{AudioContextFactory}from"./AudioContext";var AudioInstanceFactory=function(){function t(){}return t.create=function(t){return"string"==typeof t?new AudioTagInstance(t):t instanceof AudioBuffer?new WebAudioInstance(t):new AudioInstance(t)},t}();export{AudioInstanceFactory};var AudioInstance=function(){function t(t){this._src=t,this._volume=1,this._duration=void 0,this._loop=!1,this._isPlaying=!1,this._isPaused=!1}return Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=t,this._instance&&(this._instance.loop=t,this._wireUpOnEnded())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){this._volume=Util.clamp(t,0,1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"duration",{get:function(){return this._duration},set:function(t){this._duration=t},enumerable:!1,configurable:!0}),t.prototype.isPlaying=function(){return this._isPlaying},t.prototype.pause=function(){this._isPlaying&&(this._isPaused=!0,this._isPlaying=!1)},t.prototype.stop=function(){this._isPlaying&&(this._isPlaying=!1,this._isPaused=!1)},t.prototype.play=function(){return this._isPaused&&this._resumePlayBack(),this._isPlaying||this._startPlayBack(),this._playingPromise},t.prototype._startPlayBack=function(){this._isPlaying=!0,this._isPaused=!1,this._playingPromise=new Promise},t.prototype._resumePlayBack=function(){this._isPaused&&(this._isPaused=!1,this._isPlaying=!0)},t.prototype._wireUpOnEnded=function(){var t=this;this.loop||(this._instance.onended=function(){return t._handleOnEnded()})},t.prototype._handleOnEnded=function(){},t}();export{AudioInstance};var AudioTagInstance=function(t){function e(e){var i=t.call(this,e)||this;return i._instance=new Audio(e),i}return __extends(e,t),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume},set:function(t){t=Util.clamp(t,0,1),this._volume=t,this._instance.volume=t},enumerable:!1,configurable:!0}),e.prototype.pause=function(){this._isPlaying&&(this._instance.pause(),this._isPaused=!0,this._isPlaying=!1)},e.prototype.stop=function(){t.prototype.stop.call(this),this._instance.pause(),this._instance.currentTime=0,this._handleOnEnded()},e.prototype._startPlayBack=function(){t.prototype._startPlayBack.call(this),this._instance.load(),this._instance.loop=this.loop,this._instance.play(),this._wireUpOnEnded()},e.prototype._resumePlayBack=function(){t.prototype._resumePlayBack.call(this),this._instance.play(),this._wireUpOnEnded()},e.prototype._handleOnEnded=function(){this._isPlaying=!1,this._isPaused=!1,this._playingPromise.resolve(!0)},e}(AudioInstance);export{AudioTagInstance};var WebAudioInstance=function(t){function e(e){var i=t.call(this,e)||this;return i._audioContext=AudioContextFactory.create(),i._volumeNode=i._audioContext.createGain(),i._currentOffset=0,i._createNewBufferSource(),i}return __extends(e,t),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume},set:function(t){t=Util.clamp(t,0,1),this._volume=t,this._isPlaying&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(t,this._audioContext.currentTime,.1):this._volumeNode.gain.value=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_playbackRate",{get:function(){return this._instance?1/(this._instance.playbackRate.value||1):null},enumerable:!1,configurable:!0}),e.prototype.pause=function(){t.prototype.pause.call(this),this._instance.stop(0),this._setPauseOffset()},e.prototype.stop=function(){t.prototype.stop.call(this),this._currentOffset=0,this._instance.stop(0),this._instance.onended||this._handleOnEnded()},e.prototype._startPlayBack=function(){t.prototype._startPlayBack.call(this),this._instance||this._createNewBufferSource(),this._rememberStartTime(),this._volumeNode.connect(this._audioContext.destination),this._instance.start(0,0),this._currentOffset=0,this._playingPromise=new Promise,this._wireUpOnEnded()},e.prototype._resumePlayBack=function(){t.prototype._resumePlayBack.call(this),this._instance.onended=null,this._createNewBufferSource();var e=this._playbackRate*this._src.duration,i=this._currentOffset%e;this._rememberStartTime(-1e3*i),this._instance.start(0,i),this._wireUpOnEnded()},e.prototype._handleOnEnded=function(){this._isPaused||(this._isPlaying=!1,this._playingPromise.resolve(!0))},e.prototype._rememberStartTime=function(t){this._startTime=(new Date).getTime()+(0|t)},e.prototype._setPauseOffset=function(){this._currentOffset=((new Date).getTime()-this._startTime)*this._playbackRate/1e3},e.prototype._createNewBufferSource=function(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.setValueAtTime(1,0),this._instance.connect(this._volumeNode)},e}(AudioInstance);export{WebAudioInstance};
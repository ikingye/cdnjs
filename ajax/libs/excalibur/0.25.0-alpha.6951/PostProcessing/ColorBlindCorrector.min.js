import{Logger}from"./../Util/Log";export var ColorBlindness;!function(t){t[t.Protanope=0]="Protanope",t[t.Deuteranope=1]="Deuteranope",t[t.Tritanope=2]="Tritanope"}(ColorBlindness||(ColorBlindness={}));var ColorBlindCorrector=function(){function t(t,r,e){void 0===r&&(r=!1),void 0===e&&(e=ColorBlindness.Protanope),this.engine=t,this.simulate=r,this.colorMode=e,this._vertexShader="attribute vec2 a_position;attribute vec2 a_texCoord;uniform vec2 u_resolution;varying vec2 v_texCoord;void main() {vec2 zeroToOne = a_position / u_resolution;vec2 zeroToTwo = zeroToOne * 2.0;vec2 clipSpace = zeroToTwo - 1.0;gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);v_texCoord = a_texCoord;}",this._fragmentShader="precision mediump float;uniform sampler2D u_image;varying vec2 v_texCoord;void main() {vec4 o =  texture2D(u_image, v_texCoord);float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);//MODE CODE//vec4 error;error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);error.a = 1.0;vec4 diff = o - error;vec4 correction;correction.r = 0.0;correction.g =  (diff.r * 0.7) + (diff.g * 1.0);correction.b =  (diff.r * 0.7) + (diff.b * 1.0);correction = o + correction;correction.a = o.a;//SIMULATE//}",this._internalCanvas=document.createElement("canvas"),this._internalCanvas.width=t.drawWidth,this._internalCanvas.height=t.drawHeight,this._gl=this._internalCanvas.getContext("webgl",{preserveDrawingBuffer:!0}),this._program=this._gl.createProgram();var i=this._getShader("Fragment",this._getFragmentShaderByMode(e)),o=this._getShader("Vertex",this._vertexShader);this._gl.attachShader(this._program,o),this._gl.attachShader(this._program,i),this._gl.linkProgram(this._program),this._gl.getProgramParameter(this._program,this._gl.LINK_STATUS)||Logger.getInstance().error("Unable to link shader program!"),this._gl.useProgram(this._program)}return t.prototype._getFragmentShaderByMode=function(t){var r="";return t===ColorBlindness.Protanope?r="float l = 0.0 * L + 2.02344 * M + -2.52581 * S;float m = 0.0 * L + 1.0 * M + 0.0 * S;float s = 0.0 * L + 0.0 * M + 1.0 * S;":t===ColorBlindness.Deuteranope?r="float l = 1.0 * L + 0.0 * M + 0.0 * S;float m = 0.494207 * L + 0.0 * M + 1.24827 * S;float s = 0.0 * L + 0.0 * M + 1.0 * S;":t===ColorBlindness.Tritanope&&(r="float l = 1.0 * L + 0.0 * M + 0.0 * S;float m = 0.0 * L + 1.0 * M + 0.0 * S;float s = -0.395913 * L + 0.801109 * M + 0.0 * S;"),this.simulate?this._fragmentShader=this._fragmentShader.replace("//SIMULATE//","gl_FragColor = error.rgba;"):this._fragmentShader=this._fragmentShader.replace("//SIMULATE//","gl_FragColor = correction.rgba;"),this._fragmentShader.replace("//MODE CODE//",r)},t.prototype._setRectangle=function(t,r,e,i){var o=t,a=t+e,s=r,_=r+i;this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array([o,s,a,s,o,_,o,_,a,s,a,_]),this._gl.STATIC_DRAW)},t.prototype._getShader=function(t,r){var e;return"Fragment"===t?e=this._gl.createShader(this._gl.FRAGMENT_SHADER):"Vertex"===t?e=this._gl.createShader(this._gl.VERTEX_SHADER):Logger.getInstance().error("Error unknown shader type",t),this._gl.shaderSource(e,r),this._gl.compileShader(e),this._gl.getShaderParameter(e,this._gl.COMPILE_STATUS)?e:(Logger.getInstance().error("Unable to compile shader!",this._gl.getShaderInfoLog(e)),null)},t.prototype.process=function(t,r){var e=this._gl.getAttribLocation(this._program,"a_position"),i=this._gl.getAttribLocation(this._program,"a_texCoord"),o=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,o),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),this._gl.STATIC_DRAW),this._gl.enableVertexAttribArray(i),this._gl.vertexAttribPointer(i,2,this._gl.FLOAT,!1,0,0);var a=this._gl.createTexture();this._gl.bindTexture(this._gl.TEXTURE_2D,a),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.NEAREST),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.NEAREST),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,1),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t);var s=this._gl.getUniformLocation(this._program,"u_resolution");this._gl.uniform2f(s,this._internalCanvas.width,this._internalCanvas.height);var _=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,_),this._gl.enableVertexAttribArray(e),this._gl.vertexAttribPointer(e,2,this._gl.FLOAT,!1,0,0),this._setRectangle(0,0,t.width,t.height),this._gl.drawArrays(this._gl.TRIANGLES,0,6);var g=new Uint8Array(t.width*t.height*4);this._gl.readPixels(0,0,t.width,t.height,this._gl.RGBA,this._gl.UNSIGNED_BYTE,g),t.data.set(g),r.putImageData(t,0,0)},t}();export{ColorBlindCorrector};
import{Physics}from"./../Physics";import{DynamicTree}from"./DynamicTree";import{Pair}from"./Pair";import{Vector,Ray}from"../Algebra";import{Logger}from"../Util/Log";import{CollisionStartEvent,CollisionEndEvent}from"../Events";import{CollisionType}from"./CollisionType";var DynamicTreeCollisionBroadphase=function(){function i(){this._dynamicCollisionTree=new DynamicTree,this._collisionHash={},this._collisionPairCache=[],this._lastFramePairs=[],this._lastFramePairsHash={}}return i.prototype.track=function(i){i?this._dynamicCollisionTree.trackBody(i):Logger.getInstance().warn("Cannot track null physics body")},i.prototype.untrack=function(i){i?this._dynamicCollisionTree.untrackBody(i):Logger.getInstance().warn("Cannot untrack a null physics body")},i.prototype._shouldGenerateCollisionPair=function(i,o){var s=Pair.calculatePairHash(i,o);return!this._collisionHash[s]&&Pair.canCollide(i,o)},i.prototype.broadphase=function(i,o,s){var e,r=this,l=o/1e3,n=i.map(function(i){return i.collider}).filter(function(i){return i.active&&i.type!==CollisionType.PreventCollision});this._collisionPairCache=[],this._collisionHash={};for(var t=0,a=n.length;t<a;t++)e=n[t],this._dynamicCollisionTree.query(e.body,function(i){if(r._shouldGenerateCollisionPair(e,i.collider)){var o=new Pair(e,i.collider);r._collisionHash[o.id]=!0,r._collisionPairCache.push(o)}return!1});if(s&&(s.physics.pairs=this._collisionPairCache.length),Physics.checkForFastBodies)for(var c=function(i){if(i.type!==CollisionType.Active)return"continue";var o=i.body.vel.size*l+.5*i.body.acc.size*l*l,e=Math.min(i.bounds.height,i.bounds.width);if(Physics.disableMinimumSpeedForFastBody||o>e/2){s&&s.physics.fastBodies++;var r,n=i.body.pos.sub(i.body.oldPos),t=i.shape.center,a=i.shape.getFurthestPoint(i.body.vel),c=a.sub(n),d=new Ray(c,i.body.vel);d.pos=d.pos.add(d.dir.scale(-2*Physics.surfaceEpsilon));var y=new Vector(1/0,1/0);if(h._dynamicCollisionTree.rayCastQuery(d,o+2*Physics.surfaceEpsilon,function(s){if(i.body!==s&&s.collider.shape&&Pair.canCollide(i,s.collider)){var e=s.collider.shape.rayCast(d,o+10*Physics.surfaceEpsilon);if(e){var l=e.sub(c);l.size<y.size&&(y=l,r=s)}}return!1}),r&&Vector.isValid(y)){var p=new Pair(i,r.collider);h._collisionHash[p.id]||(h._collisionHash[p.id]=!0,h._collisionPairCache.push(p));var u=t.sub(a);i.body.pos=c.add(u).add(y).add(d.dir.scale(2*Physics.surfaceEpsilon)),i.shape.recalc(),s&&s.physics.fastBodyCollisions++}}},h=this,d=0,y=n;d<y.length;d++){c(y[d])}return this._collisionPairCache},i.prototype.narrowphase=function(i,o){for(var s=0;s<i.length;s++)i[s].collide(),o&&i[s].collision&&(o.physics.collisions++,o.physics.collidersHash[i[s].id]=i[s]);return i.filter(function(i){return i.collision})},i.prototype.resolve=function(i,o,s){for(var e=0,r=i;e<r.length;e++){var l=r[e];l.resolve(s),l.collision&&(l.colliderA.body.applyMtv(),l.colliderB.body.applyMtv(),l.colliderA.body.integrate(o*Physics.collisionShift),l.colliderB.body.integrate(o*Physics.collisionShift))}return i.filter(function(i){return i.canCollide})},i.prototype.runCollisionStartEnd=function(i){for(var o={},s=0,e=i;s<e.length;s++){if(o[(a=e[s]).id]=a,!this._lastFramePairsHash[a.id]){var r=a.colliderA,l=a.colliderB;r.emit("collisionstart",new CollisionStartEvent(r,l,a)),l.emit("collisionstart",new CollisionStartEvent(l,r,a))}}for(var n=0,t=this._lastFramePairs;n<t.length;n++){var a;if(!o[(a=t[n]).id]){r=a.colliderA,l=a.colliderB;r.emit("collisionend",new CollisionEndEvent(r,l)),l.emit("collisionend",new CollisionEndEvent(l,r))}}this._lastFramePairs=i,this._lastFramePairsHash=o},i.prototype.update=function(i){for(var o=0,s=i.length,e=0;e<s;e++)this._dynamicCollisionTree.updateBody(i[e])&&o++;return o},i.prototype.debugDraw=function(i){if(Physics.broadphaseDebug&&this._dynamicCollisionTree.debugDraw(i),Physics.showContacts||Physics.showCollisionNormals)for(var o=0,s=this._collisionPairCache;o<s.length;o++){s[o].debugDraw(i)}},i}();export{DynamicTreeCollisionBroadphase};
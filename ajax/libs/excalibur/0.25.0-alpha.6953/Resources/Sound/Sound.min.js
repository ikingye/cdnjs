var __extends=this&&this.__extends||function(){var t=function(e,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(e,o)};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}();import{ExResponse}from"../../Interfaces/AudioImplementation";import{Resource}from"../Resource";import{AudioInstanceFactory}from"./AudioInstance";import{AudioContextFactory}from"./AudioContext";import{NativeSoundEvent,NativeSoundProcessedEvent}from"../../Events/MediaEvents";import{Promise}from"../../Promises";import{canPlayFile}from"../../Util/Sound";var Sound=function(t){function e(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];var n=t.call(this,"","")||this;n._loop=!1,n._volume=1,n._duration=void 0,n._isStopped=!1,n._isPaused=!1,n._tracks=[],n._wasPlayingOnHidden=!1,n._processedData=new Promise,n._audioContext=AudioContextFactory.create(),n._detectResponseType();for(var s=0,i=e;s<i.length;s++){var r=i[s];if(canPlayFile(r)){n.path=r;break}}return n.path||(n.logger.warn("This browser does not support any of the audio files specified:",e.join(", ")),n.logger.warn("Attempting to use",e[0]),n.path=e[0]),n}return __extends(e,t),Object.defineProperty(e.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=t;for(var e=0,o=this._tracks;e<o.length;e++){o[e].loop=this._loop}this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume},set:function(t){this._volume=t;for(var e=0,o=this._tracks;e<o.length;e++){o[e].volume=this._volume}this.emit("volumechange",new NativeSoundEvent(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"duration",{get:function(){return this._duration},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"instances",{get:function(){return this._tracks},enumerable:!1,configurable:!0}),e.prototype.wireEngine=function(t){var e=this;t&&(this._engine=t,this._engine.on("hidden",function(){t.pauseAudioWhenHidden&&e.isPlaying()&&(e._wasPlayingOnHidden=!0,e.pause())}),this._engine.on("visible",function(){t.pauseAudioWhenHidden&&e._wasPlayingOnHidden&&(e.play(),e._wasPlayingOnHidden=!1)}),this._engine.on("start",function(){e._isStopped=!1}),this._engine.on("stop",function(){e.stop(),e._isStopped=!0}))},e.prototype.instanceCount=function(){return this._tracks.length},e.prototype.isPlaying=function(){return this._tracks.some(function(t){return t.isPlaying()})},e.prototype.play=function(t){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=t||this.volume,this._isPaused?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))},e.prototype.pause=function(){if(this.isPlaying()){for(var t=0,e=this._tracks;t<e.length;t++){e[t].pause()}this._isPaused=!0,this.emit("pause",new NativeSoundEvent(this)),this.logger.debug("Paused all instances of sound",this.path)}},e.prototype.stop=function(){for(var t=0,e=this._tracks;t<e.length;t++){e[t].stop()}this.emit("stop",new NativeSoundEvent(this)),this._isPaused=!1,this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)},e.prototype.setData=function(t){this.emit("emptied",new NativeSoundEvent(this)),this.data=t,this._processedData=new Promise},e.prototype.processData=function(t){var e=this;return(t instanceof ArrayBuffer?this._processArrayBufferData(t):this._processBlobData(t)).then(function(t){return e._setProcessedData(t)})},e.prototype.getTrackId=function(t){return this._tracks.indexOf(t)},e.prototype._resumePlayback=function(){if(this._isPaused){for(var t=[],e=0,o=this._tracks;e<o.length;e++){var n=o[e];t.push(n.play())}return this._isPaused=!1,this.emit("resume",new NativeSoundEvent(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),Promise.join(t)}return Promise.resolve(!0)},e.prototype._startPlayback=function(){var t=this,e=this._createNewTrack(),o=new Promise;return e.then(function(e){e.play().then(function(n){return t.emit("playbackend",new NativeSoundEvent(t,e)),t._tracks.splice(t.getTrackId(e),1),o.resolve(n),n}),t.emit("playbackstart",new NativeSoundEvent(t,e)),t.logger.debug("Playing new instance for sound",t.path)}),o},e.prototype._processArrayBufferData=function(t){var e=this,o=new Promise;return this._audioContext.decodeAudioData(t,function(t){o.resolve(t)},function(){e.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),o.resolve(void 0)}),o},e.prototype._processBlobData=function(e){return(new Promise).resolve(t.prototype.processData.call(this,e))},e.prototype._setProcessedData=function(t){this._processedData.resolve(t),this._duration="object"==typeof t?t.duration:void 0,this.emit("processed",new NativeSoundProcessedEvent(this,t))},e.prototype._createNewTrack=function(){var t=this,e=new Promise;return 0!==this._processedData.state()&&this.processData(this.data),this._processedData.then(function(o){return e.resolve(t._getTrackInstance(o)),o},function(e){t.logger.error(e,"Cannot create AudioInstance due to wrong processed data.")}),e},e.prototype._getTrackInstance=function(t){var e=AudioInstanceFactory.create(t);return e.loop=this.loop,e.volume=this.volume,e.duration=this.duration,this._tracks.push(e),e},e.prototype._detectResponseType=function(){window.AudioContext?this.responseType=ExResponse.type.arraybuffer:this.responseType=ExResponse.type.blob},e}(Resource);export{Sound};
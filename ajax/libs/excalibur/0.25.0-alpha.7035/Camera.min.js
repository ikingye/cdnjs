var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(e,i)};return function(e,i){function o(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}();import{EasingFunctions}from"./Util/EasingFunctions";import{Promise,PromiseState}from"./Promises";import{Vector}from"./Algebra";import{removeItemFromArray}from"./Util/Util";import{PreUpdateEvent,PostUpdateEvent,InitializeEvent}from"./Events";import{Class}from"./Class";import{BoundingBox}from"./Collision/BoundingBox";import{Logger}from"./Util/Log";var StrategyContainer=function(){function t(t){this.camera=t}return t.prototype.lockToActor=function(t){this.camera.addStrategy(new LockCameraToActorStrategy(t))},t.prototype.lockToActorAxis=function(t,e){this.camera.addStrategy(new LockCameraToActorAxisStrategy(t,e))},t.prototype.elasticToActor=function(t,e,i){this.camera.addStrategy(new ElasticToActorStrategy(t,e,i))},t.prototype.radiusAroundActor=function(t,e){this.camera.addStrategy(new RadiusAroundActorStrategy(t,e))},t.prototype.limitCameraBounds=function(t){this.camera.addStrategy(new LimitCameraBoundsStrategy(t))},t}();export{StrategyContainer};export var Axis;!function(t){t[t.X=0]="X",t[t.Y=1]="Y"}(Axis||(Axis={}));var LockCameraToActorStrategy=function(){return function(t){this.target=t,this.action=function(t,e,i,o){return t.center}}}();export{LockCameraToActorStrategy};var LockCameraToActorAxisStrategy=function(){return function(t,e){var i=this;this.target=t,this.axis=e,this.action=function(t,e,o,r){var n=t.center,a=e.getFocus();return i.axis===Axis.X?new Vector(n.x,a.y):new Vector(a.x,n.y)}}}();export{LockCameraToActorAxisStrategy};var ElasticToActorStrategy=function(){return function(t,e,i){var o=this;this.target=t,this.cameraElasticity=e,this.cameraFriction=i,this.action=function(t,e,i,r){var n=t.center,a=e.getFocus(),s=e.vel.clone(),h=n.sub(a).scale(o.cameraElasticity),c=(s=s.add(h)).scale(-1).scale(o.cameraFriction);return s=s.add(c),a=a.add(s)}}}();export{ElasticToActorStrategy};var RadiusAroundActorStrategy=function(){return function(t,e){var i=this;this.target=t,this.radius=e,this.action=function(t,e,o,r){var n=t.center,a=e.getFocus(),s=n.sub(a),h=s.size;if(h>=i.radius){var c=h-i.radius;return a.add(s.normalize().scale(c))}return a}}}();export{RadiusAroundActorStrategy};var LimitCameraBoundsStrategy=function(){return function(t){var e=this;this.target=t,this.boundSizeChecked=!1,this.action=function(t,i,o,r){var n=i.getFocus();return e.boundSizeChecked||((t.bottom-t.top<o.drawHeight||t.right-t.left<o.drawWidth)&&Logger.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),e.boundSizeChecked=!0),n.x<t.left+o.halfDrawWidth?n.x=t.left+o.halfDrawWidth:n.x>t.right-o.halfDrawWidth&&(n.x=t.right-o.halfDrawWidth),n.y<t.top+o.halfDrawHeight?n.y=t.top+o.halfDrawHeight:n.y>t.bottom-o.halfDrawHeight&&(n.y=t.bottom-o.halfDrawHeight),n}}}();export{LimitCameraBoundsStrategy};var Camera=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._cameraStrategies=[],e.strategy=new StrategyContainer(e),e.z=1,e.dz=0,e.az=0,e.rotation=0,e.rx=0,e.pos=Vector.Zero,e.vel=Vector.Zero,e.acc=Vector.Zero,e._cameraMoving=!1,e._currentLerpTime=0,e._lerpDuration=1e3,e._lerpStart=null,e._lerpEnd=null,e._isShaking=!1,e._shakeMagnitudeX=0,e._shakeMagnitudeY=0,e._shakeDuration=0,e._elapsedShakeTime=0,e._xShake=0,e._yShake=0,e._isZooming=!1,e._zoomStart=1,e._zoomEnd=1,e._currentZoomTime=0,e._zoomDuration=0,e._zoomEasing=EasingFunctions.EaseInOutCubic,e._easing=EasingFunctions.EaseInOutCubic,e._isInitialized=!1,e}return __extends(e,t),Object.defineProperty(e.prototype,"angularVelocity",{get:function(){return this.rx},set:function(t){this.rx=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"x",{get:function(){return this.pos.x},set:function(t){this._follow||this._cameraMoving||(this.pos.x=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.pos.y},set:function(t){this._follow||this._cameraMoving||(this.pos.y=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dx",{get:function(){return this.vel.x},set:function(t){this.vel.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dy",{get:function(){return this.vel.y},set:function(t){this.vel.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ax",{get:function(){return this.acc.x},set:function(t){this.acc.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ay",{get:function(){return this.acc.y},set:function(t){this.acc.y=t},enumerable:!1,configurable:!0}),e.prototype.getFocus=function(){return this.pos},e.prototype.move=function(t,e,i){if(void 0===i&&(i=EasingFunctions.EaseInOutCubic),"function"!=typeof i)throw"Please specify an EasingFunction";return this._follow?(new Promise).reject(t):(this._lerpPromise&&this._lerpPromise.state()===PromiseState.Pending&&this._lerpPromise.resolve(t),this._lerpPromise=new Promise,this._lerpStart=this.getFocus().clone(),this._lerpDuration=e,this._lerpEnd=t,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=i,this._lerpPromise)},e.prototype.shake=function(t,e,i){this._isShaking=!0,this._shakeMagnitudeX=t,this._shakeMagnitudeY=e,this._shakeDuration=i},e.prototype.zoom=function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=EasingFunctions.EaseInOutCubic),this._zoomPromise=new Promise,e?(this._isZooming=!0,this._zoomEasing=i,this._currentZoomTime=0,this._zoomDuration=e,this._zoomStart=this.z,this._zoomEnd=t):(this._isZooming=!1,this.z=t,this._zoomPromise.resolve(!0)),this._zoomPromise},e.prototype.getZoom=function(){return this.z},Object.defineProperty(e.prototype,"viewport",{get:function(){if(this._engine){var t=this._engine.halfDrawWidth,e=this._engine.halfDrawHeight;return new BoundingBox(this.x-t,this.y-e,this.x+t,this.y+e)}return new BoundingBox(0,0,0,0)},enumerable:!1,configurable:!0}),e.prototype.addStrategy=function(t){this._cameraStrategies.push(t)},e.prototype.removeStrategy=function(t){removeItemFromArray(t,this._cameraStrategies)},e.prototype.clearAllStrategies=function(){this._cameraStrategies.length=0},e.prototype._preupdate=function(t,e){this.emit("preupdate",new PreUpdateEvent(t,e,this)),this.onPreUpdate(t,e)},e.prototype.onPreUpdate=function(t,e){},e.prototype._postupdate=function(t,e){this.emit("postupdate",new PostUpdateEvent(t,e,this)),this.onPostUpdate(t,e)},e.prototype.onPostUpdate=function(t,e){},Object.defineProperty(e.prototype,"isInitialized",{get:function(){return this._isInitialized},enumerable:!1,configurable:!0}),e.prototype._initialize=function(e){this.isInitialized||(this.onInitialize(e),t.prototype.emit.call(this,"initialize",new InitializeEvent(e,this)),this._isInitialized=!0,this._engine=e)},e.prototype.onInitialize=function(t){},e.prototype.on=function(e,i){t.prototype.on.call(this,e,i)},e.prototype.off=function(e,i){t.prototype.off.call(this,e,i)},e.prototype.once=function(e,i){t.prototype.once.call(this,e,i)},e.prototype.update=function(t,e){if(this._initialize(t),this._preupdate(t,e),this.pos=this.pos.add(this.vel.scale(e/1e3)),this.z+=this.dz*e/1e3,this.vel=this.vel.add(this.acc.scale(e/1e3)),this.dz+=this.az*e/1e3,this.rotation+=this.angularVelocity*e/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){var i=(0,this._zoomEasing)(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.z=i,this._currentZoomTime+=e}else this._isZooming=!1,this.z=this._zoomEnd,this._currentZoomTime=0,this._zoomPromise.resolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){var o=EasingFunctions.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=o,this._currentLerpTime+=e}else{this.pos=this._lerpEnd;var r=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpPromise.resolve(r)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=e,this._xShake=1+(Math.random()*this._shakeMagnitudeX|0),this._yShake=1+(Math.random()*this._shakeMagnitudeY|0));for(var n=0,a=this._cameraStrategies;n<a.length;n++){var s=a[n];this.pos=s.action.call(s,s.target,this,t,e)}this._postupdate(t,e)},e.prototype.draw=function(t){var e=this.getFocus(),i=t.canvas.width,o=t.canvas.height,r=this._engine?this._engine.pixelRatio:window.devicePixelRatio,n=this.getZoom(),a=i/n/r,s=o/n/r;t.scale(n,n),t.translate(-e.x+a/2+this._xShake,-e.y+s/2+this._yShake)},e.prototype.debugDraw=function(t){var e=this.getFocus();t.fillStyle="red",t.strokeStyle="white",t.lineWidth=3,t.beginPath(),t.arc(e.x,e.y,15,0,2*Math.PI),t.closePath(),t.stroke(),t.beginPath(),t.arc(e.x,e.y,5,0,2*Math.PI),t.closePath(),t.stroke(),t.beginPath(),t.setLineDash([5,15]),t.lineWidth=5,t.strokeStyle="white",t.strokeRect(this.viewport.left,this.viewport.top,this.viewport.width,this.viewport.height),t.closePath()},e.prototype._isDoneShaking=function(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration},e}(Class);export{Camera};
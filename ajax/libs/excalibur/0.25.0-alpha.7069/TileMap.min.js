var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();import{BoundingBox}from"./Collision/BoundingBox";import{Color}from"./Drawing/Color";import{Class}from"./Class";import{Vector}from"./Algebra";import{Logger}from"./Util/Log";import*as Events from"./Events";import{Configurable}from"./Configurable";var TileMapImpl=function(t){function e(e,i,r,o,s,n){var h=t.call(this)||this;if(h._collidingX=-1,h._collidingY=-1,h._onScreenXStart=0,h._onScreenXEnd=9999,h._onScreenYStart=0,h._onScreenYEnd=9999,h._spriteSheets={},h.logger=Logger.getInstance(),h.data=[],e&&"object"==typeof e){var l=e;e=l.x,i=l.y,r=l.cellWidth,o=l.cellHeight,s=l.rows,n=l.cols}h.x=e,h.y=i,h.cellWidth=r,h.cellHeight=o,h.rows=s,h.cols=n,h.data=new Array(s*n);for(var a=function(t){for(var l=function(s){var l;l=new Cell(t*r+e,s*o+i,r,o,t+s*n),h.data[t+s*n]=l},a=0;a<s;a++)l(a)},c=0;c<n;c++)a(c);return h}return __extends(e,t),e.prototype.on=function(e,i){t.prototype.on.call(this,e,i)},e.prototype.registerSpriteSheet=function(t,e){this._spriteSheets[t]=e},e.prototype.collides=function(t){var e=t.pos.x+t.width,i=t.pos.y+t.height,r=t.body.collider.bounds,o=[];if(t.width<=0||t.height<=0)return null;for(var s=r.left;s<=e;s+=Math.min(t.width/2,this.cellWidth/2))for(var n=r.top;n<=i;n+=Math.min(t.height/2,this.cellHeight/2)){var h=this.getCellByPoint(s,n);if(h&&h.solid){var l=r.intersect(h.bounds),a=t.center.sub(h.center);l&&l.dot(a)>0&&o.push(l)}}return 0===o.length?null:o.reduce(function(t,e){var i=t.x,r=t.y;return Math.abs(t.x)<Math.abs(e.x)&&(i=e.x),Math.abs(t.y)<Math.abs(e.y)&&(r=e.y),new Vector(i,r)})},e.prototype.getCellByIndex=function(t){return this.data[t]},e.prototype.getCell=function(t,e){return t<0||e<0||t>=this.cols||e>=this.rows?null:this.data[t+e*this.cols]},e.prototype.getCellByPoint=function(t,e){t=Math.floor((t-this.x)/this.cellWidth),e=Math.floor((e-this.y)/this.cellHeight);var i=this.getCell(t,e);return t>=0&&e>=0&&t<this.cols&&e<this.rows&&i?i:null},e.prototype.update=function(t,e){this.emit("preupdate",new Events.PreUpdateEvent(t,e,this));var i=t.screenToWorldCoordinates(new Vector(0,0)),r=t.screenToWorldCoordinates(new Vector(t.canvas.clientWidth,t.canvas.clientHeight));this._onScreenXStart=Math.max(Math.floor((i.x-this.x)/this.cellWidth)-2,0),this._onScreenYStart=Math.max(Math.floor((i.y-this.y)/this.cellHeight)-2,0),this._onScreenXEnd=Math.max(Math.floor((r.x-this.x)/this.cellWidth)+2,0),this._onScreenYEnd=Math.max(Math.floor((r.y-this.y)/this.cellHeight)+2,0),this.emit("postupdate",new Events.PostUpdateEvent(t,e,this))},e.prototype.draw=function(t,e){this.emit("predraw",new Events.PreDrawEvent(t,e,this)),t.save(),t.translate(this.x,this.y);for(var i,r,o,s=this._onScreenXStart,n=Math.min(this._onScreenXEnd,this.cols),h=this._onScreenYStart,l=Math.min(this._onScreenYEnd,this.rows);s<n;s++){for(;h<l;h++)for(r=0,o=(i=this.getCell(s,h).sprites.filter(function(t){return t.spriteId>-1})).length;r<o;r++){var a=this._spriteSheets[i[r].spriteSheetKey];if(a){var c=a.getSprite(i[r].spriteId);c?c.draw(t,s*this.cellWidth,h*this.cellHeight):this.logger.warn("Sprite does not exist for id",i[r].spriteId,"in sprite sheet",i[r].spriteSheetKey,c,a)}else this.logger.warn("Sprite sheet",i[r].spriteSheetKey,"does not exist",a)}h=this._onScreenYStart}t.restore(),this.emit("postdraw",new Events.PostDrawEvent(t,e,this))},e.prototype.debugDraw=function(t){var e=this.cols*this.cellWidth,i=this.rows*this.cellHeight;t.save(),t.strokeStyle=Color.Red.toString();for(var r=0;r<this.cols+1;r++)t.beginPath(),t.moveTo(this.x+r*this.cellWidth,this.y),t.lineTo(this.x+r*this.cellWidth,this.y+i),t.stroke();for(var o=0;o<this.rows+1;o++)t.beginPath(),t.moveTo(this.x,this.y+o*this.cellHeight),t.lineTo(this.x+e,this.y+o*this.cellHeight),t.stroke();var s=Color.Red;s.a=.3,this.data.filter(function(t){return t.solid}).forEach(function(e){t.fillStyle=s.toString(),t.fillRect(e.x,e.y,e.width,e.height)}),this._collidingY>-1&&this._collidingX>-1&&(t.fillStyle=Color.Cyan.toString(),t.fillRect(this.x+this._collidingX*this.cellWidth,this.y+this._collidingY*this.cellHeight,this.cellWidth,this.cellHeight)),t.restore()},e}(Class);export{TileMapImpl};var TileMap=function(t){function e(e,i,r,o,s,n){return t.call(this,e,i,r,o,s,n)||this}return __extends(e,t),e}(Configurable(TileMapImpl));export{TileMap};var TileSprite=function(){return function(t,e){this.spriteSheetKey=t,this.spriteId=e}}();export{TileSprite};var CellImpl=function(){function t(t,e,i,r,o,s,n){if(void 0===s&&(s=!1),void 0===n&&(n=[]),this.solid=!1,this.sprites=[],t&&"object"==typeof t){var h=t;t=h.x,e=h.y,i=h.width,r=h.height,o=h.index,s=h.solid,n=h.sprites}this.x=t,this.y=e,this.width=i,this.height=r,this.index=o,this.solid=s,this.sprites=n,this._bounds=new BoundingBox(this.x,this.y,this.x+this.width,this.y+this.height)}return Object.defineProperty(t.prototype,"bounds",{get:function(){return this._bounds},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"center",{get:function(){return new Vector(this.x+this.width/2,this.y+this.height/2)},enumerable:!1,configurable:!0}),t.prototype.pushSprite=function(t){this.sprites.push(t)},t.prototype.removeSprite=function(t){var e;(e=this.sprites.indexOf(t))>-1&&this.sprites.splice(e,1)},t.prototype.clearSprites=function(){this.sprites.length=0},t}();export{CellImpl};var Cell=function(t){function e(e,i,r,o,s,n,h){return t.call(this,e,i,r,o,s,n,h)||this}return __extends(e,t),e}(Configurable(CellImpl));export{Cell};
var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();import{Class}from"../Class";import{ScrollPreventionMode}from"../Engine";import{Pointer,PointerType}from"./Pointer";import{WheelEvent,NativePointerButton,PointerButton,WheelDeltaMode,createPointerEventByName}from"./PointerEvents";import*as Util from"../Util/Util";import{GlobalCoordinates,Vector}from"../Algebra";import{CapturePointer}from"../Traits/CapturePointer";var ScrollWheelNormalizationFactor=-.025,Pointers=function(e){function t(t){var n=e.call(this)||this;return n._pointerDown=[],n._pointerUp=[],n._pointerMove=[],n._pointerCancel=[],n._wheel=[],n._pointers=[],n._activePointers=[],n._engine=t,n._pointers.push(new Pointer),n._activePointers=[-1],n.primary=n._pointers[0],n}return __extends(t,e),t.prototype.on=function(t,n){e.prototype.on.call(this,t,n)},t.prototype.init=function(e){(e=e||this._engine.canvas).addEventListener("touchstart",this._handleTouchEvent("down",this._pointerDown)),e.addEventListener("touchend",this._handleTouchEvent("up",this._pointerUp)),e.addEventListener("touchmove",this._handleTouchEvent("move",this._pointerMove)),e.addEventListener("touchcancel",this._handleTouchEvent("cancel",this._pointerCancel)),window.PointerEvent?(this._engine.canvas.style.touchAction="none",e.addEventListener("pointerdown",this._handlePointerEvent("down",this._pointerDown)),e.addEventListener("pointerup",this._handlePointerEvent("up",this._pointerUp)),e.addEventListener("pointermove",this._handlePointerEvent("move",this._pointerMove)),e.addEventListener("pointercancel",this._handlePointerEvent("cancel",this._pointerCancel))):window.MSPointerEvent?(this._engine.canvas.style.msTouchAction="none",e.addEventListener("MSPointerDown",this._handlePointerEvent("down",this._pointerDown)),e.addEventListener("MSPointerUp",this._handlePointerEvent("up",this._pointerUp)),e.addEventListener("MSPointerMove",this._handlePointerEvent("move",this._pointerMove)),e.addEventListener("MSPointerCancel",this._handlePointerEvent("cancel",this._pointerCancel))):(e.addEventListener("mousedown",this._handleMouseEvent("down",this._pointerDown)),e.addEventListener("mouseup",this._handleMouseEvent("up",this._pointerUp)),e.addEventListener("mousemove",this._handleMouseEvent("move",this._pointerMove)));var t={passive:!(this._engine.pageScrollPreventionMode===ScrollPreventionMode.All||this._engine.pageScrollPreventionMode===ScrollPreventionMode.Canvas)};"onwheel"in document.createElement("div")?e.addEventListener("wheel",this._handleWheelEvent("wheel",this._wheel),t):void 0!==document.onmousewheel?e.addEventListener("mousewheel",this._handleWheelEvent("wheel",this._wheel),t):e.addEventListener("MozMousePixelScroll",this._handleWheelEvent("wheel",this._wheel),t)},t.prototype.triggerEvent=function(e,t,n,o,i){void 0===n&&(n=NativePointerButton.Left),void 0===o&&(o="mouse"),void 0===i&&(i=0);var r,a=0,s=0;t instanceof GlobalCoordinates?(a=t.pagePos.x,s=t.pagePos.y,r=t):(a=t.x,s=t.y,r=new GlobalCoordinates(t.clone(),t.clone(),t.clone()));var h={pageX:a,pageY:s,pointerId:i,pointerType:o,button:n,preventDefault:function(){}};switch(e){case"move":this._handlePointerEvent(e,this._pointerMove,r)(h);break;case"down":this._handlePointerEvent(e,this._pointerDown,r)(h);break;case"up":this._handlePointerEvent(e,this._pointerUp,r)(h);break;case"cancel":this._handlePointerEvent(e,this._pointerCancel,r)(h)}for(var p=0,l=this._engine.currentScene.actors;p<l.length;p++){var c=l[p],v=c.traits.filter(function(e){return e instanceof CapturePointer})[0];v&&v.update(c,this._engine,1)}this.dispatchPointerEvents(),this.update()},t.prototype.update=function(){this._pointerUp.length=0,this._pointerDown.length=0,this._pointerMove.length=0,this._pointerCancel.length=0,this._wheel.length=0;for(var e=0;e<this._pointers.length;e++)this._pointers[e].update()},t.prototype.at=function(e){if(e>=this._pointers.length)for(var t=this._pointers.length-1,n=e;t<n;t++)this._pointers.push(new Pointer),this._activePointers.push(-1);return this._pointers[e]},t.prototype.count=function(){return this._pointers.length},t.prototype.checkAndUpdateActorUnderPointer=function(e){for(var t=0,n=this._pointers;t<n.length;t++){var o=n[t];o.checkActorUnderPointer(e)?o.addActorUnderPointer(e):o.removeActorUnderPointer(e)}},t.prototype._dispatchWithBubble=function(e){for(var t=0,n=e;t<n.length;t++)for(var o=n[t],i=0,r=o.pointer.getActorsForEvents();i<r.length;i++){var a=r[i];if(o.propagate(a),!o.bubbles)break}},t.prototype._dispatchPointerLeaveEvents=function(){for(var e={},t=[],n=0,o=this._pointerMove;n<o.length;n++)for(var i=o[n],r=0,a=i.pointer.getActorsForEvents();r<a.length;r++){var s=a[r];if(!e[i.pointer.id+"+"+s.id]&&i.pointer.wasActorUnderPointer(s)&&!i.pointer.isActorAliveUnderPointer(s)){e[i.pointer.id+"+"+s.id]=i;var h=createPointerEventByName("leave",new GlobalCoordinates(i.worldPos,i.pagePos,i.screenPos),i.pointer,i.index,i.pointerType,i.button,i.ev);h.propagate(s),t.push(h)}}return t},t.prototype._dispatchPointerEnterEvents=function(){for(var e={},t=[],n=0,o=this._pointerMove;n<o.length;n++)for(var i=o[n],r=0,a=i.pointer.getActorsForEvents();r<a.length;r++){var s=a[r];if(!e[i.pointer.id]&&!i.pointer.wasActorUnderPointer(s)&&i.pointer.isActorAliveUnderPointer(s)){e[i.pointer.id]=i;var h=createPointerEventByName("enter",new GlobalCoordinates(i.worldPos,i.pagePos,i.screenPos),i.pointer,i.index,i.pointerType,i.button,i.ev);h.propagate(s),t.push(h),i.pointer.isDragging&&(i.pointer.dragTarget=s)}}return t},t.prototype.dispatchPointerEvents=function(){this._dispatchWithBubble(this._pointerDown),this._dispatchWithBubble(this._pointerUp),this._dispatchWithBubble(this._pointerMove),this._dispatchPointerLeaveEvents(),this._dispatchPointerEnterEvents(),this._dispatchWithBubble(this._pointerCancel);for(var e=0,t=this._wheel;e<t.length;e++)for(var n=t[e],o=0,i=this._pointers[n.index].getActorsUnderPointer();o<i.length;o++){var r=i[o];if(this._propagateWheelPointerEvent(r,n),!n.bubbles)break}},t.prototype._propagateWheelPointerEvent=function(e,t){e.emit("pointerwheel",t),t.bubbles&&e.parent&&this._propagateWheelPointerEvent(e.parent,t)},t.prototype._handleMouseEvent=function(e,t){var n=this;return function(o){o.preventDefault();var i=n.at(0),r=GlobalCoordinates.fromPagePosition(o.pageX,o.pageY,n._engine),a=createPointerEventByName(e,r,i,0,PointerType.Mouse,n._nativeButtonToPointerButton(o.button),o);t.push(a),i.eventDispatcher.emit(e,a)}},t.prototype._handleTouchEvent=function(e,t){var n=this;return function(o){o.preventDefault();for(var i=0,r=o.changedTouches.length;i<r;i++){var a=n._pointers.length>1?n._getPointerIndex(o.changedTouches[i].identifier):0;if(-1!==a){var s=n.at(a),h=GlobalCoordinates.fromPagePosition(o.changedTouches[i].pageX,o.changedTouches[i].pageY,n._engine),p=createPointerEventByName(e,h,s,a,PointerType.Touch,PointerButton.Unknown,o);t.push(p),s.eventDispatcher.emit(e,p),n._pointers.length>1&&("up"===e?n._activePointers[a]=-1:"down"===e&&(n._activePointers[a]=o.changedTouches[i].identifier))}}}},t.prototype._handlePointerEvent=function(e,t,n){var o=this;return function(i){i.preventDefault();var r=o._pointers.length>1?o._getPointerIndex(i.pointerId):0;if(-1!==r){var a=o.at(r),s=n||GlobalCoordinates.fromPagePosition(i.pageX,i.pageY,o._engine),h=createPointerEventByName(e,s,a,r,o._stringToPointerType(i.pointerType),o._nativeButtonToPointerButton(i.button),i);t.push(h),a.eventDispatcher.emit(e,h),o._pointers.length>1&&("up"===e?o._activePointers[r]=-1:"down"===e&&(o._activePointers[r]=i.pointerId))}}},t.prototype._handleWheelEvent=function(e,t){var n=this;return function(o){(n._engine.pageScrollPreventionMode===ScrollPreventionMode.All||n._engine.pageScrollPreventionMode===ScrollPreventionMode.Canvas&&o.target===n._engine.canvas)&&o.preventDefault();var i=o.pageX-Util.getPosition(n._engine.canvas).x,r=o.pageY-Util.getPosition(n._engine.canvas).y,a=n._engine.screenToWorldCoordinates(new Vector(i,r)),s=o.deltaX||o.wheelDeltaX*ScrollWheelNormalizationFactor||0,h=o.deltaY||o.wheelDeltaY*ScrollWheelNormalizationFactor||o.wheelDelta*ScrollWheelNormalizationFactor||o.detail||0,p=o.deltaZ||0,l=WheelDeltaMode.Pixel;o.deltaMode&&(1===o.deltaMode?l=WheelDeltaMode.Line:2===o.deltaMode&&(l=WheelDeltaMode.Page));var c=new WheelEvent(a.x,a.y,o.pageX,o.pageY,i,r,0,s,h,p,l,o);t.push(c),n.at(0).eventDispatcher.emit(e,c)}},t.prototype._getPointerIndex=function(e){var t;if((t=this._activePointers.indexOf(e))>-1)return t;for(var n=0;n<this._activePointers.length;n++)if(-1===this._activePointers[n])return n;return-1},t.prototype._nativeButtonToPointerButton=function(e){switch(e){case NativePointerButton.NoButton:return PointerButton.NoButton;case NativePointerButton.Left:return PointerButton.Left;case NativePointerButton.Middle:return PointerButton.Middle;case NativePointerButton.Right:return PointerButton.Right;case NativePointerButton.Unknown:return PointerButton.Unknown;default:return Util.fail(e)}},t.prototype._stringToPointerType=function(e){switch(e){case"touch":return PointerType.Touch;case"mouse":return PointerType.Mouse;case"pen":return PointerType.Pen;default:return PointerType.Unknown}},t}(Class);export{Pointers};
var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();import{Resource}from"./Resource";import{Promise}from"../Promises";import{Texture}from"./Texture";import{Color}from"../Drawing/Color";import{SpriteSheet}from"../Drawing/SpriteSheet";var Gif=function(e){function t(t,r,n){void 0===r&&(r=Color.Magenta),void 0===n&&(n=!0);var a=e.call(this,t,"arraybuffer",n)||this;return a.path=t,a.color=r,a.bustCache=n,a.loaded=new Promise,a._isLoaded=!1,a._stream=null,a._gif=null,a._texture=[],a._animation=null,a._transparentColor=null,a._transparentColor=r,a}return __extends(t,e),t.prototype.isLoaded=function(){return this._isLoaded},t.prototype.load=function(){var t=this,r=new Promise;return e.prototype.load.call(this).then(function(){t._stream=new Stream(t.getData()),t._gif=new ParseGif(t._stream,t._transparentColor);for(var e=[],n=0;n<t._gif.images.length;n++){var a=new Texture(t._gif.images[n].src,!1);t._texture.push(a),e.push(a.load())}Promise.join(e).then(function(){t._isLoaded=!0,r.resolve(t._texture)})},function(){r.reject("Error loading texture.")}),r},t.prototype.asSprite=function(e){return void 0===e&&(e=0),this._texture[e].asSprite()},t.prototype.asSpriteSheet=function(){var e=this._texture.map(function(e){return e.asSprite()});return new SpriteSheet(e)},t.prototype.asAnimation=function(e,t){var r=this.asSpriteSheet();return this._animation=r.getAnimationForAll(e,t),this._animation},Object.defineProperty(t.prototype,"readCheckBytes",{get:function(){return this._gif.checkBytes},enumerable:!1,configurable:!0}),t}(Resource);export{Gif};var bitsToNum=function(e){return e.reduce(function(e,t){return 2*e+t},0)},byteToBitArr=function(e){for(var t=[],r=7;r>=0;r--)t.push(!!(e&1<<r));return t},Stream=function(){return function(e){var t=this;if(this.data=null,this.len=0,this.position=0,this.readByte=function(){if(t.position>=t.data.byteLength)throw new Error("Attempted to read past end of stream.");return t.data[t.position++]},this.readBytes=function(e){for(var r=[],n=0;n<e;n++)r.push(t.readByte());return r},this.read=function(e){for(var r="",n=0;n<e;n++)r+=String.fromCharCode(t.readByte());return r},this.readUnsigned=function(){var e=t.readBytes(2);return(e[1]<<8)+e[0]},this.data=new Uint8Array(e),this.len=this.data.byteLength,0===this.len)throw new Error("No data loaded from file")}}();export{Stream};var lzwDecode=function(e,t){for(var r,n,a=0,o=function(e){for(var r=0,n=0;n<e;n++)t.charCodeAt(a>>3)&1<<(7&a)&&(r|=1<<n),a++;return r},i=[],s=1<<e,l=s+1,h=e+1,c=[],d=function(){c=[],h=e+1;for(var t=0;t<s;t++)c[t]=[t];c[s]=[],c[l]=null};;)if(n=r,(r=o(h))!==s){if(r===l)break;if(r<c.length)n!==s&&c.push(c[n].concat(c[r][0]));else{if(r!==c.length)throw new Error("Invalid LZW code.");c.push(c[n].concat(c[n][0]))}i.push.apply(i,c[r]),c.length===1<<h&&h<12&&h++}else d();return i},ParseGif=function(){return function(e,t){var r=this;void 0===t&&(t=Color.Magenta),this._st=null,this._handler={},this._transparentColor=null,this.frames=[],this.images=[],this.globalColorTable=[],this.checkBytes=[],this.parseColorTable=function(e){for(var t=[],n=0;n<e;n++){var a="#"+r._st.readBytes(3).map(function(e){var t=e.toString(16);return 1===t.length?"0"+t:t}).join("");t.push(a)}return t},this.readSubBlocks=function(){var e,t;t="";do{e=r._st.readByte(),t+=r._st.read(e)}while(0!==e);return t},this.parseHeader=function(){var e={sig:null,ver:null,width:null,height:null,colorRes:null,globalColorTableSize:null,gctFlag:null,sorted:null,globalColorTable:[],bgColor:null,pixelAspectRatio:null};if(e.sig=r._st.read(3),e.ver=r._st.read(3),"GIF"!==e.sig)throw new Error("Not a GIF file.");e.width=r._st.readUnsigned(),e.height=r._st.readUnsigned();var t=byteToBitArr(r._st.readByte());e.gctFlag=t.shift(),e.colorRes=bitsToNum(t.splice(0,3)),e.sorted=t.shift(),e.globalColorTableSize=bitsToNum(t.splice(0,3)),e.bgColor=r._st.readByte(),e.pixelAspectRatio=r._st.readByte(),e.gctFlag&&(e.globalColorTable=r.parseColorTable(1<<e.globalColorTableSize+1),r.globalColorTable=e.globalColorTable),r._handler.hdr&&r._handler.hdr(e)&&r.checkBytes.push(r._handler.hdr)},this.parseExt=function(e){switch(e.label=r._st.readByte(),e.label){case 249:e.extType="gce",function(e){r.checkBytes.push(r._st.readByte());var t=byteToBitArr(r._st.readByte());e.reserved=t.splice(0,3),e.disposalMethod=bitsToNum(t.splice(0,3)),e.userInput=t.shift(),e.transparencyGiven=t.shift(),e.delayTime=r._st.readUnsigned(),e.transparencyIndex=r._st.readByte(),e.terminator=r._st.readByte(),r._handler.gce&&r._handler.gce(e)&&r.checkBytes.push(r._handler.gce)}(e);break;case 254:e.extType="com",function(e){e.comment=r.readSubBlocks(),r._handler.com&&r._handler.com(e)&&r.checkBytes.push(r._handler.com)}(e);break;case 1:e.extType="pte",function(e){r.checkBytes.push(r._st.readByte()),e.ptHeader=r._st.readBytes(12),e.ptData=r.readSubBlocks(),r._handler.pte&&r._handler.pte(e)&&r.checkBytes.push(r._handler.pte)}(e);break;case 255:e.extType="app",function(e){switch(r.checkBytes.push(r._st.readByte()),e.identifier=r._st.read(8),e.authCode=r._st.read(3),e.identifier){case"NETSCAPE":!function(e){r.checkBytes.push(r._st.readByte()),e.unknown=r._st.readByte(),e.iterations=r._st.readUnsigned(),e.terminator=r._st.readByte(),r._handler.app&&r._handler.app.NETSCAPE&&r._handler.app.NETSCAPE(e)&&r.checkBytes.push(r._handler.app)}(e);break;default:!function(e){e.appData=r.readSubBlocks(),r._handler.app&&r._handler.app[e.identifier]&&r._handler.app[e.identifier](e)&&r.checkBytes.push(r._handler.app[e.identifier])}(e)}}(e);break;default:e.extType="unknown",function(e){e.data=r.readSubBlocks(),r._handler.unknown&&r._handler.unknown(e)&&r.checkBytes.push(r._handler.unknown)}(e)}},this.parseImg=function(e){e.leftPos=r._st.readUnsigned(),e.topPos=r._st.readUnsigned(),e.width=r._st.readUnsigned(),e.height=r._st.readUnsigned();var t=byteToBitArr(r._st.readByte());e.lctFlag=t.shift(),e.interlaced=t.shift(),e.sorted=t.shift(),e.reserved=t.splice(0,2),e.lctSize=bitsToNum(t.splice(0,3)),e.lctFlag&&(e.lct=r.parseColorTable(1<<e.lctSize+1)),e.lzwMinCodeSize=r._st.readByte();var n=r.readSubBlocks();e.pixels=lzwDecode(e.lzwMinCodeSize,n),e.interlaced&&(e.pixels=function(e,t){for(var r=new Array(e.length),n=e.length/t,a=function(n,a){var o=e.slice(a*t,(a+1)*t);r.splice.apply(r,[n*t,t].concat(o))},o=[0,4,2,1],i=[8,8,4,2],s=0,l=0;l<4;l++)for(var h=o[l];h<n;h+=i[l])a(h,s),s++;return r}(e.pixels,e.width)),r.frames.push(e),r.arrayToImage(e),r._handler.img&&r._handler.img(e)&&r.checkBytes.push(r._handler)},this.parseBlock=function(){var e={sentinel:r._st.readByte(),type:""};switch(String.fromCharCode(e.sentinel)){case"!":e.type="ext",r.parseExt(e);break;case",":e.type="img",r.parseImg(e);break;case";":e.type="eof",r._handler.eof&&r._handler.eof(e)&&r.checkBytes.push(r._handler.eof);break;default:throw new Error("Unknown block: 0x"+e.sentinel.toString(16))}"eof"!==e.type&&r.parseBlock()},this.arrayToImage=function(e){var t=0,n=document.createElement("canvas");n.id=t.toString(),n.width=e.width,n.height=e.height,t++;for(var a=n.getContext("2d"),o=0,i=0,s=0;s<e.pixels.length;s++)i%e.width==0&&(o++,i=0),r.globalColorTable[e.pixels[s]]===r._transparentColor.toHex()?a.fillStyle="rgba(0, 0, 0, 0)":a.fillStyle=r.globalColorTable[e.pixels[s]],a.fillRect(i,o,1,1),i++;var l=new Image;l.src=n.toDataURL(),r.images.push(l)},this._st=e,this._handler={},this._transparentColor=t,this.parseHeader(),this.parseBlock()}}();export{ParseGif};
var __extends=this&&this.__extends||function(){var t=function(i,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])})(i,e)};return function(i,e){function r(){this.constructor=i}t(i,e),i.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var i,e=1,r=arguments.length;e<r;e++)for(var h in i=arguments[e])Object.prototype.hasOwnProperty.call(i,h)&&(t[h]=i[h]);return t}).apply(this,arguments)};import*as Effects from"./SpriteEffects";import{Color}from"./Color";import{Texture}from"../Resources/Texture";import{Vector}from"../Algebra";import{Logger}from"../Util/Log";import{clamp,nullish}from"../Util/Util";import{Configurable}from"../Configurable";var SpriteImpl=function(){function t(t,i,e,r,h){var s=this;this.x=0,this.y=0,this.rotation=0,this.anchor=new Vector(0,0),this.offset=Vector.Zero,this.scale=Vector.One,this.logger=Logger.getInstance(),this.flipVertical=!1,this.flipHorizontal=!1,this.effects=[],this.width=0,this.height=0,this._spriteCanvas=null,this._spriteCtx=null,this._pixelData=null,this._pixelsLoaded=!1,this._dirtyEffect=!1,this._opacity=1;var a=t;if(t&&!(t instanceof Texture)&&(i=0|t.x,e=0|t.y,r=0|t.width,h=0|t.height,!(a=t.image))){throw new Error("An image texture is required to contsruct a sprite")}this.x=i||0,this.y=e||0,this._texture=a,this._spriteCanvas=document.createElement("canvas"),this._spriteCanvas.width=r,this._spriteCanvas.height=h,this._spriteCtx=this._spriteCanvas.getContext("2d"),this._texture.loaded.then(function(){s.width=s.width||s._texture.image.naturalWidth,s.height=s.height||s._texture.image.naturalHeight,s._spriteCanvas.width=s._spriteCanvas.width||s._texture.image.naturalWidth,s._spriteCanvas.height=s._spriteCanvas.height||s._texture.image.naturalHeight,s._loadPixels(),s._dirtyEffect=!0}).error(function(t){s.logger.error("Error loading texture ",s._texture.path,t)}),this.width=r,this.height=h}return Object.defineProperty(t.prototype,"drawWidth",{get:function(){return this.width*this.scale.x},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"drawHeight",{get:function(){return this.height*this.scale.y},enumerable:!1,configurable:!0}),t.prototype._loadPixels=function(){if(this._texture.isLoaded()&&!this._pixelsLoaded){var t=this._texture.image.naturalWidth||0,i=this._texture.image.naturalHeight||0;if(this.width>t&&this.logger.warn("The sprite width "+this.width+" exceeds the width \n                              "+t+" of the backing texture "+this._texture.path),this.width<=0||t<=0)throw new Error("The width of a sprite cannot be 0 or negative, sprite width: "+this.width+", original width: "+t);if(this.height>i&&this.logger.warn("The sprite height "+this.height+" exceeds the height \n                              "+i+" of the backing texture "+this._texture.path),this.height<=0||i<=0)throw new Error("The height of a sprite cannot be 0 or negative, sprite height: "+this.height+", original height: "+i);this._spriteCtx.drawImage(this._texture.image,clamp(this.x,0,t),clamp(this.y,0,i),clamp(this.width,0,t),clamp(this.height,0,i),0,0,this.width,this.height),this._pixelsLoaded=!0}},t.prototype.opacity=function(t){this._opacity=t},t.prototype.grayscale=function(){this.addEffect(new Effects.Grayscale)},t.prototype.invert=function(){this.addEffect(new Effects.Invert)},t.prototype.fill=function(t){this.addEffect(new Effects.Fill(t))},t.prototype.colorize=function(t){this.addEffect(new Effects.Colorize(t))},t.prototype.lighten=function(t){void 0===t&&(t=.1),this.addEffect(new Effects.Lighten(t))},t.prototype.darken=function(t){void 0===t&&(t=.1),this.addEffect(new Effects.Darken(t))},t.prototype.saturate=function(t){void 0===t&&(t=.1),this.addEffect(new Effects.Saturate(t))},t.prototype.desaturate=function(t){void 0===t&&(t=.1),this.addEffect(new Effects.Desaturate(t))},t.prototype.addEffect=function(t){this.effects.push(t),this._texture.isLoaded()&&this._pixelsLoaded?this._applyEffects():this._dirtyEffect=!0},t.prototype.removeEffect=function(t){var i=-1;(i="number"==typeof t?t:this.effects.indexOf(t))<0||i>=this.effects.length||(this.effects.splice(i,1),this._texture.isLoaded()&&this._pixelsLoaded?this._applyEffects():this._dirtyEffect=!0)},t.prototype._applyEffects=function(){var t=this._texture.image.naturalWidth||0,i=this._texture.image.naturalHeight||0;this._spriteCtx.clearRect(0,0,this.width,this.height),this._spriteCtx.drawImage(this._texture.image,clamp(this.x,0,t),clamp(this.y,0,i),clamp(this.width,0,t),clamp(this.height,0,i),0,0,this.width,this.height),this._pixelData=this._spriteCtx.getImageData(0,0,this.width,this.height);for(var e=this.effects.length,r=0;r<e;r++)for(var h=0;h<this.height;h++)for(var s=0;s<this.width;s++)this.effects[r].updatePixel(s,h,this._pixelData);this._spriteCtx.clearRect(0,0,this.width,this.height),this._spriteCtx.putImageData(this._pixelData,0,0),this._dirtyEffect=!1},t.prototype.clearEffects=function(){this.effects.length=0,this._applyEffects()},t.prototype.reset=function(){},t.prototype.debugDraw=function(t,i,e){t.save(),t.translate(i,e),t.rotate(this.rotation);var r=this.drawWidth*this.anchor.x,h=this.drawHeight*this.anchor.y;t.strokeStyle=Color.Black.toString(),t.strokeRect(-r,-h,this.drawWidth,this.drawHeight),t.restore()},t.prototype.draw=function(t,i,e){t instanceof CanvasRenderingContext2D?this._drawWithOptions({ctx:t,x:i,y:e}):this._drawWithOptions(t)},t.prototype._drawWithOptions=function(t){var i=__assign(__assign({},t),{rotation:nullish(t.rotation,this.rotation),drawWidth:nullish(t.drawWidth,this.drawWidth),drawHeight:nullish(t.drawHeight,this.drawHeight),flipHorizontal:nullish(t.flipHorizontal,this.flipHorizontal),flipVertical:nullish(t.flipVertical,this.flipVertical),anchor:nullish(t.anchor,this.anchor),offset:nullish(t.offset,this.offset),opacity:nullish(t.opacity,this._opacity)}),e=i.ctx,r=i.x,h=i.y,s=i.rotation,a=i.drawWidth,o=i.drawHeight,n=i.anchor,f=i.offset,p=i.opacity,l=i.flipHorizontal,c=i.flipVertical;this._dirtyEffect&&this._applyEffects(),e.save();var d=a*n.x+f.x,u=o*n.y+f.y;e.translate(r,h),e.rotate(s),l&&(e.translate(a,0),e.scale(-1,1)),c&&(e.translate(0,o),e.scale(1,-1)),this._dirtyEffect&&this._applyEffects();var g=e.globalAlpha;e.globalAlpha=nullish(p,1),e.drawImage(this._spriteCanvas,0,0,this.width,this.height,-d,-u,a,o),e.globalAlpha=g,e.restore()},t.prototype.clone=function(){var t=new Sprite(this._texture,this.x,this.y,this.width,this.height);t.scale=this.scale.clone(),t.rotation=this.rotation,t.flipHorizontal=this.flipHorizontal,t.flipVertical=this.flipVertical;for(var i=this.effects.length,e=0;e<i;e++)t.addEffect(this.effects[e]);return t},t}();export{SpriteImpl};var Sprite=function(t){function i(i,e,r,h,s){return t.call(this,i,e,r,h,s)||this}return __extends(i,t),i}(Configurable(SpriteImpl));export{Sprite};
var __extends=this&&this.__extends||function(){var t=function(i,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])})(i,e)};return function(i,e){function o(){this.constructor=i}t(i,e),i.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}();import{Actor}from"./Actor";import{Color}from"./Drawing/Color";import{Vector}from"./Algebra";import*as Util from"./Util/Util";import*as DrawUtil from"./Util/DrawUtil";import*as Traits from"./Traits/Index";import{Configurable}from"./Configurable";import{Random}from"./Math/Random";import{CollisionType}from"./Collision/CollisionType";export var EmitterType;!function(t){t[t.Circle=0]="Circle",t[t.Rectangle=1]="Rectangle"}(EmitterType||(EmitterType={}));var ParticleImpl=function(){function t(t,i,e,o,r,s,l,a,n,h){this.position=new Vector(0,0),this.velocity=new Vector(0,0),this.acceleration=new Vector(0,0),this.particleRotationalVelocity=0,this.currentRotation=0,this.focus=null,this.focusAccel=0,this.opacity=1,this.beginColor=Color.White,this.endColor=Color.White,this.life=300,this.fadeFlag=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=Color.White,this.emitter=null,this.particleSize=5,this.particleSprite=null,this.sizeRate=0,this.elapsedMultiplier=0;var c=t;if(c&&!(t instanceof ParticleEmitter)){var p=t;c=p.emitter,i=p.life,e=p.opacity,r=p.endColor,o=p.beginColor,s=p.position,l=p.velocity,a=p.acceleration,n=p.startSize,h=p.endSize}this.emitter=c,this.life=i||this.life,this.opacity=e||this.opacity,this.endColor=r||this.endColor.clone(),this.beginColor=o||this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.position=s||this.position,this.velocity=l||this.velocity,this.acceleration=a||this.acceleration,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.opacity/this.life,this.startSize=n||0,this.endSize=h||0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.particleSize=this.startSize)}return t.prototype.kill=function(){this.emitter.removeParticle(this)},t.prototype.update=function(t){if(this.life=this.life-t,this.elapsedMultiplier=this.elapsedMultiplier+t,this.life<0&&this.kill(),this.fadeFlag&&(this.opacity=Util.clamp(this._aRate*this.life,1e-4,1)),this.startSize>0&&this.endSize>0&&(this.particleSize=Util.clamp(this.sizeRate*t+this.particleSize,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=Util.clamp(this._currentColor.r+this._rRate*t,0,255),this._currentColor.g=Util.clamp(this._currentColor.g+this._gRate*t,0,255),this._currentColor.b=Util.clamp(this._currentColor.b+this._bRate*t,0,255),this._currentColor.a=Util.clamp(this.opacity,1e-4,1),this.focus){var i=this.focus.sub(this.position).normalize().scale(this.focusAccel).scale(t/1e3);this.velocity=this.velocity.add(i)}else this.velocity=this.velocity.add(this.acceleration.scale(t/1e3));this.position=this.position.add(this.velocity.scale(t/1e3)),this.particleRotationalVelocity&&(this.currentRotation=(this.currentRotation+this.particleRotationalVelocity*t/1e3)%(2*Math.PI))},t.prototype.draw=function(t){if(this.particleSprite)return this.particleSprite.rotation=this.currentRotation,this.particleSprite.scale.setTo(this.particleSize,this.particleSize),void this.particleSprite.draw(t,this.position.x,this.position.y);this._currentColor.a=Util.clamp(this.opacity,1e-4,1),t.fillStyle=this._currentColor.toString(),t.beginPath(),t.arc(this.position.x,this.position.y,this.particleSize,0,2*Math.PI),t.fill(),t.closePath()},t}();export{ParticleImpl};var Particle=function(t){function i(i,e,o,r,s,l,a,n,h,c){return t.call(this,i,e,o,r,s,l,a,n,h,c)||this}return __extends(i,t),i}(Configurable(ParticleImpl));export{Particle};var ParticleEmitterImpl=function(t){function i(i,e,o,r){var s=t.call(this,"number"==typeof i?{pos:new Vector(i,e),width:o,height:r}:i)||this;s.numParticles=0,s.isEmitting=!0,s.particles=null,s.deadParticles=null,s.minVel=0,s.maxVel=0,s.acceleration=new Vector(0,0),s.minAngle=0,s.maxAngle=0,s.emitRate=1,s.particleLife=2e3,s.opacity=1,s.fadeFlag=!1,s.focus=null,s.focusAccel=1,s.startSize=null,s.endSize=null,s.minSize=5,s.maxSize=5,s.beginColor=Color.White,s.endColor=Color.White,s.particleSprite=null,s.emitterType=EmitterType.Rectangle,s.radius=0,s.particleRotationalVelocity=0,s.randomRotation=!1,s._particlesToEmit=0,s.body.collider.type=CollisionType.PreventCollision,s.particles=new Util.Collection,s.deadParticles=new Util.Collection,s.random=new Random;for(var l=0;l<s.traits.length;l++)s.traits[l]instanceof Traits.OffscreenCulling&&s.traits.splice(l,1);return s}return __extends(i,t),i.prototype.removeParticle=function(t){this.deadParticles.push(t)},i.prototype.emitParticles=function(t){for(var i=0;i<t;i++)this.particles.push(this._createParticle())},i.prototype.clearParticles=function(){this.particles.clear()},i.prototype._createParticle=function(){var t=0,i=0,e=Util.randomInRange(this.minAngle,this.maxAngle,this.random),o=Util.randomInRange(this.minVel,this.maxVel,this.random),r=this.startSize||Util.randomInRange(this.minSize,this.maxSize,this.random),s=o*Math.cos(e),l=o*Math.sin(e);if(this.emitterType===EmitterType.Rectangle)t=Util.randomInRange(this.pos.x,this.pos.x+this.width,this.random),i=Util.randomInRange(this.pos.y,this.pos.y+this.height,this.random);else if(this.emitterType===EmitterType.Circle){var a=Util.randomInRange(0,this.radius,this.random);t=a*Math.cos(e)+this.pos.x,i=a*Math.sin(e)+this.pos.y}var n=new Particle(this,this.particleLife,this.opacity,this.beginColor,this.endColor,new Vector(t,i),new Vector(s,l),this.acceleration,this.startSize,this.endSize);return n.fadeFlag=this.fadeFlag,n.particleSize=r,this.particleSprite&&(n.particleSprite=this.particleSprite),n.particleRotationalVelocity=this.particleRotationalVelocity,this.randomRotation&&(n.currentRotation=Util.randomInRange(0,2*Math.PI,this.random)),this.focus&&(n.focus=this.focus.add(new Vector(this.pos.x,this.pos.y)),n.focusAccel=this.focusAccel),n},i.prototype.update=function(i,e){var o=this;t.prototype.update.call(this,i,e),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(e/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.particles.forEach(function(t){return t.update(e)}),this.deadParticles.forEach(function(t){return o.particles.removeElement(t)}),this.deadParticles.clear()},i.prototype.draw=function(t){this.particles.forEach(function(i){return i.draw(t)})},i.prototype.debugDraw=function(i){t.prototype.debugDraw.call(this,i),i.fillStyle=Color.Black.toString(),i.fillText("Particles: "+this.particles.count(),this.pos.x,this.pos.y+20),this.focus&&(i.fillRect(this.focus.x+this.pos.x,this.focus.y+this.pos.y,3,3),DrawUtil.line(i,Color.Yellow,this.focus.x+this.pos.x,this.focus.y+this.pos.y,this.center.x,this.center.y),i.fillText("Focus",this.focus.x+this.pos.x,this.focus.y+this.pos.y))},i}(Actor);export{ParticleEmitterImpl};var ParticleEmitter=function(t){function i(i,e,o,r){return t.call(this,i,e,o,r)||this}return __extends(i,t),i}(Configurable(ParticleEmitterImpl));export{ParticleEmitter};
import{AudioContextFactory}from"../Resources/Sound/AudioContext";import{Promise,PromiseState}from"../Promises";import{Logger}from"./Log";function isLegacyWebAudioSource(e){return!!e.playbackState}var WebAudio=function(){function e(){}return e.unlock=function(){var t=new Promise;if(e._unlocked||!AudioContextFactory.create())return t.resolve(!0);var o=setTimeout(function(){Logger.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),t.resolve()},200),n=AudioContextFactory.create();return n.resume().then(function(){var r=n.createBuffer(1,1,22050),u=n.createBufferSource(),i=!1;u.buffer=r,u.connect(n.destination),u.onended=function(){return i=!0},u.noteOn?u.noteOn(0):u.start(0),setTimeout(function(){isLegacyWebAudioSource(u)?u.playbackState!==u.PLAYING_STATE&&u.playbackState!==u.FINISHED_STATE||(e._unlocked=!0):(n.currentTime>0||i)&&(e._unlocked=!0)},0),clearTimeout(o),t.state()===PromiseState.Pending&&t.resolve()},function(){t.state()===PromiseState.Pending&&t.reject(!1)}),t},e.isUnlocked=function(){return this._unlocked},e._unlocked=!1,e}();export{WebAudio};
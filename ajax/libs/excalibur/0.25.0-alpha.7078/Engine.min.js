var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};import{EX_VERSION}from"./";import{polyfill}from"./Polyfill";polyfill();import{Promise}from"./Promises";import{Screen,DisplayMode}from"./Screen";import{ScreenElement}from"./ScreenElement";import{Actor}from"./Actor";import{Timer}from"./Timer";import{TileMap}from"./TileMap";import{Loader}from"./Loader";import{Detector}from"./Util/Detector";import{VisibleEvent,HiddenEvent,GameStartEvent,GameStopEvent,PreUpdateEvent,PostUpdateEvent,PreFrameEvent,PostFrameEvent,DeactivateEvent,ActivateEvent,PreDrawEvent,PostDrawEvent,InitializeEvent}from"./Events";import{Logger,LogLevel}from"./Util/Log";import{Color}from"./Drawing/Color";import{Scene}from"./Scene";import{Debug}from"./Debug";import{Class}from"./Class";import*as Input from"./Input/Index";import{BrowserEvents}from"./Util/Browser";export var ScrollPreventionMode;!function(e){e[e.None=0]="None",e[e.Canvas=1]="Canvas",e[e.All=2]="All"}(ScrollPreventionMode||(ScrollPreventionMode={}));var Engine=function(e){function t(n){var i,r,o,s=e.call(this)||this;s._hasStarted=!1,s.postProcessors=[],s.scenes={},s._animations=[],s._suppressPlayButton=!1,s.pauseAudioWhenHidden=!0,s.isDebug=!1,s.debugColor=new Color(255,255,255),s.enableCanvasTransparency=!0,s.onFatalException=function(e){Logger.getInstance().fatal(e)},s._timescale=1,s._isLoading=!1,s._isInitialized=!1,n=__assign(__assign({},t._DefaultEngineOptions),n),s.browser=new BrowserEvents(window,document);var a=new Detector;if(!n.suppressMinimumBrowserFeatureDetection&&!(s._compatible=a.test())){var c=document.createElement("div");if(c.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(c),a.failedTests.forEach(function(e){var t=document.createElement("div");t.innerText="Browser feature missing "+e,document.body.appendChild(t)}),n.canvasElementId){var p=document.getElementById(n.canvasElementId);p&&p.parentElement.removeChild(p)}return s}s._compatible=!0,console.log&&!n.suppressConsoleBootMessage&&(console.log("%cPowered by Excalibur.js (v"+EX_VERSION+")","background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log("\n      /| ________________\nO|===|* >________________>\n      \\|"),console.log("Visit","http://excaliburjs.com","for more information")),n.suppressPlayButton&&(s._suppressPlayButton=!0),s._logger=Logger.getInstance(),s._logger.defaultLevel===LogLevel.Debug&&a.logBrowserFeatures(),s._logger.debug("Building engine..."),s.canvasElementId=n.canvasElementId,n.canvasElementId?(s._logger.debug("Using Canvas element specified: "+n.canvasElementId),s.canvas=document.getElementById(n.canvasElementId)):n.canvasElement?(s._logger.debug("Using Canvas element specified:",n.canvasElement),s.canvas=n.canvasElement):(s._logger.debug("Using generated canvas element"),s.canvas=document.createElement("canvas"));var l=null!==(i=n.displayMode)&&void 0!==i?i:DisplayMode.Fixed;return n.width&&n.height||n.viewport?(void 0===n.displayMode&&(l=DisplayMode.Fixed),s._logger.debug("Engine viewport is size "+n.width+" x "+n.height)):n.displayMode||(s._logger.debug("Engine viewport is fullscreen"),l=DisplayMode.FullScreen),s.ctx=s.canvas.getContext("2d",{alpha:s.enableCanvasTransparency}),s.screen=new Screen({canvas:s.canvas,context:s.ctx,antialiasing:null===(r=n.antialiasing)||void 0===r||r,browser:s.browser,viewport:null!==(o=n.viewport)&&void 0!==o?o:{width:n.width,height:n.height},resolution:n.resolution,displayMode:l,position:n.position,pixelRatio:n.suppressHiDPIScaling?1:null}),s.screen.applyResolutionAndViewport(),n.backgroundColor&&(s.backgroundColor=n.backgroundColor.clone()),s.enableCanvasTransparency=n.enableCanvasTransparency,s._loader=new Loader,s.debug=new Debug(s),s._initialize(n),s.rootScene=s.currentScene=new Scene(s),s.addScene("root",s.rootScene),s.goToScene("root"),s}return __extends(t,e),Object.defineProperty(t.prototype,"canvasWidth",{get:function(){return this.screen.canvasWidth},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"halfCanvasWidth",{get:function(){return this.screen.halfCanvasWidth},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"canvasHeight",{get:function(){return this.screen.canvasHeight},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"halfCanvasHeight",{get:function(){return this.screen.halfCanvasHeight},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"drawWidth",{get:function(){return this.screen.drawWidth},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"halfDrawWidth",{get:function(){return this.screen.halfDrawWidth},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"drawHeight",{get:function(){return this.screen.drawHeight},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"halfDrawHeight",{get:function(){return this.screen.halfDrawHeight},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isHiDpi",{get:function(){return this.screen.isHiDpi},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stats",{get:function(){return this.debug.stats},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isFullscreen",{get:function(){return this.screen.isFullScreen},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"displayMode",{get:function(){return this.screen.displayMode},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"pixelRatio",{get:function(){return this.screen.pixelRatio},enumerable:!1,configurable:!0}),t.prototype.on=function(t,n){e.prototype.on.call(this,t,n)},t.prototype.once=function(t,n){e.prototype.once.call(this,t,n)},t.prototype.off=function(t,n){e.prototype.off.call(this,t,n)},t.prototype.getWorldBounds=function(){return this.screen.getWorldBounds()},Object.defineProperty(t.prototype,"timescale",{get:function(){return this._timescale},set:function(e){e<=0?Logger.getInstance().error("Cannot set engine.timescale to a value of 0 or less than 0."):this._timescale=e},enumerable:!1,configurable:!0}),t.prototype.playAnimation=function(e,t,n){this._animations.push(new AnimationNode(e,t,n))},t.prototype.addTileMap=function(e){this.currentScene.addTileMap(e)},t.prototype.removeTileMap=function(e){this.currentScene.removeTileMap(e)},t.prototype.addTimer=function(e){return this.currentScene.addTimer(e)},t.prototype.removeTimer=function(e){return this.currentScene.removeTimer(e)},t.prototype.addScene=function(e,t){this.scenes[e]&&this._logger.warn("Scene",e,"already exists overwriting"),this.scenes[e]=t},t.prototype.removeScene=function(e){if(e instanceof Scene)for(var t in this.scenes)this.scenes.hasOwnProperty(t)&&this.scenes[t]===e&&delete this.scenes[t];"string"==typeof e&&delete this.scenes[e]},t.prototype.add=function(e){e instanceof ScreenElement?this.currentScene.addScreenElement(e):(e instanceof Actor&&this._addChild(e),e instanceof Timer&&this.addTimer(e),e instanceof TileMap&&this.addTileMap(e),2===arguments.length&&this.addScene(arguments[0],arguments[1]))},t.prototype.remove=function(e){e instanceof ScreenElement?this.currentScene.removeScreenElement(e):(e instanceof Actor&&this._removeChild(e),e instanceof Timer&&this.removeTimer(e),e instanceof TileMap&&this.removeTileMap(e),e instanceof Scene&&this.removeScene(e),"string"==typeof e&&this.removeScene(e))},t.prototype._addChild=function(e){this.currentScene.add(e)},t.prototype._removeChild=function(e){this.currentScene.remove(e)},t.prototype.goToScene=function(e){if(this.scenes[e]){var t=this.currentScene,n=this.scenes[e];this._logger.debug("Going to scene:",e),this.currentScene.isInitialized&&(this.currentScene._deactivate.call(this.currentScene,[t,n]),this.currentScene.eventDispatcher.emit("deactivate",new DeactivateEvent(n,this.currentScene))),this.currentScene=n,this.screen.setCurrentCamera(n.camera),this.currentScene._initialize(this),this.currentScene._activate.call(this.currentScene,[t,n]),this.currentScene.eventDispatcher.emit("activate",new ActivateEvent(t,this.currentScene))}else this._logger.error("Scene",e,"does not exist!")},t.prototype.screenToWorldCoordinates=function(e){return this.screen.screenToWorldCoordinates(e)},t.prototype.worldToScreenCoordinates=function(e){return this.screen.worldToScreenCoordinates(e)},t.prototype._initialize=function(e){var t,n,i=this;this.pageScrollPreventionMode=e.scrollPreventionMode,this.input={keyboard:new Input.Keyboard,pointers:new Input.Pointers(this),gamepads:new Input.Gamepads},this.input.keyboard.init(),this.input.pointers.init(e&&e.pointerScope===Input.PointerScope.Document?document:this.canvas),this.input.gamepads.init(),void 0!==document.hidden?(t="hidden",n="visibilitychange"):"msHidden"in document?(t="msHidden",n="msvisibilitychange"):"webkitHidden"in document&&(t="webkitHidden",n="webkitvisibilitychange"),this.browser.document.on(n,function(){document[t]?(i.eventDispatcher.emit("hidden",new HiddenEvent(i)),i._logger.debug("Window hidden")):(i.eventDispatcher.emit("visible",new VisibleEvent(i)),i._logger.debug("Window visible"))}),this.canvasElementId||e.canvasElement||document.body.appendChild(this.canvas)},t.prototype.onInitialize=function(e){},t.prototype.setAntialiasing=function(e){this.screen.antialiasing=e},t.prototype.getAntialiasing=function(){return this.screen.antialiasing},Object.defineProperty(t.prototype,"isInitialized",{get:function(){return this._isInitialized},enumerable:!1,configurable:!0}),t.prototype._overrideInitialize=function(t){this.isInitialized||(this.onInitialize(t),e.prototype.emit.call(this,"initialize",new InitializeEvent(t,this)),this._isInitialized=!0)},t.prototype._update=function(e){if(this._isLoading)return this._loader.update(this,e),this.input.keyboard.update(),this.input.pointers.update(),void this.input.gamepads.update();this._overrideInitialize(this),this._preupdate(e),this.currentScene.update(this,e),this._animations=this._animations.filter(function(e){return!e.animation.isDone()}),this.input.keyboard.update(),this.input.pointers.update(),this.input.gamepads.update(),this._postupdate(e)},t.prototype._preupdate=function(e){this.emit("preupdate",new PreUpdateEvent(this,e,this)),this.onPreUpdate(this,e)},t.prototype.onPreUpdate=function(e,t){},t.prototype._postupdate=function(e){this.emit("postupdate",new PostUpdateEvent(this,e,this)),this.onPostUpdate(this,e)},t.prototype.onPostUpdate=function(e,t){},t.prototype._draw=function(e){var t=this.ctx;if(this._predraw(t,e),this._isLoading)this._loader.draw(t,e);else{t.clearRect(0,0,this.canvasWidth,this.canvasHeight),t.fillStyle=this.backgroundColor.toString(),t.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.currentScene.draw(this.ctx,e);for(var n=0,i=this._animations.length;n<i;n++)this._animations[n].animation.draw(t,this._animations[n].x,this._animations[n].y);if(this.isDebug){this.ctx.font="Consolas",this.ctx.fillStyle=this.debugColor.toString();for(var r=this.input.keyboard.getKeys(),o=0;o<r.length;o++)this.ctx.fillText(r[o].toString()+" : "+(Input.Keys[r[o]]?Input.Keys[r[o]]:"Not Mapped"),100,10*o+10);this.ctx.fillText("FPS:"+this.stats.currFrame.fps.toFixed(2).toString(),10,10)}for(var s=0;s<this.postProcessors.length;s++)this.postProcessors[s].process(this.ctx.getImageData(0,0,this.canvasWidth,this.canvasHeight),this.ctx);this._postdraw(t,e)}},t.prototype._predraw=function(e,t){this.emit("predraw",new PreDrawEvent(e,t,this)),this.onPreDraw(e,t)},t.prototype.onPreDraw=function(e,t){},t.prototype._postdraw=function(e,t){this.emit("postdraw",new PostDrawEvent(e,t,this)),this.onPostDraw(e,t)},t.prototype.onPostDraw=function(e,t){},t.prototype.start=function(e){var n,i=this;return this._compatible?(this.screen.pushResolutionAndViewport(),this.screen.resolution=this.screen.viewport,this.screen.applyResolutionAndViewport(),e?(this._loader=e,this._loader.suppressPlayButton=this._suppressPlayButton||this._loader.suppressPlayButton,this._loader.wireEngine(this),n=this.load(this._loader)):n=Promise.resolve(),n.then(function(){i.screen.popResolutionAndViewport(),i.screen.applyResolutionAndViewport(),i.emit("start",new GameStartEvent(i))}),this._hasStarted||(this._hasStarted=!0,this._logger.debug("Starting game..."),this.browser.resume(),t.createMainLoop(this,window.requestAnimationFrame,Date.now)(),this._logger.debug("Game started")),n):(new Promise).reject("Excalibur is incompatible with your browser")},t.createMainLoop=function(e,t,n){var i=n();return function r(){if(e._hasStarted)try{e._requestId=t(r),e.emit("preframe",new PreFrameEvent(e,e.stats.prevFrame));var o=n(),s=Math.floor(o-i)||1;s>200&&(s=1);var a=s*e.timescale,c=e.stats.prevFrame.id+1;e.stats.prevFrame.reset(e.stats.currFrame),e.stats.currFrame.reset(),e.stats.currFrame.id=c,e.stats.currFrame.delta=a,e.stats.currFrame.fps=1/(a/1e3);var p=n();e._update(a);var l=n();e._draw(a);var u=n();e.stats.currFrame.duration.update=l-p,e.stats.currFrame.duration.draw=u-l,i=o,e.emit("postframe",new PostFrameEvent(e,e.stats.currFrame))}catch(t){window.cancelAnimationFrame(e._requestId),e.stop(),e.onFatalException(t)}}},t.prototype.stop=function(){this._hasStarted&&(this.emit("stop",new GameStopEvent(this)),this.browser.pause(),this._hasStarted=!1,this._logger.debug("Game stopped"))},t.prototype.isPaused=function(){return!this._hasStarted},t.prototype.screenshot=function(){var e=new Image,t=this.canvas.toDataURL("image/png");return e.src=t,e},t.prototype.load=function(e){var t=this,n=new Promise;return this._isLoading=!0,e.load().then(function(){t._suppressPlayButton?setTimeout(function(){t._isLoading=!1,n.resolve()},500):(t._isLoading=!1,n.resolve())}),n},t._DefaultEngineOptions={width:0,height:0,enableCanvasTransparency:!0,canvasElementId:"",canvasElement:void 0,pointerScope:Input.PointerScope.Document,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,scrollPreventionMode:ScrollPreventionMode.Canvas,backgroundColor:Color.fromHex("#2185d0")},t}(Class);export{Engine};var AnimationNode=function(){return function(e,t,n){this.animation=e,this.x=t,this.y=n}}();